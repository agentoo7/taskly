# Story 3.7: Branch & PR Cleanup

## Status
Draft

---

## Story

**As a** workspace admin,
**I want** automated cleanup of merged branches and closed PRs,
**so that** my repository stays organized without manual maintenance.

---

## Acceptance Criteria

1. Board settings include "Auto-delete merged branches" toggle (default: off)
2. When PR merged and auto-delete enabled, branch automatically deleted from GitHub via API
3. Branch deletion adds activity entry: "deleted branch [branch-name] (PR #123 merged)"
4. Deleted branches preserved in card metadata for historical record
5. Card shows "Branch deleted" badge if branch no longer exists on GitHub
6. Board settings include stale PR detection: "Mark PRs stale after X days of inactivity" (default: 14 days)
7. Stale PRs show yellow "Stale" badge on card
8. Stale PR notification sent to card creator: "PR #123 has been inactive for 14 days"
9. Admin can bulk cleanup: "Delete all merged branches" button in repository settings
10. Bulk cleanup shows confirmation with count: "Delete 12 merged branches?"
11. Cleanup logs activity for each deleted branch
12. Cleanup respects protected branches (never deletes main, master, develop, etc.)

---

## Tasks / Subtasks

- [ ] **Task 1: Add cleanup settings to Board model** (AC: 1, 6)
  - [ ] Add `auto_delete_branches` boolean
  - [ ] Add `stale_pr_days` integer (default 14)

- [ ] **Task 2: Implement auto-delete on PR merge** (AC: 2, 3, 4)
  - [ ] In PR merge webhook, check auto_delete_branches setting
  - [ ] Call GitHub API: `DELETE /repos/{owner}/{repo}/git/refs/heads/{branch}`
  - [ ] Log activity, update card metadata

- [ ] **Task 3: Add branch deleted indicator** (AC: 5)
  - [ ] Check if branch exists on GitHub
  - [ ] Show "Branch deleted" badge if not found
  - [ ] Badge is informational, not an error

- [ ] **Task 4: Implement stale PR detection** (AC: 6, 7, 8)
  - [ ] Celery periodic task checks PR last_updated_at
  - [ ] If > stale_pr_days, mark as stale
  - [ ] Create notification for card creator

- [ ] **Task 5: Add bulk cleanup UI** (AC: 9, 10, 11)
  - [ ] Add "Cleanup" section to repository settings
  - [ ] "Delete all merged branches" button
  - [ ] Confirmation modal with count
  - [ ] Batch delete via GitHub API

- [ ] **Task 6: Implement protected branch check** (AC: 12)
  - [ ] Fetch protected branches from GitHub API
  - [ ] Never delete branches matching protected list
  - [ ] Default protect: main, master, develop, staging, production

- [ ] **Task 7: Write tests** (AC: 1-12)
  - [ ] Unit test: Protected branch detection
  - [ ] Integration test: Auto-delete after merge
  - [ ] Integration test: Stale PR detection

---

## Dev Notes

### Protected Branches

```python
PROTECTED_BRANCHES = ['main', 'master', 'develop', 'staging', 'production']

def is_protected_branch(branch_name: str) -> bool:
    return branch_name.lower() in PROTECTED_BRANCHES
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-23 | 1.0 | Initial story creation from PRD Epic 3 Story 3.7 | Sarah (PO Agent) |
