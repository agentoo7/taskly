# Story 2.4: Card Creation & Basic Metadata

## Status
Draft

---

## Story

**As a** board member,
**I want** to create cards with title, description, and basic metadata,
**so that** I can capture and organize tasks.

---

## Acceptance Criteria

1. Clicking "Add Card" button in column header opens quick-create input at top of column
2. Quick-create input allows typing card title (required, max 255 chars) and pressing Enter to create card
3. Created card appears at top of column with just title visible (collapsed state)
4. Clicking card opens card detail modal showing full editable fields: title, description (markdown editor), priority, due date, story points
5. Description editor supports markdown with preview toggle (shows formatted markdown or raw text)
6. Priority selector dropdown offers: None (default), Low (blue), Medium (yellow), High (orange), Urgent (red)
7. Priority displayed as colored dot indicator on card in column view
8. Due date picker allows selecting date (calendar widget), displayed as "Due: MMM DD" on card
9. Overdue cards (due date passed, card not in "Done" column) show red due date indicator
10. Story points input accepts integers 0-99, displayed as badge on card (e.g., "5 pts")
11. Card position persists in `cards.position` field (integer); newly created cards get position 0, existing cards increment
12. Cards within column ordered by position ascending (lowest position at top)
13. Empty columns display placeholder text: "Drag cards here or click + to add"
14. Card detail modal includes "Delete Card" button (requires confirmation: "Delete this card?")
15. Deleted cards removed from database immediately, column updates in real-time

---

## Tasks / Subtasks

- [ ] **Task 1: Create card API endpoints** (AC: 2, 3, 11, 12, 14, 15)
  - [ ] Create `backend/app/api/cards.py` router
  - [ ] Implement `POST /boards/{board_id}/cards` - create new card
  - [ ] Implement `GET /boards/{board_id}/cards` - list cards in board
  - [ ] Implement `GET /cards/{id}` - get card details
  - [ ] Implement `PATCH /cards/{id}` - update card fields
  - [ ] Implement `DELETE /cards/{id}` - delete card
  - [ ] Auto-increment positions when inserting card at position 0
  - [ ] Support filtering cards by column_id

- [ ] **Task 2: Create card service layer** (AC: 11, 12, 15)
  - [ ] Create `backend/app/services/card_service.py`
  - [ ] Implement `create_card(board_id, column_id, title, created_by)` - creates card at position 0
  - [ ] Implement position management: increment existing cards in column
  - [ ] Implement `update_card(card_id, updates)` - validates and updates fields
  - [ ] Implement `delete_card(card_id)` - removes card and reorders positions
  - [ ] Implement `get_board_cards(board_id, column_id=None)` - fetch with filters
  - [ ] Add permission check: user must be workspace member

- [ ] **Task 3: Create card Pydantic schemas** (AC: 1, 4, 6, 8, 10)
  - [ ] Create `backend/app/schemas/card.py`
  - [ ] Define `CardCreate`: title (str max 255), column_id (UUID), board_id (UUID)
  - [ ] Define `CardUpdate`: title, description, priority, due_date, story_points (all optional)
  - [ ] Define `PriorityEnum`: none, low, medium, high, urgent
  - [ ] Define `CardResponse`: id, title, description, priority, due_date, story_points, position, created_by, created_at, updated_at
  - [ ] Define `CardDetailResponse`: includes assignees, labels, comments (for future stories)
  - [ ] Add validators: title not empty, story_points 0-99

- [ ] **Task 4: Update board column component with quick-create** (AC: 1, 2, 3, 13)
  - [ ] Update `frontend/src/components/board/board-column.tsx`
  - [ ] Add "+ Add Card" button to column header
  - [ ] On click, show inline input at top of column
  - [ ] Input auto-focuses on appear
  - [ ] On Enter key, call `POST /boards/{boardId}/cards` with title and column_id
  - [ ] On Escape key, hide input without creating card
  - [ ] Show loading state during card creation
  - [ ] Optimistic update: add card to column immediately

- [ ] **Task 5: Create board card component (collapsed view)** (AC: 3, 7, 8, 10)
  - [ ] Create `frontend/src/components/board/board-card.tsx`
  - [ ] Display card title (truncate if longer than 2 lines)
  - [ ] Show priority dot indicator (colored based on priority)
  - [ ] Show due date badge if set: "Due: Oct 23" (green if future, red if overdue)
  - [ ] Show story points badge if set: "5 pts"
  - [ ] Add click handler to open card detail modal
  - [ ] Show hover state with subtle shadow
  - [ ] Make keyboard accessible (Tab to focus, Enter to open)

- [ ] **Task 6: Create card detail modal** (AC: 4, 5, 6, 8, 10, 14)
  - [ ] Create `frontend/src/components/board/card-detail-modal.tsx`
  - [ ] Use shadcn/ui Dialog component (large, scrollable)
  - [ ] Top section: editable title (inline input on click)
  - [ ] Description section: markdown editor with tabs (Write, Preview)
  - [ ] Use react-markdown for preview rendering
  - [ ] Priority section: dropdown with color-coded options
  - [ ] Due date section: date picker (use shadcn/ui Calendar)
  - [ ] Story points section: number input (0-99)
  - [ ] All fields auto-save on blur (debounced API calls)
  - [ ] Delete button in modal footer (danger styling)

- [ ] **Task 7: Implement markdown editor for card description** (AC: 5)
  - [ ] Create `frontend/src/components/board/markdown-editor.tsx`
  - [ ] Use simple textarea for markdown input
  - [ ] Add toolbar with basic formatting buttons: Bold, Italic, Link, List, Code
  - [ ] Add "Write" and "Preview" tabs to toggle between modes
  - [ ] Preview uses react-markdown with syntax highlighting (rehype-highlight)
  - [ ] Support common markdown: headings, lists, links, code blocks, bold, italic
  - [ ] Save draft to localStorage (auto-recover on page refresh)

- [ ] **Task 8: Create priority selector component** (AC: 6, 7)
  - [ ] Create `frontend/src/components/board/priority-selector.tsx`
  - [ ] Use shadcn/ui Select component
  - [ ] Options: None, Low (blue dot), Medium (yellow), High (orange), Urgent (red)
  - [ ] Display colored dot next to each option name
  - [ ] Show current priority with colored dot in trigger
  - [ ] On change, call `PATCH /cards/{id}` with new priority
  - [ ] Optimistic update: change immediately, rollback on error

- [ ] **Task 9: Create due date picker component** (AC: 8, 9)
  - [ ] Create `frontend/src/components/board/due-date-picker.tsx`
  - [ ] Use shadcn/ui Popover + Calendar components
  - [ ] Button shows current due date or "Set due date" if none
  - [ ] Calendar allows selecting any future or past date
  - [ ] Add quick select buttons: "Today", "Tomorrow", "Next Week", "Clear"
  - [ ] Display due date on card: format as "Due: Oct 23"
  - [ ] Color coding: green (future), yellow (today), red (overdue)
  - [ ] Overdue calculation: due_date < today AND column != "Done"

- [ ] **Task 10: Implement story points input** (AC: 10)
  - [ ] Create simple number input in card detail modal
  - [ ] Accept only integers 0-99
  - [ ] Display validation error if outside range
  - [ ] Show story points badge on card: circle with number
  - [ ] On change, call `PATCH /cards/{id}` with new story_points
  - [ ] Optimistic update

- [ ] **Task 11: Implement card deletion** (AC: 14, 15)
  - [ ] Add "Delete Card" button to card detail modal footer
  - [ ] Use destructive styling (red background)
  - [ ] Show confirmation dialog: "Delete this card?"
  - [ ] On confirm, call `DELETE /cards/{id}`
  - [ ] Close modal and remove card from column
  - [ ] Update position of remaining cards in column
  - [ ] Show success toast: "Card deleted"

- [ ] **Task 12: Add real-time card updates via WebSocket** (AC: 2, 3, 15)
  - [ ] Backend broadcasts `card_created` event when card added
  - [ ] Backend broadcasts `card_updated` event when card modified
  - [ ] Backend broadcasts `card_deleted` event when card removed
  - [ ] Frontend subscribes to board room WebSocket events
  - [ ] On `card_created`, add card to column (if not already present)
  - [ ] On `card_updated`, update card data in local state
  - [ ] On `card_deleted`, remove card from column
  - [ ] Display subtle animation when card appears/updates

- [ ] **Task 13: Write tests for card management** (AC: 1-15)
  - [ ] Unit test: Card service creates card at position 0 and increments others
  - [ ] Unit test: Priority enum validation
  - [ ] Unit test: Story points validation (0-99)
  - [ ] Integration test: Create card API endpoint
  - [ ] Integration test: Update card fields
  - [ ] Integration test: Delete card and verify position reordering
  - [ ] Component test: Quick-create input creates card on Enter
  - [ ] Component test: Card detail modal saves changes
  - [ ] E2E test: Full card creation and editing workflow

---

## Dev Notes

### Card Model (Already Created in Story 1.3)

```python
# backend/app/models/card.py
class PriorityEnum(str, enum.Enum):
    NONE = "none"
    LOW = "low"
    MEDIUM = "medium"
    HIGH = "high"
    URGENT = "urgent"

class Card(Base):
    __tablename__ = "cards"

    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    board_id = Column(UUID(as_uuid=True), ForeignKey("boards.id", ondelete="CASCADE"), nullable=False)
    column_id = Column(UUID(as_uuid=True), nullable=False)
    title = Column(String(255), nullable=False)
    description = Column(Text)
    metadata = Column(JSONB, default=dict)
    priority = Column(SQLEnum(PriorityEnum), default=PriorityEnum.NONE)
    story_points = Column(Integer)
    due_date = Column(Date)
    position = Column(Integer, nullable=False, default=0)
    sprint_id = Column(UUID(as_uuid=True), ForeignKey("sprints.id", ondelete="SET NULL"))
    created_by = Column(UUID(as_uuid=True), ForeignKey("users.id"), nullable=False)
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    updated_at = Column(DateTime(timezone=True), server_default=func.now(), onupdate=func.now())

    # Composite index for ordering
    __table_args__ = (
        Index("ix_cards_board_position", "board_id", "position"),
    )
```

### Card Service with Position Management

```python
# backend/app/services/card_service.py
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, update
from app.models.card import Card
from uuid import UUID

class CardService:
    def __init__(self, db: AsyncSession):
        self.db = db

    async def create_card(
        self,
        board_id: UUID,
        column_id: UUID,
        title: str,
        created_by: UUID
    ) -> Card:
        """Create card at position 0, incrementing existing cards."""
        async with self.db.begin():
            # Increment positions of existing cards in column
            await self.db.execute(
                update(Card)
                .where(
                    Card.board_id == board_id,
                    Card.column_id == column_id
                )
                .values(position=Card.position + 1)
            )

            # Create new card at position 0
            card = Card(
                board_id=board_id,
                column_id=column_id,
                title=title.strip(),
                position=0,
                created_by=created_by
            )
            self.db.add(card)
            await self.db.flush()
            await self.db.refresh(card)

        return card

    async def update_card(self, card_id: UUID, updates: dict) -> Card:
        """Update card fields."""
        card = await self.db.get(Card, card_id)
        if not card:
            raise ValueError("Card not found")

        for key, value in updates.items():
            if hasattr(card, key):
                setattr(card, key, value)

        await self.db.commit()
        await self.db.refresh(card)
        return card

    async def delete_card(self, card_id: UUID) -> None:
        """Delete card and reorder remaining cards."""
        async with self.db.begin():
            card = await self.db.get(Card, card_id)
            if not card:
                raise ValueError("Card not found")

            board_id = card.board_id
            column_id = card.column_id
            position = card.position

            # Delete card
            await self.db.delete(card)

            # Reorder remaining cards (decrement positions > deleted position)
            await self.db.execute(
                update(Card)
                .where(
                    Card.board_id == board_id,
                    Card.column_id == column_id,
                    Card.position > position
                )
                .values(position=Card.position - 1)
            )

    async def get_board_cards(self, board_id: UUID, column_id: UUID = None) -> list[Card]:
        """Fetch cards for board, optionally filtered by column."""
        query = select(Card).where(Card.board_id == board_id)
        if column_id:
            query = query.where(Card.column_id == column_id)
        query = query.order_by(Card.position.asc())

        result = await self.db.execute(query)
        return result.scalars().all()
```

### Frontend Board Card Component

```typescript
// frontend/src/components/board/board-card.tsx
'use client'

import { Card as CardType } from '@/types/api'
import { Card } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { cn } from '@/lib/utils/cn'
import { Calendar, AlertCircle } from 'lucide-react'
import { format, isPast, isToday } from 'date-fns'

interface BoardCardProps {
  card: CardType
  onClick: () => void
}

const PRIORITY_COLORS = {
  none: 'bg-gray-400',
  low: 'bg-blue-500',
  medium: 'bg-yellow-500',
  high: 'bg-orange-500',
  urgent: 'bg-red-500',
}

export function BoardCard({ card, onClick }: BoardCardProps) {
  const isOverdue = card.due_date && isPast(new Date(card.due_date)) && card.column_id !== 'done'
  const isDueToday = card.due_date && isToday(new Date(card.due_date))

  return (
    <Card
      className="p-3 cursor-pointer hover:shadow-md transition-shadow"
      onClick={onClick}
      tabIndex={0}
      onKeyDown={(e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault()
          onClick()
        }
      }}
    >
      {/* Priority Indicator */}
      {card.priority !== 'none' && (
        <div className="flex items-center gap-2 mb-2">
          <div className={cn('w-2 h-2 rounded-full', PRIORITY_COLORS[card.priority])} />
        </div>
      )}

      {/* Title */}
      <h4 className="text-sm font-medium line-clamp-2 mb-2">{card.title}</h4>

      {/* Metadata Badges */}
      <div className="flex items-center gap-2 flex-wrap">
        {card.due_date && (
          <Badge
            variant="outline"
            className={cn(
              'text-xs',
              isOverdue && 'border-red-500 text-red-600',
              isDueToday && 'border-yellow-500 text-yellow-600'
            )}
          >
            {isOverdue && <AlertCircle className="mr-1 h-3 w-3" />}
            <Calendar className="mr-1 h-3 w-3" />
            Due: {format(new Date(card.due_date), 'MMM dd')}
          </Badge>
        )}

        {card.story_points && (
          <Badge variant="secondary" className="text-xs">
            {card.story_points} pts
          </Badge>
        )}
      </div>
    </Card>
  )
}
```

### Card Detail Modal

```typescript
// frontend/src/components/board/card-detail-modal.tsx
'use client'

import { useState } from 'react'
import { useMutation, useQueryClient } from '@tanstack/react-query'
import {
  Dialog,
  DialogContent,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'
import { Textarea } from '@/components/ui/textarea'
import { PrioritySelector } from './priority-selector'
import { DueDatePicker } from './due-date-picker'
import { api } from '@/lib/api/client'
import { toast } from 'sonner'
import ReactMarkdown from 'react-markdown'
import { Trash2 } from 'lucide-react'

interface CardDetailModalProps {
  card: any
  open: boolean
  onOpenChange: (open: boolean) => void
  boardId: string
}

export function CardDetailModal({ card, open, onOpenChange, boardId }: CardDetailModalProps) {
  const [title, setTitle] = useState(card.title)
  const [description, setDescription] = useState(card.description || '')
  const [storyPoints, setStoryPoints] = useState(card.story_points || '')
  const queryClient = useQueryClient()

  const updateMutation = useMutation({
    mutationFn: (updates: any) => api.patch(`/cards/${card.id}`, updates),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['boards', boardId] })
    },
    onError: () => {
      toast.error('Failed to update card')
    },
  })

  const deleteMutation = useMutation({
    mutationFn: () => api.delete(`/cards/${card.id}`),
    onSuccess: () => {
      toast.success('Card deleted')
      queryClient.invalidateQueries({ queryKey: ['boards', boardId] })
      onOpenChange(false)
    },
    onError: () => {
      toast.error('Failed to delete card')
    },
  })

  const handleFieldUpdate = (field: string, value: any) => {
    updateMutation.mutate({ [field]: value })
  }

  const handleDelete = () => {
    if (confirm('Delete this card?')) {
      deleteMutation.mutate()
    }
  }

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="max-w-3xl max-h-[90vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle>
            <Input
              value={title}
              onChange={(e) => setTitle(e.target.value)}
              onBlur={() => handleFieldUpdate('title', title)}
              className="text-2xl font-bold border-none px-0 focus-visible:ring-0"
            />
          </DialogTitle>
        </DialogHeader>

        <div className="grid gap-6">
          {/* Description with Markdown */}
          <div>
            <Label>Description</Label>
            <Tabs defaultValue="write" className="mt-2">
              <TabsList>
                <TabsTrigger value="write">Write</TabsTrigger>
                <TabsTrigger value="preview">Preview</TabsTrigger>
              </TabsList>
              <TabsContent value="write">
                <Textarea
                  value={description}
                  onChange={(e) => setDescription(e.target.value)}
                  onBlur={() => handleFieldUpdate('description', description)}
                  placeholder="Add a description..."
                  className="min-h-[200px]"
                />
              </TabsContent>
              <TabsContent value="preview">
                <div className="min-h-[200px] p-4 border rounded-md prose prose-sm max-w-none">
                  <ReactMarkdown>{description || '*No description*'}</ReactMarkdown>
                </div>
              </TabsContent>
            </Tabs>
          </div>

          {/* Metadata */}
          <div className="grid grid-cols-3 gap-4">
            <div>
              <Label>Priority</Label>
              <PrioritySelector
                value={card.priority}
                onChange={(priority) => handleFieldUpdate('priority', priority)}
              />
            </div>
            <div>
              <Label>Due Date</Label>
              <DueDatePicker
                value={card.due_date}
                onChange={(date) => handleFieldUpdate('due_date', date)}
              />
            </div>
            <div>
              <Label>Story Points</Label>
              <Input
                type="number"
                min="0"
                max="99"
                value={storyPoints}
                onChange={(e) => setStoryPoints(e.target.value)}
                onBlur={() => handleFieldUpdate('story_points', parseInt(storyPoints) || null)}
                placeholder="0-99"
              />
            </div>
          </div>
        </div>

        <DialogFooter>
          <Button
            variant="destructive"
            onClick={handleDelete}
            disabled={deleteMutation.isPending}
          >
            <Trash2 className="mr-2 h-4 w-4" />
            Delete Card
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  )
}
```

### Testing

**Unit Test - Position Management:**
```python
@pytest.mark.asyncio
async def test_create_card_at_position_zero(db_session, test_board, test_column, test_user):
    service = CardService(db_session)

    # Create first card
    card1 = await service.create_card(test_board.id, test_column.id, "Card 1", test_user.id)
    assert card1.position == 0

    # Create second card - should be at position 0, first card incremented to 1
    card2 = await service.create_card(test_board.id, test_column.id, "Card 2", test_user.id)
    assert card2.position == 0

    await db_session.refresh(card1)
    assert card1.position == 1
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-23 | 1.0 | Initial story creation from PRD Epic 2 Story 2.4 | Sarah (PO Agent) |

---

## Dev Agent Record

### Agent Model Used
*To be populated by development agent*

### Debug Log References
*To be populated by development agent*

### Completion Notes List
*To be populated by development agent*

### File List
*To be populated by development agent*

---

## QA Results
*To be populated by QA agent after implementation review*
