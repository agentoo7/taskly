# Story 3.5: Auto-Column Movement (PR Events)

## Status
Draft

---

## Story

**As a** developer,
**I want** cards to automatically move to "Done" when PRs are merged,
**so that** my board stays synchronized with code progress without manual updates.

---

## Acceptance Criteria

1. When PR linked to card is merged, card auto-moves to "Done" column (or last column if no "Done" column exists)
2. Auto-move only happens if card currently in "In Progress" or "In Review" columns (not from "To Do" or already "Done")
3. Auto-move adds activity entry: "[User] merged PR #123, moved card to Done"
4. Auto-move triggers WebSocket broadcast so all viewers see change in real-time
5. Board settings allow disabling auto-move with toggle: "Auto-move cards when PR merged"
6. Auto-move respects column mapping: board settings map PR states to columns (e.g., "PR Opened" → "In Progress", "PR Merged" → "Done")
7. If multiple PRs linked to card, auto-move only triggers when ALL PRs merged
8. Auto-move creates notification for card assignees: "Card moved to Done (PR #123 merged)"
9. User can undo auto-move within 30 seconds via toast notification "Undo" button
10. Undo reverts card to previous column and logs activity: "undid auto-move"

---

## Tasks / Subtasks

- [ ] **Task 1: Add auto-move settings to Board model** (AC: 5, 6)
  - [ ] Add `auto_move_enabled` boolean to boards table
  - [ ] Add `column_mapping` JSONB for PR state → column mapping
  - [ ] Default mapping: `{"pr_merged": "Done", "pr_opened": "In Progress"}`

- [ ] **Task 2: Implement auto-move logic** (AC: 1, 2, 7)
  - [ ] Create `backend/app/services/auto_move_service.py`
  - [ ] Method: `auto_move_on_pr_merge(card_id, pr_id)`
  - [ ] Check auto-move enabled on board
  - [ ] Check card in eligible column (In Progress, In Review)
  - [ ] If multiple PRs, check all merged before moving

- [ ] **Task 3: Trigger auto-move from webhook** (AC: 3, 4, 8)
  - [ ] In PR merge webhook handler, call auto-move service
  - [ ] Log activity with PR number and user
  - [ ] Broadcast WebSocket event
  - [ ] Create notifications for assignees

- [ ] **Task 4: Add board settings UI** (AC: 5, 6)
  - [ ] Add auto-move toggle to board settings
  - [ ] Add column mapping editor (advanced)
  - [ ] Save settings to database

- [ ] **Task 5: Implement undo functionality** (AC: 9, 10)
  - [ ] Store previous column in undo state (Zustand)
  - [ ] Show toast with "Undo" button for 30 seconds
  - [ ] Undo API endpoint moves card back

- [ ] **Task 6: Write tests** (AC: 1-10)
  - [ ] Unit test: Auto-move logic with multiple PRs
  - [ ] Integration test: Webhook triggers auto-move
  - [ ] E2E test: Card moves when PR merged

---

## Dev Notes

### Auto-Move Service

```python
# backend/app/services/auto_move_service.py
async def auto_move_on_pr_merge(card_id: UUID, pr_id: UUID, merged_by_user_id: UUID):
    card = await db.get(Card, card_id)
    board = await db.get(Board, card.board_id)

    if not board.auto_move_enabled:
        return

    # Check all linked PRs
    prs = await get_card_prs(card_id)
    if not all(pr.state == "merged" for pr in prs):
        return  # Wait until all PRs merged

    # Find "Done" column
    done_column = next((col for col in board.columns if col["name"].lower() == "done"), None)
    if not done_column:
        done_column = board.columns[-1]  # Use last column

    # Move card
    await move_card(card_id, done_column["id"], position=0)

    # Log activity
    await log_activity(card_id, merged_by_user_id, "auto_moved", {"reason": "pr_merged", "pr_id": pr_id})
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-23 | 1.0 | Initial story creation from PRD Epic 3 Story 3.5 | Sarah (PO Agent) |
