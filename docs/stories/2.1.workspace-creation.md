# Story 2.1: Workspace Creation & Management

## Status
Draft

---

## Story

**As a** logged-in user,
**I want** to create and manage workspaces for my teams,
**so that** I can organize multiple projects separately.

---

## Acceptance Criteria

1. Landing page displays "Create Workspace" button when user has no workspaces
2. Clicking "Create Workspace" opens modal with form: workspace name (required, max 100 chars)
3. Submitting form creates workspace with current user as admin and redirects to workspace dashboard
4. Workspace dashboard displays workspace name, list of boards (empty initially), "Create Board" button
5. User who created workspace automatically assigned "admin" role in workspace_members table
6. Sidebar navigation shows list of all workspaces user is member of with ability to switch between them
7. Active workspace indicated visually in sidebar (highlighted, checkmark, or bold text)
8. Workspace settings page accessible to admins showing: workspace name (editable), member list, delete workspace option
9. Workspace name editable by admins only (updates in real-time for all members viewing workspace)
10. Delete workspace action requires confirmation modal ("This will delete all boards and cards. Type workspace name to confirm")
11. Deleting workspace cascades deletion to all boards, cards, and membership records
12. Workspace dashboard shows empty state with helpful message and call-to-action when no boards exist: "Get started by creating your first board"

---

## Tasks / Subtasks

- [ ] **Task 1: Create workspace API endpoints** (AC: 2, 3, 5, 8, 9, 10, 11)
  - [ ] Create `backend/app/api/workspaces.py` router
  - [ ] Implement `POST /workspaces` - create new workspace
  - [ ] Implement `GET /workspaces` - list user's workspaces
  - [ ] Implement `GET /workspaces/{id}` - get workspace details with boards
  - [ ] Implement `PATCH /workspaces/{id}` - update workspace name (admin only)
  - [ ] Implement `DELETE /workspaces/{id}` - delete workspace with confirmation (admin only)
  - [ ] Add permission checks: only admins can update/delete workspaces
  - [ ] Cascade delete: remove all boards, cards, and memberships when workspace deleted

- [ ] **Task 2: Create workspace service layer** (AC: 3, 5, 11)
  - [ ] Create `backend/app/services/workspace_service.py`
  - [ ] Implement `create_workspace(name, creator_id)` - creates workspace and admin membership
  - [ ] Implement `get_user_workspaces(user_id)` - returns all workspaces user belongs to
  - [ ] Implement `update_workspace(workspace_id, updates, user_id)` - validates admin permission
  - [ ] Implement `delete_workspace(workspace_id, user_id)` - validates admin, cascades deletes
  - [ ] Add transaction management for create/delete operations
  - [ ] Broadcast WebSocket event on workspace updates

- [ ] **Task 3: Create workspace Pydantic schemas** (AC: 2)
  - [ ] Create `backend/app/schemas/workspace.py`
  - [ ] Define `WorkspaceCreate` schema: name (str, max_length=100)
  - [ ] Define `WorkspaceUpdate` schema: name (Optional[str])
  - [ ] Define `WorkspaceResponse` schema: id, name, created_by, created_at, member_count
  - [ ] Define `WorkspaceDetailResponse` schema: includes boards list, members list
  - [ ] Add validation: workspace name cannot be empty or whitespace only

- [ ] **Task 4: Create workspace creation modal in frontend** (AC: 1, 2, 3)
  - [ ] Create `frontend/src/components/workspace/create-workspace-modal.tsx`
  - [ ] Use shadcn/ui Dialog component for modal
  - [ ] Add form with React Hook Form: workspace name input (max 100 chars)
  - [ ] Add form validation with Zod: name required, trimmed, max 100 chars
  - [ ] On submit, call `POST /workspaces` API endpoint
  - [ ] Show loading state during submission
  - [ ] On success, redirect to workspace dashboard using Next.js router
  - [ ] On error, display error message in modal

- [ ] **Task 5: Update workspaces landing page with create button** (AC: 1, 4)
  - [ ] Update `frontend/src/app/(dashboard)/workspaces/page.tsx`
  - [ ] Add "Create Workspace" button to empty state
  - [ ] Add "Create Workspace" button to page header when workspaces exist
  - [ ] Open create workspace modal on button click
  - [ ] Use TanStack Query to fetch workspaces: `useQuery({ queryKey: ['workspaces'] })`
  - [ ] Display workspace list as grid of cards when workspaces exist
  - [ ] Each workspace card shows: name, board count, member count, last updated

- [ ] **Task 6: Create workspace dashboard page** (AC: 4, 12)
  - [ ] Create `frontend/src/app/(dashboard)/workspaces/[workspaceId]/page.tsx`
  - [ ] Fetch workspace details: `useQuery({ queryKey: ['workspaces', workspaceId] })`
  - [ ] Display workspace name as page header
  - [ ] Show "Create Board" button in header (placeholder, will implement in Story 2.3)
  - [ ] Display empty state when no boards: illustration + message + "Create Board" CTA
  - [ ] Display boards list as grid when boards exist (placeholder cards for now)
  - [ ] Add loading skeleton while fetching workspace data

- [ ] **Task 7: Create sidebar with workspace switcher** (AC: 6, 7)
  - [ ] Create `frontend/src/components/layout/sidebar.tsx`
  - [ ] Update dashboard layout to include sidebar
  - [ ] Fetch user's workspaces in sidebar: `useQuery({ queryKey: ['workspaces'] })`
  - [ ] Display workspace list with icons and names
  - [ ] Highlight active workspace with blue background or checkmark icon
  - [ ] Clicking workspace navigates to workspace dashboard
  - [ ] Add "+ Create Workspace" button at bottom of workspace list
  - [ ] Make sidebar collapsible with toggle button
  - [ ] Persist sidebar collapsed state in Zustand store

- [ ] **Task 8: Create workspace settings page** (AC: 8, 9, 10)
  - [ ] Create `frontend/src/app/(dashboard)/workspaces/[workspaceId]/settings/page.tsx`
  - [ ] Add "Settings" link to workspace dashboard (visible to admins only)
  - [ ] Display workspace name with inline edit input (admins only)
  - [ ] Use optimistic updates for name changes with TanStack Query mutation
  - [ ] Display member list (placeholder, will populate in Story 2.2)
  - [ ] Add "Delete Workspace" button in danger zone section (admins only)
  - [ ] Show destructive styling for delete button (red background)

- [ ] **Task 9: Create workspace deletion modal with confirmation** (AC: 10, 11)
  - [ ] Create `frontend/src/components/workspace/delete-workspace-modal.tsx`
  - [ ] Use shadcn/ui AlertDialog component for destructive action
  - [ ] Display warning message: "This will delete all boards and cards. Type workspace name to confirm"
  - [ ] Add text input for workspace name confirmation
  - [ ] Disable "Delete" button until input matches workspace name exactly
  - [ ] On confirm, call `DELETE /workspaces/{id}` API endpoint
  - [ ] Show loading state during deletion
  - [ ] On success, redirect to workspaces landing page
  - [ ] Invalidate TanStack Query cache for workspaces list

- [ ] **Task 10: Add real-time workspace updates via WebSocket** (AC: 9)
  - [ ] Update `backend/app/websockets/manager.py` to support workspace rooms
  - [ ] Broadcast workspace updates to all members: `workspace_updated` event
  - [ ] Frontend WebSocket client subscribes to workspace room on dashboard mount
  - [ ] On `workspace_updated` event, invalidate workspace query cache
  - [ ] Display toast notification: "[User] updated workspace name to [New Name]"
  - [ ] Automatically refresh workspace data without page reload

- [ ] **Task 11: Add permission checks middleware** (AC: 8, 9, 10)
  - [ ] Create `backend/app/api/dependencies.py` permission helpers
  - [ ] Implement `check_workspace_admin(user, workspace_id)` - raises 403 if not admin
  - [ ] Implement `check_workspace_member(user, workspace_id)` - raises 403 if not member
  - [ ] Apply admin check to update/delete workspace endpoints
  - [ ] Apply member check to view workspace endpoint
  - [ ] Return clear error messages: "You must be a workspace admin to perform this action"

- [ ] **Task 12: Write tests for workspace management** (AC: 1-12)
  - [ ] Unit test: Workspace service creates workspace and admin membership
  - [ ] Unit test: Only admins can update/delete workspaces
  - [ ] Integration test: Create workspace API endpoint
  - [ ] Integration test: Delete workspace cascades to boards and cards
  - [ ] Component test: Create workspace modal validates form
  - [ ] Component test: Delete workspace modal requires name confirmation
  - [ ] E2E test: Full workflow from create to delete workspace

---

## Dev Notes

### Workspace Data Model (Already Created in Story 1.3)

```python
# backend/app/models/workspace.py
class Workspace(Base):
    __tablename__ = "workspaces"

    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    name = Column(String(100), nullable=False)
    created_by = Column(UUID(as_uuid=True), ForeignKey("users.id"), nullable=False)
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    updated_at = Column(DateTime(timezone=True), server_default=func.now(), onupdate=func.now())

    # Relationships
    creator = relationship("User", back_populates="created_workspaces", foreign_keys=[created_by])
    members = relationship("User", secondary="workspace_members", back_populates="workspaces")
    boards = relationship("Board", back_populates="workspace", cascade="all, delete-orphan")
```

```python
# backend/app/models/workspace_member.py
class RoleEnum(str, enum.Enum):
    ADMIN = "admin"
    MEMBER = "member"

class WorkspaceMember(Base):
    __tablename__ = "workspace_members"

    user_id = Column(UUID(as_uuid=True), ForeignKey("users.id", ondelete="CASCADE"), primary_key=True)
    workspace_id = Column(UUID(as_uuid=True), ForeignKey("workspaces.id", ondelete="CASCADE"), primary_key=True)
    role = Column(SQLEnum(RoleEnum), nullable=False, default=RoleEnum.MEMBER)
    joined_at = Column(DateTime(timezone=True), server_default=func.now())
```

### Workspace Service Implementation

```python
# backend/app/services/workspace_service.py
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select
from app.models.workspace import Workspace
from app.models.workspace_member import WorkspaceMember, RoleEnum
from app.models.user import User
from uuid import UUID
from fastapi import HTTPException, status

class WorkspaceService:
    def __init__(self, db: AsyncSession):
        self.db = db

    async def create_workspace(self, name: str, creator_id: UUID) -> Workspace:
        """Create workspace and add creator as admin."""
        async with self.db.begin():
            # Create workspace
            workspace = Workspace(name=name.strip(), created_by=creator_id)
            self.db.add(workspace)
            await self.db.flush()

            # Add creator as admin
            membership = WorkspaceMember(
                user_id=creator_id,
                workspace_id=workspace.id,
                role=RoleEnum.ADMIN
            )
            self.db.add(membership)
            await self.db.flush()
            await self.db.refresh(workspace)

        return workspace

    async def get_user_workspaces(self, user_id: UUID) -> list[Workspace]:
        """Get all workspaces user is member of."""
        result = await self.db.execute(
            select(Workspace)
            .join(WorkspaceMember)
            .where(WorkspaceMember.user_id == user_id)
            .order_by(Workspace.updated_at.desc())
        )
        return result.scalars().all()

    async def update_workspace(self, workspace_id: UUID, updates: dict, user_id: UUID) -> Workspace:
        """Update workspace (admin only)."""
        # Check admin permission
        await self._check_admin(workspace_id, user_id)

        result = await self.db.execute(select(Workspace).where(Workspace.id == workspace_id))
        workspace = result.scalar_one_or_none()

        if not workspace:
            raise HTTPException(status_code=404, detail="Workspace not found")

        for key, value in updates.items():
            setattr(workspace, key, value)

        await self.db.commit()
        await self.db.refresh(workspace)
        return workspace

    async def delete_workspace(self, workspace_id: UUID, user_id: UUID) -> None:
        """Delete workspace and all related data (admin only)."""
        # Check admin permission
        await self._check_admin(workspace_id, user_id)

        result = await self.db.execute(select(Workspace).where(Workspace.id == workspace_id))
        workspace = result.scalar_one_or_none()

        if not workspace:
            raise HTTPException(status_code=404, detail="Workspace not found")

        await self.db.delete(workspace)
        await self.db.commit()

    async def _check_admin(self, workspace_id: UUID, user_id: UUID) -> None:
        """Check if user is admin of workspace."""
        result = await self.db.execute(
            select(WorkspaceMember)
            .where(
                WorkspaceMember.workspace_id == workspace_id,
                WorkspaceMember.user_id == user_id,
                WorkspaceMember.role == RoleEnum.ADMIN
            )
        )
        if not result.scalar_one_or_none():
            raise HTTPException(
                status_code=status.HTTP_403_FORBIDDEN,
                detail="You must be a workspace admin to perform this action"
            )
```

### API Endpoints Implementation

```python
# backend/app/api/workspaces.py
from fastapi import APIRouter, Depends, HTTPException, status
from sqlalchemy.ext.asyncio import AsyncSession
from app.core.database import get_db
from app.api.dependencies import get_current_user
from app.services.workspace_service import WorkspaceService
from app.schemas.workspace import WorkspaceCreate, WorkspaceUpdate, WorkspaceResponse
from app.models.user import User

router = APIRouter(prefix="/workspaces", tags=["workspaces"])

@router.post("", response_model=WorkspaceResponse, status_code=status.HTTP_201_CREATED)
async def create_workspace(
    data: WorkspaceCreate,
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    """Create new workspace with current user as admin."""
    service = WorkspaceService(db)
    workspace = await service.create_workspace(data.name, current_user.id)
    return workspace

@router.get("", response_model=list[WorkspaceResponse])
async def list_workspaces(
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    """List all workspaces user is member of."""
    service = WorkspaceService(db)
    workspaces = await service.get_user_workspaces(current_user.id)
    return workspaces

@router.get("/{workspace_id}", response_model=WorkspaceDetailResponse)
async def get_workspace(
    workspace_id: UUID,
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    """Get workspace details with boards and members."""
    # TODO: Check user is member
    # TODO: Load boards and members
    pass

@router.patch("/{workspace_id}", response_model=WorkspaceResponse)
async def update_workspace(
    workspace_id: UUID,
    data: WorkspaceUpdate,
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    """Update workspace name (admin only)."""
    service = WorkspaceService(db)
    workspace = await service.update_workspace(
        workspace_id,
        data.dict(exclude_unset=True),
        current_user.id
    )
    return workspace

@router.delete("/{workspace_id}", status_code=status.HTTP_204_NO_CONTENT)
async def delete_workspace(
    workspace_id: UUID,
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    """Delete workspace and all boards/cards (admin only)."""
    service = WorkspaceService(db)
    await service.delete_workspace(workspace_id, current_user.id)
```

### Pydantic Schemas

```python
# backend/app/schemas/workspace.py
from pydantic import BaseModel, Field, validator
from uuid import UUID
from datetime import datetime

class WorkspaceCreate(BaseModel):
    name: str = Field(..., min_length=1, max_length=100)

    @validator('name')
    def name_not_empty(cls, v):
        if not v.strip():
            raise ValueError('Workspace name cannot be empty or whitespace')
        return v.strip()

class WorkspaceUpdate(BaseModel):
    name: str | None = Field(None, min_length=1, max_length=100)

class WorkspaceResponse(BaseModel):
    id: UUID
    name: str
    created_by: UUID
    created_at: datetime
    updated_at: datetime

    class Config:
        from_attributes = True

class WorkspaceDetailResponse(WorkspaceResponse):
    boards: list[dict]  # Board schemas
    members: list[dict]  # Member schemas
```

### Frontend Create Workspace Modal

```typescript
// frontend/src/components/workspace/create-workspace-modal.tsx
'use client'

import { useState } from 'react'
import { useForm } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'
import * as z from 'zod'
import { useMutation, useQueryClient } from '@tanstack/react-query'
import { useRouter } from 'next/navigation'
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { api } from '@/lib/api/client'
import { toast } from 'sonner'

const schema = z.object({
  name: z.string().min(1, 'Name is required').max(100, 'Name must be less than 100 characters'),
})

type FormData = z.infer<typeof schema>

interface CreateWorkspaceModalProps {
  open: boolean
  onOpenChange: (open: boolean) => void
}

export function CreateWorkspaceModal({ open, onOpenChange }: CreateWorkspaceModalProps) {
  const router = useRouter()
  const queryClient = useQueryClient()

  const {
    register,
    handleSubmit,
    formState: { errors },
    reset,
  } = useForm<FormData>({
    resolver: zodResolver(schema),
  })

  const createMutation = useMutation({
    mutationFn: (data: FormData) => api.post('/workspaces', data),
    onSuccess: (workspace) => {
      toast.success('Workspace created successfully')
      queryClient.invalidateQueries({ queryKey: ['workspaces'] })
      onOpenChange(false)
      reset()
      router.push(`/workspaces/${workspace.id}`)
    },
    onError: (error) => {
      toast.error('Failed to create workspace')
      console.error(error)
    },
  })

  const onSubmit = (data: FormData) => {
    createMutation.mutate(data)
  }

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="sm:max-w-[425px]">
        <DialogHeader>
          <DialogTitle>Create Workspace</DialogTitle>
          <DialogDescription>
            Create a new workspace to organize your boards and collaborate with your team.
          </DialogDescription>
        </DialogHeader>
        <form onSubmit={handleSubmit(onSubmit)}>
          <div className="grid gap-4 py-4">
            <div className="grid gap-2">
              <Label htmlFor="name">Workspace Name</Label>
              <Input
                id="name"
                placeholder="My Workspace"
                {...register('name')}
                autoFocus
              />
              {errors.name && (
                <p className="text-sm text-destructive">{errors.name.message}</p>
              )}
            </div>
          </div>
          <DialogFooter>
            <Button
              type="button"
              variant="outline"
              onClick={() => onOpenChange(false)}
              disabled={createMutation.isPending}
            >
              Cancel
            </Button>
            <Button type="submit" disabled={createMutation.isPending}>
              {createMutation.isPending ? 'Creating...' : 'Create Workspace'}
            </Button>
          </DialogFooter>
        </form>
      </DialogContent>
    </Dialog>
  )
}
```

### Frontend Delete Workspace Modal

```typescript
// frontend/src/components/workspace/delete-workspace-modal.tsx
'use client'

import { useState } from 'react'
import { useMutation, useQueryClient } from '@tanstack/react-query'
import { useRouter } from 'next/navigation'
import {
  AlertDialog,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from '@/components/ui/alert-dialog'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { api } from '@/lib/api/client'
import { toast } from 'sonner'

interface DeleteWorkspaceModalProps {
  workspace: { id: string; name: string }
  open: boolean
  onOpenChange: (open: boolean) => void
}

export function DeleteWorkspaceModal({ workspace, open, onOpenChange }: DeleteWorkspaceModalProps) {
  const [confirmName, setConfirmName] = useState('')
  const router = useRouter()
  const queryClient = useQueryClient()

  const deleteMutation = useMutation({
    mutationFn: () => api.delete(`/workspaces/${workspace.id}`),
    onSuccess: () => {
      toast.success('Workspace deleted successfully')
      queryClient.invalidateQueries({ queryKey: ['workspaces'] })
      onOpenChange(false)
      router.push('/workspaces')
    },
    onError: (error) => {
      toast.error('Failed to delete workspace')
      console.error(error)
    },
  })

  const handleDelete = () => {
    if (confirmName === workspace.name) {
      deleteMutation.mutate()
    }
  }

  return (
    <AlertDialog open={open} onOpenChange={onOpenChange}>
      <AlertDialogContent>
        <AlertDialogHeader>
          <AlertDialogTitle>Delete Workspace?</AlertDialogTitle>
          <AlertDialogDescription>
            This action cannot be undone. This will permanently delete the workspace and all boards, cards, and data within it.
          </AlertDialogDescription>
        </AlertDialogHeader>
        <div className="grid gap-4 py-4">
          <div className="grid gap-2">
            <Label htmlFor="confirm-name">
              Type <span className="font-bold">{workspace.name}</span> to confirm
            </Label>
            <Input
              id="confirm-name"
              value={confirmName}
              onChange={(e) => setConfirmName(e.target.value)}
              placeholder={workspace.name}
            />
          </div>
        </div>
        <AlertDialogFooter>
          <Button variant="outline" onClick={() => onOpenChange(false)}>
            Cancel
          </Button>
          <Button
            variant="destructive"
            onClick={handleDelete}
            disabled={confirmName !== workspace.name || deleteMutation.isPending}
          >
            {deleteMutation.isPending ? 'Deleting...' : 'Delete Workspace'}
          </Button>
        </AlertDialogFooter>
      </AlertDialogContent>
    </AlertDialog>
  )
}
```

### Testing

**Unit Test - Workspace Service:**
```python
# backend/tests/unit/services/test_workspace_service.py
import pytest
from app.services.workspace_service import WorkspaceService
from app.models.workspace_member import RoleEnum

@pytest.mark.asyncio
async def test_create_workspace_adds_creator_as_admin(db_session, test_user):
    service = WorkspaceService(db_session)
    workspace = await service.create_workspace("Test Workspace", test_user.id)

    assert workspace.name == "Test Workspace"
    assert workspace.created_by == test_user.id

    # Check admin membership created
    membership = await db_session.execute(
        select(WorkspaceMember).where(
            WorkspaceMember.workspace_id == workspace.id,
            WorkspaceMember.user_id == test_user.id
        )
    )
    member = membership.scalar_one_or_none()
    assert member is not None
    assert member.role == RoleEnum.ADMIN
```

**Integration Test - API Endpoints:**
```python
# backend/tests/integration/test_workspaces_api.py
import pytest
from httpx import AsyncClient

@pytest.mark.asyncio
async def test_create_workspace(client: AsyncClient, auth_headers):
    response = await client.post(
        "/workspaces",
        json={"name": "My Workspace"},
        headers=auth_headers
    )
    assert response.status_code == 201
    data = response.json()
    assert data["name"] == "My Workspace"
    assert "id" in data

@pytest.mark.asyncio
async def test_delete_workspace_requires_admin(client: AsyncClient, test_workspace, member_headers):
    response = await client.delete(
        f"/workspaces/{test_workspace.id}",
        headers=member_headers  # Non-admin user
    )
    assert response.status_code == 403
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-23 | 1.0 | Initial story creation from PRD Epic 2 Story 2.1 | Sarah (PO Agent) |

---

## Dev Agent Record

### Agent Model Used
*To be populated by development agent*

### Debug Log References
*To be populated by development agent*

### Completion Notes List
*To be populated by development agent*

### File List
*To be populated by development agent*

---

## QA Results
*To be populated by QA agent after implementation review*
