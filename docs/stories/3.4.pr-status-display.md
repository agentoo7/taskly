# Story 3.4: PR Status Display on Cards

## Status
Draft

---

## Story

**As a** team member,
**I want** to see PR status and CI results directly on cards,
**so that** I know which tasks are ready to merge without leaving the board.

---

## Acceptance Criteria

1. Card shows PR state badge: "Open" (blue), "Merged" (purple), "Closed" (gray), "Draft" (gray dashed)
2. CI status indicator displays next to PR: green checkmark (passing), red X (failing), yellow circle (pending)
3. Clicking CI indicator shows dropdown with individual check details: check name, status, conclusion, URL
4. PR approval count displayed: "2/2 approvals" if required reviews met, "1/2 approvals" if pending
5. Mergeable state shown: "Ready to merge" (green), "Conflicts" (red), "Checks pending" (yellow)
6. Webhook `check_suite` and `pull_request_review` events update PR status in real-time
7. PR status data stored in `pull_requests.ci_status` JSONB field
8. Card in board view shows CI status icon if PR exists (small icon, not text)
9. Hovering over CI icon shows tooltip: "CI: 3 passing, 1 failing"
10. PR merged within last 24 hours shows celebration animation on card (confetti or sparkle)
11. Stale PRs (open >7 days, no activity) show "Stale" warning badge
12. PR metrics displayed: commits count, changed files count, +additions/-deletions

---

## Tasks / Subtasks

- [ ] **Task 1: Update PullRequest model** (AC: 7)
  - [ ] Add `ci_status` JSONB field for check results
  - [ ] Add `mergeable` field (boolean)
  - [ ] Add `approval_count` integer
  - [ ] Add `commit_count`, `changed_files`, `additions`, `deletions`

- [ ] **Task 2: Create CI status sync endpoints** (AC: 6)
  - [ ] Handle `check_suite` webhook events
  - [ ] Handle `pull_request_review` webhook events
  - [ ] Update PR ci_status and approval_count

- [ ] **Task 3: Add PR status UI components** (AC: 1, 2, 4, 5)
  - [ ] Create PR state badge component
  - [ ] Create CI status indicator component
  - [ ] Create approval count display
  - [ ] Create mergeable status indicator

- [ ] **Task 4: Add CI status to board cards** (AC: 8, 9)
  - [ ] Show small CI icon on card if PR exists
  - [ ] Icon color: green/red/yellow based on status
  - [ ] Tooltip shows check summary

- [ ] **Task 5: Implement PR merged animation** (AC: 10)
  - [ ] Detect PR merged in last 24 hours
  - [ ] Show confetti animation using canvas-confetti library
  - [ ] Animation triggers once per merge event

- [ ] **Task 6: Write tests** (AC: 1-12)
  - [ ] Integration test: Webhook updates CI status
  - [ ] Component test: PR status badges display correctly

---

## Dev Notes

### CI Status Data Structure

```python
# Example ci_status JSONB field
{
    "status": "success",  # success, failure, pending, neutral
    "checks": [
        {
            "name": "Build",
            "status": "completed",
            "conclusion": "success",
            "url": "https://github.com/..."
        },
        {
            "name": "Tests",
            "status": "completed",
            "conclusion": "failure",
            "url": "https://github.com/..."
        }
    ]
}
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-23 | 1.0 | Initial story creation from PRD Epic 3 Story 3.4 | Sarah (PO Agent) |
