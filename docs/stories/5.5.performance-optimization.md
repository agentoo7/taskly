# Story 5.5: Performance Optimization & Final Polish

## Status
Draft

---

## Story

**As a** user,
**I want** Taskly to feel fast and responsive at all times,
**so that** the tool doesn't slow me down during daily work.

---

## Acceptance Criteria

1. Page load performance: initial load <1 second (cached), <2 seconds (cold start) measured with Lighthouse performance score >90
2. View transitions: switching Kanban â†” Timeline completes in <500ms with smooth animation (no janky frames)
3. Large board performance: boards with 500+ cards render without lag using virtualization (only visible cards rendered in DOM)
4. Lazy loading: images (avatars, attachments) loaded on-demand with placeholder; below-fold content loaded after initial render
5. Optimistic UI: all user actions (card move, edit, delete) update UI immediately with API call in background; rollback on failure with error toast
6. Debouncing: search input, filters, and inline editing debounced at 300ms to reduce API calls during rapid typing
7. Caching strategy: frequently accessed data (boards list, user profile, workspace members) cached in frontend with 5-minute TTL; cache invalidated on updates
8. Bundle size optimization: frontend JavaScript bundle <500KB gzipped; code splitting by route (dashboard, board, settings as separate chunks)
9. Lighthouse PWA score >90: manifest file, service worker for offline fallback (shows "You're offline" message), app installable as PWA
10. Accessibility audit: WCAG 2.1 AA compliance verified with axe DevTools (0 critical violations, <5 minor issues)
11. Error boundaries: React error boundaries catch crashes and display user-friendly error page with "Reload" button (errors logged to Sentry)
12. Loading states: all asynchronous operations display skeleton loaders or spinners within 100ms (no blank screens)
13. Empty states: all empty data scenarios (no boards, no cards, no workspaces) show helpful empty state illustrations with clear CTAs
14. Final UI polish: consistent spacing (8px grid system), typography (single font stack), colors (design system with CSS variables), animations (200ms standard, 300ms complex)
15. Cross-browser testing: verified in Chrome, Firefox, Safari, Edge with no major visual or functional issues
16. Mobile responsive: all features functional on tablet (768px+) with touch-optimized interactions; mobile (<768px) shows streamlined read-only view with message "Full editing experience available on desktop"
17. Production monitoring: Sentry configured for error tracking, Datadog/Prometheus for metrics (API latency, page load times, error rates), uptime monitoring active

---

## Tasks / Subtasks

- [ ] **Task 1: Optimize page load performance** (AC: 1)
  - [ ] Run Lighthouse audit to identify bottlenecks
  - [ ] Optimize critical rendering path
  - [ ] Minimize main thread blocking time
  - [ ] Enable HTTP/2 and compression
  - [ ] Achieve Lighthouse performance score >90

- [ ] **Task 2: Optimize view transitions** (AC: 2)
  - [ ] Measure current transition times
  - [ ] Use CSS transforms for smooth animations
  - [ ] Avoid layout thrashing
  - [ ] Target 60fps during transitions
  - [ ] Complete transitions in <500ms

- [ ] **Task 3: Implement virtualization for large boards** (AC: 3)
  - [ ] Install @tanstack/react-virtual
  - [ ] Virtualize card lists in columns
  - [ ] Only render visible cards
  - [ ] Handle scrolling and dynamic heights
  - [ ] Test with 500+ card boards

- [ ] **Task 4: Add lazy loading** (AC: 4)
  - [ ] Lazy load images with next/image
  - [ ] Use loading="lazy" for avatars
  - [ ] Below-fold content loaded after initial render
  - [ ] Show placeholder while loading

- [ ] **Task 5: Implement optimistic UI** (AC: 5)
  - [ ] Update UI immediately on user action
  - [ ] API call in background
  - [ ] Rollback on failure with error toast
  - [ ] Apply to card moves, edits, deletes

- [ ] **Task 6: Add debouncing** (AC: 6)
  - [ ] Create `use-debounced-value` hook
  - [ ] Debounce search input at 300ms
  - [ ] Debounce filters at 300ms
  - [ ] Debounce inline editing at 300ms

- [ ] **Task 7: Implement caching strategy** (AC: 7)
  - [ ] Configure TanStack Query cache
  - [ ] 5-minute TTL for boards list, user profile, workspace members
  - [ ] Invalidate cache on updates
  - [ ] Use staleTime and cacheTime settings

- [ ] **Task 8: Optimize bundle size** (AC: 8)
  - [ ] Analyze bundle with webpack-bundle-analyzer
  - [ ] Code split by route using Next.js dynamic imports
  - [ ] Tree-shake unused code
  - [ ] Target <500KB gzipped
  - [ ] Split dashboard, board, settings into separate chunks

- [ ] **Task 9: Implement PWA features** (AC: 9)
  - [ ] Create manifest.json
  - [ ] Add service worker for offline fallback
  - [ ] Show "You're offline" message
  - [ ] Make app installable
  - [ ] Achieve Lighthouse PWA score >90

- [ ] **Task 10: Accessibility audit** (AC: 10)
  - [ ] Install axe DevTools
  - [ ] Run accessibility audit
  - [ ] Fix critical violations (target 0)
  - [ ] Fix minor issues (target <5)
  - [ ] Ensure WCAG 2.1 AA compliance

- [ ] **Task 11: Add error boundaries** (AC: 11)
  - [ ] Create error boundary component
  - [ ] Wrap app with error boundary
  - [ ] Display user-friendly error page
  - [ ] Add "Reload" button
  - [ ] Log errors to Sentry

- [ ] **Task 12: Implement loading states** (AC: 12)
  - [ ] Create skeleton loader components
  - [ ] Show within 100ms of async operation
  - [ ] Apply to all data fetching
  - [ ] No blank screens

- [ ] **Task 13: Design empty states** (AC: 13)
  - [ ] Create empty state components
  - [ ] Illustrations for no boards, no cards, no workspaces
  - [ ] Clear CTAs ("Create Board", etc.)
  - [ ] Helpful onboarding text

- [ ] **Task 14: Final UI polish** (AC: 14)
  - [ ] Enforce 8px grid system for spacing
  - [ ] Standardize typography (font stack)
  - [ ] Define color system with CSS variables
  - [ ] Standardize animations (200ms/300ms)
  - [ ] Consistency audit across all pages

- [ ] **Task 15: Cross-browser testing** (AC: 15)
  - [ ] Test in Chrome, Firefox, Safari, Edge
  - [ ] Fix visual inconsistencies
  - [ ] Fix functional issues
  - [ ] Verify no major bugs

- [ ] **Task 16: Mobile responsive design** (AC: 16)
  - [ ] Test on tablet (768px+)
  - [ ] Touch-optimized interactions
  - [ ] Mobile (<768px) read-only view
  - [ ] Message: "Full editing available on desktop"

- [ ] **Task 17: Setup production monitoring** (AC: 17)
  - [ ] Configure Sentry for error tracking
  - [ ] Setup Datadog/Prometheus for metrics
  - [ ] Track API latency, page load times, error rates
  - [ ] Configure uptime monitoring
  - [ ] Setup alerts for critical issues

---

## Dev Notes

### Virtualization for Large Boards

```typescript
// frontend/src/components/board/virtualized-column.tsx
'use client'

import { useVirtualizer } from '@tanstack/react-virtual'
import { useRef } from 'react'
import { Card } from './card'

export function VirtualizedColumn({ cards, columnId }: any) {
  const parentRef = useRef<HTMLDivElement>(null)

  const virtualizer = useVirtualizer({
    count: cards.length,
    getScrollElement: () => parentRef.current,
    estimateSize: () => 100, // Estimated card height
    overscan: 5, // Render 5 extra cards above/below viewport
  })

  return (
    <div
      ref={parentRef}
      className="h-full overflow-y-auto"
      style={{ contain: 'strict' }}
    >
      <div
        style={{
          height: `${virtualizer.getTotalSize()}px`,
          width: '100%',
          position: 'relative',
        }}
      >
        {virtualizer.getVirtualItems().map((virtualItem) => {
          const card = cards[virtualItem.index]
          return (
            <div
              key={card.id}
              style={{
                position: 'absolute',
                top: 0,
                left: 0,
                width: '100%',
                height: `${virtualItem.size}px`,
                transform: `translateY(${virtualItem.start}px)`,
              }}
            >
              <Card card={card} />
            </div>
          )
        })}
      </div>
    </div>
  )
}
```

### Optimistic UI Updates

```typescript
// frontend/src/hooks/use-optimistic-card-update.ts
import { useMutation, useQueryClient } from '@tanstack/react-query'
import { api } from '@/lib/api/client'
import { toast } from 'sonner'

export function useOptimisticCardUpdate(boardId: string) {
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: ({ cardId, updates }: any) =>
      api.patch(`/cards/${cardId}`, updates),

    // Optimistic update
    onMutate: async ({ cardId, updates }) => {
      // Cancel outgoing refetches
      await queryClient.cancelQueries({ queryKey: ['board', boardId] })

      // Snapshot previous value
      const previousBoard = queryClient.getQueryData(['board', boardId])

      // Optimistically update
      queryClient.setQueryData(['board', boardId], (old: any) => {
        if (!old) return old
        return {
          ...old,
          columns: old.columns.map((column: any) => ({
            ...column,
            cards: column.cards.map((card: any) =>
              card.id === cardId ? { ...card, ...updates } : card
            ),
          })),
        }
      })

      return { previousBoard }
    },

    // Rollback on error
    onError: (err, variables, context) => {
      if (context?.previousBoard) {
        queryClient.setQueryData(['board', boardId], context.previousBoard)
      }
      toast.error('Failed to update card')
    },

    // Refetch on success
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['board', boardId] })
    },
  })
}
```

### Debounce Hook

```typescript
// frontend/src/hooks/use-debounced-value.ts
import { useEffect, useState } from 'react'

export function useDebouncedValue<T>(value: T, delay: number = 300): T {
  const [debouncedValue, setDebouncedValue] = useState<T>(value)

  useEffect(() => {
    const handler = setTimeout(() => {
      setDebouncedValue(value)
    }, delay)

    return () => {
      clearTimeout(handler)
    }
  }, [value, delay])

  return debouncedValue
}

// Usage
const [search, setSearch] = useState('')
const debouncedSearch = useDebouncedValue(search, 300)

useEffect(() => {
  // API call with debounced value
  fetchCards(debouncedSearch)
}, [debouncedSearch])
```

### TanStack Query Cache Configuration

```typescript
// frontend/src/lib/query-client.ts
import { QueryClient } from '@tanstack/react-query'

export const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 5 * 60 * 1000, // 5 minutes
      cacheTime: 10 * 60 * 1000, // 10 minutes
      refetchOnWindowFocus: false,
      retry: 1,
    },
  },
})

// Specific cache configurations
export const cacheConfigs = {
  boardsList: {
    queryKey: ['boards'],
    staleTime: 5 * 60 * 1000,
  },
  userProfile: {
    queryKey: ['user'],
    staleTime: 5 * 60 * 1000,
  },
  workspaceMembers: {
    queryKey: ['workspace-members'],
    staleTime: 5 * 60 * 1000,
  },
}
```

### Bundle Analysis

```json
// package.json
{
  "scripts": {
    "analyze": "ANALYZE=true next build",
    "build": "next build"
  },
  "devDependencies": {
    "@next/bundle-analyzer": "^14.1.0"
  }
}
```

```javascript
// next.config.js
const withBundleAnalyzer = require('@next/bundle-analyzer')({
  enabled: process.env.ANALYZE === 'true',
})

module.exports = withBundleAnalyzer({
  // ... other config
})
```

### PWA Configuration

```json
// public/manifest.json
{
  "name": "Taskly - Git-Native Project Management",
  "short_name": "Taskly",
  "description": "Move a Card, Ship the Code",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#ffffff",
  "theme_color": "#0366d6",
  "icons": [
    {
      "src": "/icons/icon-192.png",
      "sizes": "192x192",
      "type": "image/png"
    },
    {
      "src": "/icons/icon-512.png",
      "sizes": "512x512",
      "type": "image/png"
    }
  ]
}
```

```typescript
// public/service-worker.js
self.addEventListener('install', (event) => {
  event.waitUntil(
    caches.open('taskly-v1').then((cache) => {
      return cache.addAll([
        '/',
        '/offline.html',
      ])
    })
  )
})

self.addEventListener('fetch', (event) => {
  event.respondWith(
    fetch(event.request).catch(() => {
      return caches.match('/offline.html')
    })
  )
})
```

### Error Boundary

```typescript
// frontend/src/components/error-boundary.tsx
'use client'

import { Component, ReactNode } from 'react'
import * as Sentry from '@sentry/nextjs'
import { Button } from '@/components/ui/button'

interface Props {
  children: ReactNode
}

interface State {
  hasError: boolean
  error?: Error
}

export class ErrorBoundary extends Component<Props, State> {
  constructor(props: Props) {
    super(props)
    this.state = { hasError: false }
  }

  static getDerivedStateFromError(error: Error): State {
    return { hasError: true, error }
  }

  componentDidCatch(error: Error, errorInfo: any) {
    Sentry.captureException(error, { contexts: { react: errorInfo } })
  }

  render() {
    if (this.state.hasError) {
      return (
        <div className="flex items-center justify-center min-h-screen">
          <div className="text-center space-y-4">
            <h1 className="text-2xl font-bold">Something went wrong</h1>
            <p className="text-muted-foreground">
              We've been notified and will fix this soon.
            </p>
            <Button onClick={() => window.location.reload()}>
              Reload Page
            </Button>
          </div>
        </div>
      )
    }

    return this.props.children
  }
}
```

### Skeleton Loaders

```typescript
// frontend/src/components/ui/skeleton.tsx
export function CardSkeleton() {
  return (
    <div className="rounded-lg border bg-card p-3 space-y-2 animate-pulse">
      <div className="h-4 bg-muted rounded w-3/4" />
      <div className="h-3 bg-muted rounded w-1/2" />
      <div className="flex gap-2">
        <div className="h-6 w-6 bg-muted rounded-full" />
        <div className="h-6 w-6 bg-muted rounded-full" />
      </div>
    </div>
  )
}

export function BoardSkeleton() {
  return (
    <div className="flex gap-4 p-6">
      {[1, 2, 3, 4].map((i) => (
        <div key={i} className="w-80 space-y-4">
          <div className="h-8 bg-muted rounded w-1/2 animate-pulse" />
          <div className="space-y-2">
            {[1, 2, 3].map((j) => (
              <CardSkeleton key={j} />
            ))}
          </div>
        </div>
      ))}
    </div>
  )
}
```

### Empty States

```typescript
// frontend/src/components/empty-states/no-boards.tsx
import { Button } from '@/components/ui/button'
import { PlusIcon } from 'lucide-react'

export function NoBoardsEmptyState({ onCreateBoard }: any) {
  return (
    <div className="flex flex-col items-center justify-center min-h-[400px] text-center">
      <div className="w-64 h-64 mb-6">
        {/* Illustration SVG */}
        <svg viewBox="0 0 200 200" className="w-full h-full text-muted-foreground/20">
          {/* Simple board illustration */}
        </svg>
      </div>
      <h2 className="text-2xl font-bold mb-2">No boards yet</h2>
      <p className="text-muted-foreground mb-6 max-w-md">
        Boards help you organize your work. Create your first board to get started.
      </p>
      <Button onClick={onCreateBoard}>
        <PlusIcon className="mr-2 h-4 w-4" />
        Create Board
      </Button>
    </div>
  )
}
```

### Sentry Configuration

```typescript
// sentry.client.config.ts
import * as Sentry from '@sentry/nextjs'

Sentry.init({
  dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,
  tracesSampleRate: 0.1,
  environment: process.env.NODE_ENV,
  enabled: process.env.NODE_ENV === 'production',
})
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-23 | 1.0 | Initial story creation from PRD Epic 5 Story 5.5 | Sarah (PO Agent) |

---

## Dev Agent Record

### Agent Model Used
*To be populated by development agent*

### Debug Log References
*To be populated by development agent*

### Completion Notes List
*To be populated by development agent*

### File List
*To be populated by development agent*

---

## QA Results
*To be populated by QA agent after implementation review*
