# Story 3.2: One-Click Branch Creation from Card

## Status
Draft

---

## Story

**As a** developer,
**I want** to create Git branches directly from cards with one click,
**so that** I can quickly start work without leaving the board.

---

## Acceptance Criteria

1. Card detail modal displays "Create Branch" button if board has default repository configured
2. Button disabled with tooltip if no default repository set: "Configure default repository in board settings"
3. Clicking button shows branch name suggestion: `{card-id}-{slugified-title}` (e.g., `card-123-fix-authentication-bug`)
4. Branch name editable inline before creation, validates format (alphanumeric, hyphens, slashes allowed)
5. Dropdown allows selecting base branch (defaults to repository's default branch, shows all branches)
6. Creating branch calls GitHub API to create ref, stores branch name in card metadata
7. Card displays "Branch" badge with branch name after creation, clicking opens GitHub branch page in new tab
8. If branch already exists on GitHub, shows error: "Branch already exists. Use existing branch or choose different name."
9. Branch creation adds activity entry: "[User] created branch [branch-name]"
10. Branch creation happens asynchronously via Celery task (non-blocking), shows loading state
11. Success notification: "Branch created: [branch-name]" with link to GitHub
12. Error handling: GitHub API errors (auth failed, repo archived, no permissions) show user-friendly messages

---

## Tasks / Subtasks

- [ ] **Task 1: Add branch metadata to Card model** (AC: 6, 7)
  - [ ] Update `cards.metadata` JSONB to include `branch_name` field
  - [ ] Add `repository_id` field to Card model (FK to GitRepository)
  - [ ] Create migration for schema changes
  - [ ] Allow multiple branches per card (store array in metadata for future)

- [ ] **Task 2: Create branch creation API endpoint** (AC: 3, 4, 5, 6, 8)
  - [ ] Implement `POST /cards/{id}/branch` - create branch from card
  - [ ] Accept: `branch_name` (string), `base_branch` (string, default: repo default)
  - [ ] Validate branch name format: alphanumeric, hyphens, slashes only
  - [ ] Enqueue Celery task for async branch creation
  - [ ] Return task ID for status polling

- [ ] **Task 3: Create branch creation Celery task** (AC: 6, 8, 9, 10, 11, 12)
  - [ ] Create `backend/app/tasks/create_branch_task.py`
  - [ ] Task accepts: card_id, branch_name, base_branch, user_id
  - [ ] Fetch card and repository from database
  - [ ] Call GitHub API: `POST /repos/{owner}/{repo}/git/refs`
  - [ ] Create ref: `refs/heads/{branch_name}` from base branch SHA
  - [ ] On success: update card.metadata with branch_name, log activity
  - [ ] On error: log error, send failure notification
  - [ ] Broadcast WebSocket event on completion

- [ ] **Task 4: Implement GitHub branch creation** (AC: 6, 8)
  - [ ] Use PyGithub or httpx to call GitHub API
  - [ ] Get base branch SHA: `GET /repos/{owner}/{repo}/git/ref/heads/{base_branch}`
  - [ ] Create new branch: `POST /repos/{owner}/{repo}/git/refs` with ref and SHA
  - [ ] Handle errors: branch exists (409), authentication failed (401), no permissions (403)
  - [ ] Retry on transient errors (502, 503) with exponential backoff
  - [ ] Return branch URL: `https://github.com/{owner}/{repo}/tree/{branch_name}`

- [ ] **Task 5: Add "Create Branch" button to card detail modal** (AC: 1, 2)
  - [ ] Update `frontend/src/components/board/card-detail-modal.tsx`
  - [ ] Add "Create Branch" button in actions section
  - [ ] Show only if board.default_repository_id is set
  - [ ] If not set, show disabled button with tooltip
  - [ ] On click, open branch creation dialog

- [ ] **Task 6: Create branch creation dialog component** (AC: 3, 4, 5)
  - [ ] Create `frontend/src/components/board/create-branch-dialog.tsx`
  - [ ] Generate suggested branch name from card ID and title
  - [ ] Slugify title: lowercase, replace spaces with hyphens, remove special chars
  - [ ] Show editable input with suggestion pre-filled
  - [ ] Add base branch selector dropdown (fetch branches from GitHub)
  - [ ] Validate branch name: show error if invalid characters
  - [ ] "Create Branch" button calls API endpoint

- [ ] **Task 7: Implement branch name generation** (AC: 3, 4)
  - [ ] Create utility function: `generateBranchName(cardId, title)`
  - [ ] Format: `card-{id}-{slugified-title}`
  - [ ] Slugify: convert to lowercase, replace spaces with `-`, remove special chars
  - [ ] Max length: 100 characters (truncate title if needed)
  - [ ] Example: "Fix Authentication Bug" â†’ `card-123-fix-authentication-bug`

- [ ] **Task 8: Add branch badge to card** (AC: 7)
  - [ ] Update `BoardCard` component to show branch badge if branch exists
  - [ ] Display: Git branch icon + branch name
  - [ ] Clicking badge opens GitHub branch URL in new tab
  - [ ] Badge color: blue to distinguish from labels
  - [ ] Show in card detail modal as well

- [ ] **Task 9: Implement async branch creation with loading state** (AC: 10, 11)
  - [ ] Call `POST /cards/{id}/branch` API endpoint
  - [ ] Show loading spinner in dialog while task executes
  - [ ] Poll task status using task ID (or use WebSocket for updates)
  - [ ] On success: close dialog, show success toast with GitHub link
  - [ ] On error: show error message in dialog, allow retry
  - [ ] Update card data in TanStack Query cache

- [ ] **Task 10: Add branch activity logging** (AC: 9)
  - [ ] When branch created successfully, log CardActivity
  - [ ] Action: `branch_created`
  - [ ] Metadata: `{"branch_name": "card-123-fix-bug", "repository": "owner/repo"}`
  - [ ] Display in activity timeline: "[User] created branch [branch-name]"
  - [ ] Include link to GitHub branch in activity description

- [ ] **Task 11: Handle branch creation errors** (AC: 8, 12)
  - [ ] If branch already exists, show specific error message
  - [ ] Suggest using existing branch or choosing different name
  - [ ] If no permissions, show: "You don't have push access to this repository"
  - [ ] If GitHub API down, show: "GitHub is temporarily unavailable. Try again later."
  - [ ] Log all errors to Sentry for monitoring

- [ ] **Task 12: Add branch deletion (cleanup)** (AC: cleanup)
  - [ ] Add "Delete Branch" option in card menu (if branch exists)
  - [ ] Requires confirmation: "Delete branch [branch-name] from GitHub?"
  - [ ] Call GitHub API: `DELETE /repos/{owner}/{repo}/git/refs/heads/{branch_name}`
  - [ ] Clear branch_name from card.metadata
  - [ ] Log activity: "deleted branch [branch-name]"

- [ ] **Task 13: Write tests for branch creation** (AC: 1-12)
  - [ ] Unit test: Branch name generation and slugification
  - [ ] Unit test: Branch name validation
  - [ ] Integration test: Create branch API endpoint
  - [ ] Integration test: GitHub API integration (mocked)
  - [ ] Component test: Branch creation dialog
  - [ ] E2E test: Full branch creation workflow

---

## Dev Notes

### Branch Name Generation

```python
# backend/app/utils/branch_helpers.py
import re

def generate_branch_name(card_id: str, title: str) -> str:
    """Generate branch name from card ID and title."""
    # Slugify title
    slug = title.lower()
    slug = re.sub(r'[^a-z0-9\s-]', '', slug)  # Remove special chars
    slug = re.sub(r'\s+', '-', slug)  # Replace spaces with hyphens
    slug = re.sub(r'-+', '-', slug)  # Collapse multiple hyphens
    slug = slug.strip('-')  # Remove leading/trailing hyphens

    # Truncate if too long
    max_title_length = 50
    if len(slug) > max_title_length:
        slug = slug[:max_title_length].rsplit('-', 1)[0]  # Cut at word boundary

    return f"card-{card_id}-{slug}"

def validate_branch_name(name: str) -> bool:
    """Validate Git branch name format."""
    # Git branch name rules
    pattern = r'^[a-zA-Z0-9._\-/]+$'
    if not re.match(pattern, name):
        return False

    # Cannot start with -, ., or /
    if name[0] in ['-', '.', '/']:
        return False

    # Cannot end with .lock
    if name.endswith('.lock'):
        return False

    return True
```

### Celery Task for Branch Creation

```python
# backend/app/tasks/create_branch_task.py
from celery import shared_task
from github import Github, GithubException
from app.core.database import AsyncSessionLocal
from app.models.card import Card
from app.models.git_repository import GitRepository
from app.models.user import User
from app.services.activity_service import ActivityService
from sqlalchemy import select
import asyncio

@shared_task(bind=True, max_retries=3)
def create_branch_task(self, card_id: str, branch_name: str, base_branch: str, user_id: str):
    """Create Git branch from card asynchronously."""
    return asyncio.run(_create_branch(card_id, branch_name, base_branch, user_id))

async def _create_branch(card_id: str, branch_name: str, base_branch: str, user_id: str):
    async with AsyncSessionLocal() as db:
        # Fetch card and repository
        card = await db.get(Card, card_id)
        if not card:
            return {"error": "Card not found"}

        board = await db.get(Board, card.board_id)
        if not board.default_repository_id:
            return {"error": "No default repository configured"}

        repo = await db.get(GitRepository, board.default_repository_id)
        user = await db.get(User, user_id)

        try:
            # Create branch on GitHub
            g = Github(user.github_access_token)
            gh_repo = g.get_repo(repo.full_name)

            # Get base branch SHA
            base_ref = gh_repo.get_git_ref(f"heads/{base_branch}")
            base_sha = base_ref.object.sha

            # Create new branch
            gh_repo.create_git_ref(
                ref=f"refs/heads/{branch_name}",
                sha=base_sha
            )

            # Update card metadata
            if not card.metadata:
                card.metadata = {}
            card.metadata['branch_name'] = branch_name
            card.repository_id = repo.id

            # Log activity
            activity_service = ActivityService(db)
            await activity_service.log_activity(
                card_id=card.id,
                user_id=user.id,
                action="branch_created",
                metadata={
                    "branch_name": branch_name,
                    "repository": repo.full_name,
                    "base_branch": base_branch
                }
            )

            await db.commit()

            return {
                "success": True,
                "branch_name": branch_name,
                "branch_url": f"https://github.com/{repo.full_name}/tree/{branch_name}"
            }

        except GithubException as e:
            if e.status == 422:  # Branch already exists
                return {"error": "Branch already exists"}
            elif e.status == 403:
                return {"error": "No permission to create branch"}
            else:
                return {"error": f"GitHub error: {e.data.get('message', 'Unknown error')}"}
```

### Frontend Branch Creation Dialog

```typescript
// frontend/src/components/board/create-branch-dialog.tsx
'use client'

import { useState, useEffect } from 'react'
import { useMutation, useQueryClient } from '@tanstack/react-query'
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select'
import { GitBranch, ExternalLink } from 'lucide-react'
import { api } from '@/lib/api/client'
import { toast } from 'sonner'

function slugify(text: string): string {
  return text
    .toLowerCase()
    .replace(/[^a-z0-9\s-]/g, '')
    .replace(/\s+/g, '-')
    .replace(/-+/g, '-')
    .replace(/^-+|-+$/g, '')
    .slice(0, 50)
}

function generateBranchName(cardId: string, title: string): string {
  const slug = slugify(title)
  return `card-${cardId}-${slug}`
}

interface CreateBranchDialogProps {
  card: any
  open: boolean
  onOpenChange: (open: boolean) => void
}

export function CreateBranchDialog({ card, open, onOpenChange }: CreateBranchDialogProps) {
  const [branchName, setBranchName] = useState('')
  const [baseBranch, setBaseBranch] = useState('main')
  const queryClient = useQueryClient()

  useEffect(() => {
    if (open && card) {
      const suggested = generateBranchName(card.id.slice(0, 8), card.title)
      setBranchName(suggested)
    }
  }, [open, card])

  const createMutation = useMutation({
    mutationFn: () =>
      api.post(`/cards/${card.id}/branch`, {
        branch_name: branchName,
        base_branch: baseBranch,
      }),
    onSuccess: (data) => {
      if (data.error) {
        toast.error(data.error)
      } else {
        toast.success(
          <div className="flex items-center gap-2">
            <span>Branch created: {data.branch_name}</span>
            <a
              href={data.branch_url}
              target="_blank"
              rel="noopener noreferrer"
              className="underline flex items-center gap-1"
            >
              View on GitHub
              <ExternalLink className="h-3 w-3" />
            </a>
          </div>
        )
        queryClient.invalidateQueries({ queryKey: ['cards', card.id] })
        onOpenChange(false)
      }
    },
    onError: () => {
      toast.error('Failed to create branch')
    },
  })

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Create Branch</DialogTitle>
          <DialogDescription>
            Create a new Git branch for this card. You can start working immediately.
          </DialogDescription>
        </DialogHeader>

        <div className="grid gap-4 py-4">
          <div className="grid gap-2">
            <Label htmlFor="branch-name">Branch Name</Label>
            <div className="flex items-center gap-2">
              <GitBranch className="h-4 w-4 text-muted-foreground" />
              <Input
                id="branch-name"
                value={branchName}
                onChange={(e) => setBranchName(e.target.value)}
                placeholder="card-123-fix-bug"
              />
            </div>
          </div>

          <div className="grid gap-2">
            <Label htmlFor="base-branch">Base Branch</Label>
            <Select value={baseBranch} onValueChange={setBaseBranch}>
              <SelectTrigger>
                <SelectValue />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="main">main</SelectItem>
                <SelectItem value="develop">develop</SelectItem>
              </SelectContent>
            </Select>
          </div>
        </div>

        <DialogFooter>
          <Button variant="outline" onClick={() => onOpenChange(false)}>
            Cancel
          </Button>
          <Button
            onClick={() => createMutation.mutate()}
            disabled={createMutation.isPending || !branchName}
          >
            {createMutation.isPending ? 'Creating...' : 'Create Branch'}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  )
}
```

### Testing

**Unit Test - Branch Name Generation:**
```python
def test_generate_branch_name():
    result = generate_branch_name("abc123", "Fix Authentication Bug")
    assert result == "card-abc123-fix-authentication-bug"

    result = generate_branch_name("xyz789", "Add   New  Feature!!!")
    assert result == "card-xyz789-add-new-feature"
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-23 | 1.0 | Initial story creation from PRD Epic 3 Story 3.2 | Sarah (PO Agent) |

---

## Dev Agent Record

### Agent Model Used
*To be populated by development agent*

### Debug Log References
*To be populated by development agent*

### Completion Notes List
*To be populated by development agent*

### File List
*To be populated by development agent*

---

## QA Results
*To be populated by QA agent after implementation review*
