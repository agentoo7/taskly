# Story 2.3: Board Creation & Column Customization

## Status
Draft

---

## Story

**As a** workspace member,
**I want** to create boards with customizable columns,
**so that** I can organize cards according to my team's workflow.

---

## Acceptance Criteria

1. Workspace dashboard displays "Create Board" button accessible to all workspace members
2. Clicking button opens board creation modal with fields: board name (required, max 100 chars), template selector (optional)
3. Template selector offers: "Blank Board", "Default Kanban" (pre-populated with To Do, In Progress, In Review, Done columns)
4. Submitting form creates board and redirects to board view showing empty columns
5. Board view displays board name as header with edit icon (clicking opens inline rename input)
6. Column headers display column name with hover actions: "Add Card", "Edit Column", "Delete Column", drag handle icon
7. "Add Column" button displayed at end of columns list (creates new column with placeholder name "New Column" and auto-focuses rename input)
8. Columns editable by clicking name (inline input appears, updates on blur or Enter key)
9. Columns draggable to reorder (drag column header left/right, visual drop indicator shows target position)
10. Deleting column requires confirmation if column contains cards: "Delete column and X cards inside?" with options "Move cards to another column" or "Delete cards"
11. Board persists column configuration in `boards.columns` JSONB field as array: `[{id: uuid, name: string, position: int}]`
12. Board list in workspace dashboard shows board cards with: board name, last updated timestamp, card count, members avatars (up to 5, +N indicator if more)
13. Clicking board card in workspace dashboard navigates to board view
14. Board settings accessible via gear icon in board header showing: board name (editable), archive board, delete board options
15. Archived boards hidden from main board list but accessible via "Show Archived" toggle in workspace dashboard
16. Deleting board requires confirmation and cascades deletion to all cards

---

## Tasks / Subtasks

- [ ] **Task 1: Create board API endpoints** (AC: 1, 2, 3, 4, 14, 15, 16)
  - [ ] Create `backend/app/api/boards.py` router
  - [ ] Implement `POST /workspaces/{id}/boards` - create new board
  - [ ] Implement `GET /workspaces/{id}/boards` - list workspace boards
  - [ ] Implement `GET /boards/{id}` - get board with columns and cards
  - [ ] Implement `PATCH /boards/{id}` - update board name or columns
  - [ ] Implement `DELETE /boards/{id}` - delete board (requires confirmation)
  - [ ] Add permission check: user must be workspace member
  - [ ] Support archived filter in list endpoint

- [ ] **Task 2: Create board service layer** (AC: 3, 11, 16)
  - [ ] Create `backend/app/services/board_service.py`
  - [ ] Implement `create_board(workspace_id, name, template)` - creates board with optional template
  - [ ] Implement default templates: blank (empty array), kanban (4 default columns)
  - [ ] Generate UUIDs for column IDs
  - [ ] Implement `update_columns(board_id, columns)` - validates and updates JSONB
  - [ ] Implement `delete_board(board_id, user_id)` - cascades to cards
  - [ ] Add transaction management for critical operations

- [ ] **Task 3: Create board Pydantic schemas** (AC: 2, 11)
  - [ ] Create `backend/app/schemas/board.py`
  - [ ] Define `ColumnSchema`: id (UUID), name (str), position (int)
  - [ ] Define `BoardCreate`: name (str max 100), template (enum: blank, kanban)
  - [ ] Define `BoardUpdate`: name (Optional[str]), columns (Optional[list[ColumnSchema]])
  - [ ] Define `BoardResponse`: id, workspace_id, name, columns, archived, created_at, updated_at
  - [ ] Define `BoardDetailResponse`: includes cards list

- [ ] **Task 4: Create board creation modal in frontend** (AC: 1, 2, 3, 4)
  - [ ] Create `frontend/src/components/board/create-board-modal.tsx`
  - [ ] Add form: board name input (max 100 chars), template radio group
  - [ ] Template options: "Blank Board" (icon: empty), "Default Kanban" (icon: columns)
  - [ ] Show preview of selected template (column names)
  - [ ] On submit, call `POST /workspaces/{id}/boards`
  - [ ] Redirect to board view on success: `/workspaces/{workspaceId}/boards/{boardId}`
  - [ ] Use TanStack Query mutation with optimistic update

- [ ] **Task 5: Create board view page** (AC: 4, 5, 6, 13)
  - [ ] Create `frontend/src/app/(dashboard)/workspaces/[workspaceId]/boards/[boardId]/page.tsx`
  - [ ] Fetch board data: `useQuery({ queryKey: ['boards', boardId] })`
  - [ ] Display board name in header with inline edit on click
  - [ ] Render columns horizontally in flex container
  - [ ] Display column headers with actions (hover to show)
  - [ ] Add "+ Add Column" button at end of columns
  - [ ] Show empty state in empty columns: "Drag cards here or click + to add"
  - [ ] Make columns scrollable horizontally on overflow

- [ ] **Task 6: Implement column management UI** (AC: 6, 7, 8, 9, 10, 11)
  - [ ] Create `frontend/src/components/board/board-column.tsx`
  - [ ] Display column name with click-to-edit functionality
  - [ ] Show action buttons on hover: Edit (pencil), Delete (trash), drag handle
  - [ ] Implement inline edit: replace name with input, save on blur/Enter, cancel on Escape
  - [ ] Add "+ Add Card" button in column header (placeholder for Story 2.4)
  - [ ] Create "Add Column" button component that adds new column to end
  - [ ] Generate client-side UUID for new column before API call

- [ ] **Task 7: Implement column drag-and-drop reordering** (AC: 9)
  - [ ] Use @dnd-kit library for column reordering
  - [ ] Implement horizontal sortable container for columns
  - [ ] Show drag overlay with column preview during drag
  - [ ] Update column positions on drop
  - [ ] Call `PATCH /boards/{id}` with updated columns array
  - [ ] Use optimistic update: reorder immediately, rollback on error
  - [ ] Add visual drop indicator (vertical line between columns)

- [ ] **Task 8: Implement column deletion with confirmation** (AC: 10)
  - [ ] Create `frontend/src/components/board/delete-column-dialog.tsx`
  - [ ] Show card count in confirmation message if column not empty
  - [ ] Offer two options: "Move cards to another column" (dropdown), "Delete all cards"
  - [ ] If move cards selected, show dropdown of other columns
  - [ ] Call backend to update cards' column_id before deleting column
  - [ ] Remove column from board.columns array
  - [ ] Use optimistic update with rollback

- [ ] **Task 9: Update workspace dashboard with board list** (AC: 12, 13)
  - [ ] Update `frontend/src/app/(dashboard)/workspaces/[workspaceId]/page.tsx`
  - [ ] Fetch boards: `useQuery({ queryKey: ['workspaces', workspaceId, 'boards'] })`
  - [ ] Display boards as grid of cards (3 columns on desktop, 2 on tablet, 1 on mobile)
  - [ ] Each board card shows: name, last updated, card count, member avatars
  - [ ] Fetch card count and member list for each board (include in board list API response)
  - [ ] Click board card navigates to board view
  - [ ] Show "+ Create Board" button when boards exist (in addition to empty state)

- [ ] **Task 10: Create board settings page** (AC: 14, 15, 16)
  - [ ] Create `frontend/src/app/(dashboard)/workspaces/[workspaceId]/boards/[boardId]/settings/page.tsx`
  - [ ] Add settings button (gear icon) to board header
  - [ ] Display board name with inline edit
  - [ ] Add "Archive Board" toggle (sets archived = true)
  - [ ] Add "Delete Board" button in danger zone
  - [ ] Create delete confirmation modal with board name input
  - [ ] On delete, redirect to workspace dashboard
  - [ ] Invalidate boards query cache after delete

- [ ] **Task 11: Implement board archiving** (AC: 15)
  - [ ] Add `archived` boolean field to `PATCH /boards/{id}` endpoint
  - [ ] Filter archived boards from default board list
  - [ ] Add "Show Archived Boards" toggle to workspace dashboard
  - [ ] Display archived boards in separate section with "Archived" badge
  - [ ] Add "Unarchive" button to archived boards
  - [ ] Clicking archived board still navigates to board view (read-only mode)

- [ ] **Task 12: Add real-time board updates via WebSocket** (AC: 5, 8, 11)
  - [ ] Backend broadcasts `board_updated` event when board/columns change
  - [ ] Frontend WebSocket subscribes to board room on mount
  - [ ] On `board_updated`, invalidate board query cache
  - [ ] Display toast: "[User] renamed board to [New Name]"
  - [ ] Display toast: "[User] added column [Column Name]"
  - [ ] Auto-refresh board data without page reload

- [ ] **Task 13: Write tests for board management** (AC: 1-16)
  - [ ] Unit test: Board service creates board with template
  - [ ] Unit test: Column JSONB structure validation
  - [ ] Integration test: Create board API endpoint
  - [ ] Integration test: Update board columns (add, edit, delete, reorder)
  - [ ] Integration test: Archive and unarchive board
  - [ ] Integration test: Delete board cascades to cards
  - [ ] Component test: Board creation modal
  - [ ] Component test: Column drag-and-drop reordering
  - [ ] E2E test: Full board creation and column management workflow

---

## Dev Notes

### Board Model (Already Created in Story 1.3)

```python
# backend/app/models/board.py
class Board(Base):
    __tablename__ = "boards"

    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    workspace_id = Column(UUID(as_uuid=True), ForeignKey("workspaces.id", ondelete="CASCADE"), nullable=False)
    name = Column(String(100), nullable=False)
    columns = Column(JSONB, nullable=False, default=list)  # [{"id": "uuid", "name": "str", "position": int}]
    archived = Column(Boolean, default=False)
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    updated_at = Column(DateTime(timezone=True), server_default=func.now(), onupdate=func.now())

    # Relationships
    workspace = relationship("Workspace", back_populates="boards")
    cards = relationship("Card", back_populates="board", cascade="all, delete-orphan")
```

### Board Service with Templates

```python
# backend/app/services/board_service.py
from sqlalchemy.ext.asyncio import AsyncSession
from app.models.board import Board
from uuid import UUID, uuid4

BOARD_TEMPLATES = {
    "blank": [],
    "kanban": [
        {"id": str(uuid4()), "name": "To Do", "position": 0},
        {"id": str(uuid4()), "name": "In Progress", "position": 1},
        {"id": str(uuid4()), "name": "In Review", "position": 2},
        {"id": str(uuid4()), "name": "Done", "position": 3},
    ]
}

class BoardService:
    def __init__(self, db: AsyncSession):
        self.db = db

    async def create_board(self, workspace_id: UUID, name: str, template: str = "blank") -> Board:
        """Create board with optional template."""
        columns = BOARD_TEMPLATES.get(template, [])

        board = Board(
            workspace_id=workspace_id,
            name=name.strip(),
            columns=columns
        )
        self.db.add(board)
        await self.db.commit()
        await self.db.refresh(board)
        return board

    async def update_columns(self, board_id: UUID, columns: list[dict]) -> Board:
        """Update board columns configuration."""
        board = await self.db.get(Board, board_id)
        if not board:
            raise ValueError("Board not found")

        # Validate columns structure
        for i, col in enumerate(columns):
            if "id" not in col or "name" not in col:
                raise ValueError("Invalid column structure")
            col["position"] = i  # Ensure positions are sequential

        board.columns = columns
        await self.db.commit()
        await self.db.refresh(board)
        return board

    async def delete_board(self, board_id: UUID) -> None:
        """Delete board and all cards (cascade)."""
        board = await self.db.get(Board, board_id)
        if not board:
            raise ValueError("Board not found")

        await self.db.delete(board)
        await self.db.commit()
```

### Frontend Board Column Component

```typescript
// frontend/src/components/board/board-column.tsx
'use client'

import { useState } from 'react'
import { useSortable } from '@dnd-kit/sortable'
import { CSS } from '@dnd-kit/utilities'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { GripVertical, Plus, MoreVertical, Pencil, Trash2 } from 'lucide-react'
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu'

interface Column {
  id: string
  name: string
  position: number
}

interface BoardColumnProps {
  column: Column
  cardCount: number
  onRename: (columnId: string, newName: string) => void
  onDelete: (columnId: string) => void
}

export function BoardColumn({ column, cardCount, onRename, onDelete }: BoardColumnProps) {
  const [isEditing, setIsEditing] = useState(false)
  const [name, setName] = useState(column.name)

  const {
    attributes,
    listeners,
    setNodeRef,
    transform,
    transition,
    isDragging,
  } = useSortable({ id: column.id })

  const style = {
    transform: CSS.Transform.toString(transform),
    transition,
    opacity: isDragging ? 0.5 : 1,
  }

  const handleRename = () => {
    if (name.trim() && name !== column.name) {
      onRename(column.id, name.trim())
    } else {
      setName(column.name)
    }
    setIsEditing(false)
  }

  return (
    <div
      ref={setNodeRef}
      style={style}
      className="flex-shrink-0 w-80 bg-muted/50 rounded-lg p-4"
    >
      <div className="flex items-center justify-between mb-4 group">
        <div className="flex items-center gap-2 flex-1">
          <button
            className="cursor-grab opacity-0 group-hover:opacity-100 transition-opacity"
            {...attributes}
            {...listeners}
          >
            <GripVertical className="h-4 w-4 text-muted-foreground" />
          </button>

          {isEditing ? (
            <Input
              value={name}
              onChange={(e) => setName(e.target.value)}
              onBlur={handleRename}
              onKeyDown={(e) => {
                if (e.key === 'Enter') handleRename()
                if (e.key === 'Escape') {
                  setName(column.name)
                  setIsEditing(false)
                }
              }}
              className="h-7 text-sm font-semibold"
              autoFocus
            />
          ) : (
            <h3
              className="text-sm font-semibold cursor-pointer hover:text-foreground/80"
              onClick={() => setIsEditing(true)}
            >
              {column.name}
              <span className="ml-2 text-xs text-muted-foreground">{cardCount}</span>
            </h3>
          )}
        </div>

        <div className="flex items-center gap-1">
          <Button
            variant="ghost"
            size="sm"
            className="h-7 w-7 p-0"
          >
            <Plus className="h-4 w-4" />
          </Button>
          <DropdownMenu>
            <DropdownMenuTrigger asChild>
              <Button variant="ghost" size="sm" className="h-7 w-7 p-0">
                <MoreVertical className="h-4 w-4" />
              </Button>
            </DropdownMenuTrigger>
            <DropdownMenuContent align="end">
              <DropdownMenuItem onClick={() => setIsEditing(true)}>
                <Pencil className="mr-2 h-4 w-4" />
                Rename Column
              </DropdownMenuItem>
              <DropdownMenuItem
                onClick={() => onDelete(column.id)}
                className="text-destructive"
              >
                <Trash2 className="mr-2 h-4 w-4" />
                Delete Column
              </DropdownMenuItem>
            </DropdownMenuContent>
          </DropdownMenu>
        </div>
      </div>

      {/* Cards will be rendered here in Story 2.4 */}
      <div className="space-y-2 min-h-[200px]">
        {cardCount === 0 && (
          <p className="text-sm text-muted-foreground text-center py-8">
            Drag cards here or click + to add
          </p>
        )}
      </div>
    </div>
  )
}
```

### Board View with Column Reordering

```typescript
// frontend/src/app/(dashboard)/workspaces/[workspaceId]/boards/[boardId]/page.tsx
'use client'

import { useMutation, useQuery, useQueryClient } from '@tanstack/react-query'
import {
  DndContext,
  closestCenter,
  KeyboardSensor,
  PointerSensor,
  useSensor,
  useSensors,
  DragEndEvent,
} from '@dnd-kit/core'
import {
  arrayMove,
  SortableContext,
  sortableKeyboardCoordinates,
  horizontalListSortingStrategy,
} from '@dnd-kit/sortable'
import { BoardColumn } from '@/components/board/board-column'
import { Button } from '@/components/ui/button'
import { Plus } from 'lucide-react'
import { api } from '@/lib/api/client'
import { v4 as uuidv4 } from 'uuid'

interface Column {
  id: string
  name: string
  position: number
}

export default function BoardPage({ params }: { params: { boardId: string } }) {
  const queryClient = useQueryClient()

  const { data: board } = useQuery({
    queryKey: ['boards', params.boardId],
    queryFn: () => api.get(`/boards/${params.boardId}`),
  })

  const updateColumnsMutation = useMutation({
    mutationFn: (columns: Column[]) =>
      api.patch(`/boards/${params.boardId}`, { columns }),
    onMutate: async (newColumns) => {
      await queryClient.cancelQueries({ queryKey: ['boards', params.boardId] })
      const previous = queryClient.getQueryData(['boards', params.boardId])
      queryClient.setQueryData(['boards', params.boardId], (old: any) => ({
        ...old,
        columns: newColumns,
      }))
      return { previous }
    },
    onError: (err, variables, context) => {
      queryClient.setQueryData(['boards', params.boardId], context?.previous)
    },
  })

  const sensors = useSensors(
    useSensor(PointerSensor),
    useSensor(KeyboardSensor, {
      coordinateGetter: sortableKeyboardCoordinates,
    })
  )

  const handleDragEnd = (event: DragEndEvent) => {
    const { active, over } = event
    if (!over || active.id === over.id) return

    const oldIndex = board.columns.findIndex((col: Column) => col.id === active.id)
    const newIndex = board.columns.findIndex((col: Column) => col.id === over.id)

    const reorderedColumns = arrayMove(board.columns, oldIndex, newIndex).map(
      (col, index) => ({ ...col, position: index })
    )

    updateColumnsMutation.mutate(reorderedColumns)
  }

  const addColumn = () => {
    const newColumn = {
      id: uuidv4(),
      name: 'New Column',
      position: board.columns.length,
    }
    updateColumnsMutation.mutate([...board.columns, newColumn])
  }

  if (!board) return <div>Loading...</div>

  return (
    <div className="flex flex-col h-full">
      <div className="border-b p-4">
        <h1 className="text-2xl font-bold">{board.name}</h1>
      </div>

      <div className="flex-1 overflow-x-auto p-4">
        <DndContext
          sensors={sensors}
          collisionDetection={closestCenter}
          onDragEnd={handleDragEnd}
        >
          <div className="flex gap-4">
            <SortableContext
              items={board.columns.map((col: Column) => col.id)}
              strategy={horizontalListSortingStrategy}
            >
              {board.columns.map((column: Column) => (
                <BoardColumn
                  key={column.id}
                  column={column}
                  cardCount={0}
                  onRename={(id, name) => {
                    const updated = board.columns.map((col: Column) =>
                      col.id === id ? { ...col, name } : col
                    )
                    updateColumnsMutation.mutate(updated)
                  }}
                  onDelete={(id) => {
                    const updated = board.columns.filter((col: Column) => col.id !== id)
                    updateColumnsMutation.mutate(updated)
                  }}
                />
              ))}
            </SortableContext>

            <Button
              variant="ghost"
              className="flex-shrink-0 w-80 h-12"
              onClick={addColumn}
            >
              <Plus className="mr-2 h-4 w-4" />
              Add Column
            </Button>
          </div>
        </DndContext>
      </div>
    </div>
  )
}
```

### Testing

**Integration Test - Board Creation:**
```python
@pytest.mark.asyncio
async def test_create_board_with_template(client, test_workspace, auth_headers):
    response = await client.post(
        f"/workspaces/{test_workspace.id}/boards",
        json={"name": "Sprint Board", "template": "kanban"},
        headers=auth_headers
    )
    assert response.status_code == 201
    data = response.json()
    assert data["name"] == "Sprint Board"
    assert len(data["columns"]) == 4
    assert data["columns"][0]["name"] == "To Do"
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-23 | 1.0 | Initial story creation from PRD Epic 2 Story 2.3 | Sarah (PO Agent) |

---

## Dev Agent Record

### Agent Model Used
*To be populated by development agent*

### Debug Log References
*To be populated by development agent*

### Completion Notes List
*To be populated by development agent*

### File List
*To be populated by development agent*

---

## QA Results
*To be populated by QA agent after implementation review*
