# Story 3.3: PR Auto-Link & Detection

## Status
Draft

---

## Story

**As a** developer,
**I want** pull requests automatically linked to cards when branch names match,
**so that** I don't have to manually connect PRs to tasks.

---

## Acceptance Criteria

1. When PR created on GitHub with branch matching pattern `card-{id}-*`, system auto-detects and links to card
2. Card displays "Pull Requests" section showing all linked PRs with: #number, title, state, author avatar
3. Clicking PR opens GitHub PR page in new tab
4. Card shows PR count badge in board view: "2 PRs" if multiple PRs linked
5. PRs manually linkable via "+ Link PR" button in card detail modal (search by PR number or URL)
6. PR link created in `card_pull_requests` join table with `card_id` and `pull_request_id`
7. PR data cached in `pull_requests` table: number, title, state, author, URL, head_branch, base_branch
8. Webhook `pull_request` event triggers PR data sync (create or update PullRequest record)
9. Card activity logs PR events: "[User] opened PR #123", "PR #123 merged"
10. Unlinking PR removes from `card_pull_requests`, shows confirmation: "Unlink PR #123?"
11. If PR branch deleted on GitHub, card still shows PR as "merged" or "closed" (historical record)
12. Board filter allows filtering cards by PR status: "Has Open PR", "Has Merged PR", "No PR"

---

## Tasks / Subtasks

- [ ] **Task 1: Create PullRequest model** (AC: 7)
  - [ ] Verify `backend/app/models/pull_request.py` exists (from Story 1.3)
  - [ ] Add fields: pr_number, title, state, author_github_id, head_branch, base_branch, url, created_at, updated_at
  - [ ] Create `card_pull_requests` join table with card_id, pull_request_id

- [ ] **Task 2: Create PR linking API endpoints** (AC: 5, 6, 10)
  - [ ] Implement `POST /cards/{id}/pull-requests` - link PR to card (manual or auto)
  - [ ] Implement `DELETE /cards/{id}/pull-requests/{pr_id}` - unlink PR
  - [ ] Implement `GET /cards/{id}/pull-requests` - list linked PRs

- [ ] **Task 3: Implement webhook PR event handler** (AC: 1, 8)
  - [ ] Update `backend/app/api/webhooks.py` to handle `pull_request` events
  - [ ] Extract PR data from webhook payload
  - [ ] Detect card ID from branch name pattern: `card-{id}-*`
  - [ ] Create or update PullRequest record
  - [ ] Auto-link to card if pattern matches

- [ ] **Task 4: Create PR service layer** (AC: 6, 7, 8, 9)
  - [ ] Create `backend/app/services/pull_request_service.py`
  - [ ] Implement `link_pr_to_card(card_id, pr_number, repo_id)`
  - [ ] Implement `unlink_pr(card_id, pr_id)`
  - [ ] Implement `sync_pr_from_github(repo_id, pr_number)` - fetch and cache PR data
  - [ ] Log activity when PR linked/opened/merged

- [ ] **Task 5: Add PR section to card detail modal** (AC: 2, 3, 5)
  - [ ] Update card detail modal with "Pull Requests" section
  - [ ] Display linked PRs list
  - [ ] Each PR shows: #number, title, state badge, author avatar
  - [ ] Add "+ Link PR" button
  - [ ] Link button opens PR search dialog

- [ ] **Task 6: Create PR link dialog** (AC: 5)
  - [ ] Create `frontend/src/components/board/link-pr-dialog.tsx`
  - [ ] Input accepts PR number or GitHub URL
  - [ ] Parse GitHub URL to extract PR number
  - [ ] Validate PR exists in connected repository
  - [ ] Call API to link PR to card

- [ ] **Task 7: Add PR badge to board card** (AC: 4)
  - [ ] Show PR count badge if card has linked PRs
  - [ ] Badge displays: "1 PR" or "2 PRs"
  - [ ] Badge color: green if all merged, yellow if open, gray if closed
  - [ ] Clicking badge opens first PR or shows list if multiple

- [ ] **Task 8: Write tests** (AC: 1-12)
  - [ ] Unit test: Card ID detection from branch name
  - [ ] Integration test: Webhook auto-links PR to card
  - [ ] Integration test: Manual PR linking
  - [ ] E2E test: Full PR linking workflow

---

## Dev Notes

### Card ID Detection from Branch Name

```python
# backend/app/utils/branch_helpers.py
import re

def extract_card_id_from_branch(branch_name: str) -> str | None:
    """Extract card ID from branch name pattern: card-{id}-*"""
    pattern = r'^card-([a-f0-9\-]+)-'
    match = re.match(pattern, branch_name)
    return match.group(1) if match else None
```

### Webhook PR Event Handler

```python
# backend/app/api/webhooks.py
@router.post("/github")
async def github_webhook(request: Request, db: AsyncSession = Depends(get_db)):
    payload = await request.json()
    event_type = request.headers.get("X-GitHub-Event")

    if event_type == "pull_request":
        pr_data = payload["pull_request"]
        action = payload["action"]

        # Extract PR info
        pr_number = pr_data["number"]
        head_branch = pr_data["head"]["ref"]
        repo_full_name = pr_data["base"]["repo"]["full_name"]

        # Find repository
        repo = await db.execute(
            select(GitRepository).where(GitRepository.full_name == repo_full_name)
        )
        repo = repo.scalar_one_or_none()
        if not repo:
            return {"status": "ignored"}

        # Sync PR data
        pr_service = PullRequestService(db)
        pr = await pr_service.sync_pr_from_github(repo.id, pr_number, pr_data)

        # Auto-link if branch matches pattern
        card_id = extract_card_id_from_branch(head_branch)
        if card_id:
            await pr_service.link_pr_to_card(card_id, pr.id)

    return {"status": "ok"}
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-23 | 1.0 | Initial story creation from PRD Epic 3 Story 3.3 | Sarah (PO Agent) |
