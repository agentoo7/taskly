# Story 4.4: Sprint Velocity Tracking

## Status
Draft

---

## Story

**As a** product manager,
**I want** to track team velocity across sprints,
**so that** I can forecast future capacity and improve sprint planning.

---

## Acceptance Criteria

1. Board settings displays "Velocity Metrics" section showing velocity chart for last 6 sprints
2. Velocity chart displays bar graph: each bar represents completed story points per sprint
3. Average velocity calculated and displayed: "Avg Velocity: 32 points/sprint" with trend arrow (↑↓→)
4. Velocity trend indicator: improving (green ↑), declining (red ↓), stable (gray →)
5. Hover over bar shows sprint details: name, completed points, completion rate %
6. Velocity data calculated when sprint marked as complete
7. Forecast capacity suggestion for next sprint based on rolling 3-sprint average
8. Board header shows quick stats: "Team Velocity: 32 pts/sprint" (average)
9. Velocity calculation excludes removed/deleted cards from sprint
10. Export velocity report as CSV: sprint name, start/end dates, planned points, completed points, completion rate

---

## Tasks / Subtasks

- [ ] **Task 1: Create velocity calculation service** (AC: 2, 3, 6, 7, 9)
  - [ ] Calculate completed points per sprint
  - [ ] Calculate average velocity (last 6 sprints)
  - [ ] Calculate trend (compare recent vs previous)
  - [ ] Forecast next sprint capacity

- [ ] **Task 2: Store velocity data** (AC: 6)
  - [ ] Create `sprint_velocity` table or use sprint metadata
  - [ ] Fields: sprint_id, completed_points, planned_points, completion_rate
  - [ ] Populate when sprint completed

- [ ] **Task 3: Create velocity chart component** (AC: 1, 2, 5)
  - [ ] Bar chart with last 6 sprints
  - [ ] Tooltip with sprint details
  - [ ] Responsive design

- [ ] **Task 4: Add velocity trend indicator** (AC: 3, 4)
  - [ ] Calculate trend from last 3 sprints
  - [ ] Show arrow icon and color
  - [ ] Display average velocity

- [ ] **Task 5: Add forecast suggestion** (AC: 7)
  - [ ] Calculate 3-sprint rolling average
  - [ ] Show in "Create Sprint" modal as suggestion
  - [ ] "Recommended capacity: 32 points (based on team velocity)"

- [ ] **Task 6: Add velocity to board header** (AC: 8)
  - [ ] Display average velocity in board stats
  - [ ] Quick view without opening metrics

- [ ] **Task 7: Implement CSV export** (AC: 10)
  - [ ] Generate CSV from sprint velocity data
  - [ ] Download file with timestamp

- [ ] **Task 8: Write tests** (AC: 1-10)
  - [ ] Unit test: Velocity calculation
  - [ ] Unit test: Trend detection
  - [ ] Integration test: Velocity stored on sprint completion

---

## Dev Notes

### Velocity Calculation

```python
def calculate_team_velocity(board_id: UUID, sprint_count: int = 6) -> dict:
    """Calculate team velocity from completed sprints."""
    sprints = Sprint.query.filter_by(
        board_id=board_id,
        deleted_at__isnot=None  # Completed sprints
    ).order_by(Sprint.end_date.desc()).limit(sprint_count).all()

    velocities = []
    for sprint in sprints:
        cards = sprint.cards
        completed = sum(
            c.story_points or 0
            for c in cards
            if c.column_id in done_column_ids
        )
        velocities.append(completed)

    avg_velocity = sum(velocities) / len(velocities) if velocities else 0

    # Calculate trend
    recent_avg = sum(velocities[:3]) / 3 if len(velocities) >= 3 else avg_velocity
    previous_avg = sum(velocities[3:6]) / 3 if len(velocities) >= 6 else avg_velocity

    if recent_avg > previous_avg * 1.1:
        trend = "improving"
    elif recent_avg < previous_avg * 0.9:
        trend = "declining"
    else:
        trend = "stable"

    return {
        "avg_velocity": round(avg_velocity, 1),
        "trend": trend,
        "forecast": round(recent_avg, 1),
        "velocities": velocities[::-1]  # Chronological order
    }
```

### Velocity Chart Component

```typescript
// frontend/src/components/sprint/velocity-chart.tsx
import { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer } from 'recharts'

export function VelocityChart({ velocities }: any) {
  const data = velocities.map((v: any, i: number) => ({
    name: v.sprint_name,
    points: v.completed_points,
  }))

  return (
    <div className="space-y-4">
      <div className="flex items-center justify-between">
        <h3 className="text-lg font-semibold">Team Velocity</h3>
        <div className="text-sm text-muted-foreground">
          Avg: {velocities.avg_velocity} pts/sprint
          <span className={`ml-2 ${getTrendColor(velocities.trend)}`}>
            {getTrendArrow(velocities.trend)}
          </span>
        </div>
      </div>

      <ResponsiveContainer width="100%" height={300}>
        <BarChart data={data}>
          <XAxis dataKey="name" />
          <YAxis />
          <Tooltip />
          <Bar dataKey="points" fill="#3b82f6" />
        </BarChart>
      </ResponsiveContainer>
    </div>
  )
}
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-23 | 1.0 | Initial story creation from PRD Epic 4 Story 4.4 | Sarah (PO Agent) |

---

## Dev Agent Record

### Agent Model Used
*To be populated by development agent*

### Debug Log References
*To be populated by development agent*

### Completion Notes List
*To be populated by development agent*

### File List
*To be populated by development agent*

---

## QA Results
*To be populated by QA agent after implementation review*
