# Story 5.1: Command Palette (⌘+K) Implementation

## Status
Draft

---

## Story

**As a** power user,
**I want** a keyboard-accessible command palette for quick actions,
**so that** I can perform common tasks without using my mouse.

---

## Acceptance Criteria

1. Pressing ⌘+K (Mac) or Ctrl+K (Windows/Linux) opens command palette overlay from any screen
2. Command palette displays as centered modal (800px width) with search input focused automatically
3. Search input supports fuzzy matching: typing "cre card" matches "Create Card" command
4. Command list displays below search input showing: command name, description (gray text), keyboard shortcut (if applicable), icon
5. Commands grouped by category with section headers: "Navigation", "Card Actions", "Board Actions", "View Controls"
6. Navigation commands: "Go to Dashboard", "Go to Board Settings", "Go to Workspace Settings", "Switch Workspace" (shows workspace list on select)
7. Card actions: "Create Card" (prompts for column selection then opens quick-create), "Search Cards" (switches to card search mode), "Filter by Assignee", "Filter by Label"
8. Board actions: "Create Board", "Switch Board" (shows board list), "Create Sprint", "Export Board"
9. View controls: "Switch to Kanban View", "Switch to Timeline View", "Toggle Dark Mode", "Toggle Planning Mode"
10. Arrow keys (↑/↓) navigate command list; Enter executes selected command; Escape closes palette
11. Recently used commands appear at top of list (max 5) for quick access with "Recent" section header
12. Command palette supports command chaining: executing "Create Card" keeps palette open with "Which column?" sub-menu for multi-step workflows
13. Commands dynamically enable/disable based on context: "Switch to Kanban View" disabled when already in Kanban view, "Create Sprint" disabled if no board selected
14. Command palette supports direct card search mode: typing "#" prefix switches to card search showing matching cards with keyboard navigation to open selected card
15. Custom keyboard shortcuts configurable: user settings page includes "Keyboard Shortcuts" section listing all commands with editable shortcut fields
16. Command palette renders in <100ms on open with no lag during typing (search debounced at 150ms)
17. Command palette accessible from any page (global hotkey listener) and adapts commands to current context (board vs. workspace vs. settings)

---

## Tasks / Subtasks

- [ ] **Task 1: Create command registry system** (AC: 4, 5, 6, 7, 8, 9, 13)
  - [ ] Create `frontend/src/lib/commands/registry.ts`
  - [ ] Define Command interface: id, name, description, icon, category, action, shortcut, isEnabled
  - [ ] Implement command categories: Navigation, Card Actions, Board Actions, View Controls
  - [ ] Register all commands with context-aware enable/disable logic
  - [ ] Export commands grouped by category

- [ ] **Task 2: Build command palette UI component** (AC: 1, 2, 10, 16, 17)
  - [ ] Create `frontend/src/components/command-palette/command-palette.tsx`
  - [ ] Dialog modal with 800px width, centered positioning
  - [ ] Search input with auto-focus
  - [ ] Command list with keyboard navigation (↑/↓/Enter/Escape)
  - [ ] Optimize rendering for <100ms open time

- [ ] **Task 3: Implement fuzzy search** (AC: 3, 16)
  - [ ] Install fuse.js or similar fuzzy search library
  - [ ] Configure fuzzy matching on command name + description
  - [ ] Debounce search input at 150ms
  - [ ] Highlight matching text in results

- [ ] **Task 4: Add global hotkey listener** (AC: 1, 17)
  - [ ] Create `frontend/src/hooks/use-command-palette.ts`
  - [ ] Listen for ⌘+K (Mac) / Ctrl+K (Windows/Linux) globally
  - [ ] Prevent default browser behavior
  - [ ] Toggle command palette visibility

- [ ] **Task 5: Implement recent commands tracking** (AC: 11)
  - [ ] Store recently used commands in localStorage
  - [ ] Track last 5 executed commands
  - [ ] Display "Recent" section at top of command list
  - [ ] Clear recent on explicit user action

- [ ] **Task 6: Build command chaining system** (AC: 12)
  - [ ] Support multi-step command workflows
  - [ ] Keep palette open after command execution if next step required
  - [ ] Show sub-menu for column selection, workspace selection, etc.
  - [ ] Breadcrumb navigation for multi-step commands

- [ ] **Task 7: Implement card search mode** (AC: 14)
  - [ ] Detect "#" prefix in search input
  - [ ] Switch to card search mode showing matching cards
  - [ ] Fetch cards via API with debounced search
  - [ ] Arrow key navigation + Enter to open card

- [ ] **Task 8: Add keyboard shortcut configuration** (AC: 15)
  - [ ] Create settings page "Keyboard Shortcuts" section
  - [ ] List all commands with current shortcuts
  - [ ] Allow shortcut editing with conflict detection
  - [ ] Store custom shortcuts in user preferences
  - [ ] Apply custom shortcuts to command palette

- [ ] **Task 9: Write tests** (AC: 1-17)
  - [ ] Unit test: Command registry and filtering
  - [ ] Unit test: Fuzzy search matching
  - [ ] Component test: Command palette keyboard navigation
  - [ ] Component test: Recent commands tracking
  - [ ] E2E test: Full command execution workflow

---

## Dev Notes

### Command Registry Structure

```typescript
// frontend/src/lib/commands/registry.ts
import { LucideIcon } from 'lucide-react'

export interface Command {
  id: string
  name: string
  description: string
  icon: LucideIcon
  category: CommandCategory
  shortcut?: string
  action: (context: CommandContext) => void | Promise<void>
  isEnabled?: (context: CommandContext) => boolean
}

export enum CommandCategory {
  Navigation = 'Navigation',
  CardActions = 'Card Actions',
  BoardActions = 'Board Actions',
  ViewControls = 'View Controls',
}

export interface CommandContext {
  router: NextRouter
  currentBoardId?: string
  currentWorkspaceId?: string
  currentView?: 'kanban' | 'timeline'
  isDarkMode: boolean
}

export const commands: Command[] = [
  // Navigation
  {
    id: 'go-to-dashboard',
    name: 'Go to Dashboard',
    description: 'Navigate to workspace dashboard',
    icon: HomeIcon,
    category: CommandCategory.Navigation,
    action: (ctx) => ctx.router.push('/dashboard'),
  },
  {
    id: 'go-to-settings',
    name: 'Go to Settings',
    description: 'Open workspace settings',
    icon: SettingsIcon,
    category: CommandCategory.Navigation,
    action: (ctx) => ctx.router.push(`/workspaces/${ctx.currentWorkspaceId}/settings`),
    isEnabled: (ctx) => !!ctx.currentWorkspaceId,
  },

  // Card Actions
  {
    id: 'create-card',
    name: 'Create Card',
    description: 'Create a new card',
    icon: PlusIcon,
    category: CommandCategory.CardActions,
    shortcut: 'c',
    action: async (ctx) => {
      // Opens column selector sub-menu
    },
    isEnabled: (ctx) => !!ctx.currentBoardId,
  },
  {
    id: 'search-cards',
    name: 'Search Cards',
    description: 'Search all cards on this board',
    icon: SearchIcon,
    category: CommandCategory.CardActions,
    shortcut: '/',
    action: (ctx) => {
      // Switches to card search mode
    },
  },

  // View Controls
  {
    id: 'toggle-dark-mode',
    name: 'Toggle Dark Mode',
    description: 'Switch between light and dark themes',
    icon: MoonIcon,
    category: CommandCategory.ViewControls,
    action: (ctx) => {
      // Toggle theme
    },
  },
  {
    id: 'switch-to-kanban',
    name: 'Switch to Kanban View',
    description: 'Show board in Kanban layout',
    icon: LayoutGridIcon,
    category: CommandCategory.ViewControls,
    action: (ctx) => ctx.router.push(`/boards/${ctx.currentBoardId}`),
    isEnabled: (ctx) => ctx.currentView !== 'kanban' && !!ctx.currentBoardId,
  },
]
```

### Command Palette Component

```typescript
// frontend/src/components/command-palette/command-palette.tsx
'use client'

import { useState, useEffect, useMemo } from 'react'
import { useRouter } from 'next/navigation'
import { Dialog, DialogContent } from '@/components/ui/dialog'
import { Input } from '@/components/ui/input'
import { Command, CommandCategory, commands, CommandContext } from '@/lib/commands/registry'
import Fuse from 'fuse.js'
import { useDebouncedValue } from '@/hooks/use-debounced-value'

export function CommandPalette({ open, onOpenChange }: any) {
  const router = useRouter()
  const [search, setSearch] = useState('')
  const [selectedIndex, setSelectedIndex] = useState(0)
  const [recentCommands, setRecentCommands] = useState<string[]>([])

  const debouncedSearch = useDebouncedValue(search, 150)

  // Load recent commands from localStorage
  useEffect(() => {
    const recent = JSON.parse(localStorage.getItem('recent-commands') || '[]')
    setRecentCommands(recent)
  }, [open])

  // Build command context
  const context: CommandContext = useMemo(() => ({
    router,
    currentBoardId: undefined, // Get from route params or context
    currentWorkspaceId: undefined,
    currentView: 'kanban',
    isDarkMode: false,
  }), [router])

  // Filter enabled commands
  const enabledCommands = useMemo(() => {
    return commands.filter(cmd => !cmd.isEnabled || cmd.isEnabled(context))
  }, [context])

  // Fuzzy search
  const fuse = useMemo(() => {
    return new Fuse(enabledCommands, {
      keys: ['name', 'description'],
      threshold: 0.3,
    })
  }, [enabledCommands])

  const filteredCommands = useMemo(() => {
    if (!debouncedSearch) return enabledCommands
    return fuse.search(debouncedSearch).map(result => result.item)
  }, [debouncedSearch, fuse, enabledCommands])

  // Group commands by category
  const groupedCommands = useMemo(() => {
    const groups: Record<string, Command[]> = {}

    // Add recent section
    if (!debouncedSearch && recentCommands.length > 0) {
      groups['Recent'] = enabledCommands.filter(cmd =>
        recentCommands.includes(cmd.id)
      ).slice(0, 5)
    }

    // Add category sections
    filteredCommands.forEach(cmd => {
      if (!groups[cmd.category]) groups[cmd.category] = []
      groups[cmd.category].push(cmd)
    })

    return groups
  }, [filteredCommands, recentCommands, debouncedSearch, enabledCommands])

  // Keyboard navigation
  const handleKeyDown = (e: React.KeyboardEvent) => {
    const totalCommands = Object.values(groupedCommands).flat().length

    if (e.key === 'ArrowDown') {
      e.preventDefault()
      setSelectedIndex((prev) => (prev + 1) % totalCommands)
    } else if (e.key === 'ArrowUp') {
      e.preventDefault()
      setSelectedIndex((prev) => (prev - 1 + totalCommands) % totalCommands)
    } else if (e.key === 'Enter') {
      e.preventDefault()
      executeCommand(Object.values(groupedCommands).flat()[selectedIndex])
    } else if (e.key === 'Escape') {
      onOpenChange(false)
    }
  }

  const executeCommand = async (cmd: Command) => {
    // Track recent
    const updated = [cmd.id, ...recentCommands.filter(id => id !== cmd.id)].slice(0, 5)
    setRecentCommands(updated)
    localStorage.setItem('recent-commands', JSON.stringify(updated))

    // Execute
    await cmd.action(context)

    // Close palette (unless chaining)
    onOpenChange(false)
  }

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="max-w-[800px] p-0">
        <div className="flex flex-col">
          <Input
            value={search}
            onChange={(e) => setSearch(e.target.value)}
            onKeyDown={handleKeyDown}
            placeholder="Type a command or search..."
            className="border-0 border-b rounded-none focus-visible:ring-0"
            autoFocus
          />

          <div className="max-h-[400px] overflow-y-auto p-2">
            {Object.entries(groupedCommands).map(([category, cmds]) => (
              <div key={category} className="mb-4">
                <div className="px-2 py-1 text-xs font-semibold text-muted-foreground uppercase">
                  {category}
                </div>
                {cmds.map((cmd, index) => (
                  <button
                    key={cmd.id}
                    onClick={() => executeCommand(cmd)}
                    className={`w-full flex items-center gap-3 px-3 py-2 rounded-md text-left hover:bg-accent ${
                      selectedIndex === index ? 'bg-accent' : ''
                    }`}
                  >
                    <cmd.icon className="h-4 w-4" />
                    <div className="flex-1">
                      <div className="text-sm font-medium">{cmd.name}</div>
                      <div className="text-xs text-muted-foreground">{cmd.description}</div>
                    </div>
                    {cmd.shortcut && (
                      <kbd className="px-2 py-1 text-xs bg-muted rounded">{cmd.shortcut}</kbd>
                    )}
                  </button>
                ))}
              </div>
            ))}
          </div>
        </div>
      </DialogContent>
    </Dialog>
  )
}
```

### Global Hotkey Hook

```typescript
// frontend/src/hooks/use-command-palette.ts
'use client'

import { useEffect, useState } from 'react'

export function useCommandPalette() {
  const [isOpen, setIsOpen] = useState(false)

  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      // ⌘+K on Mac, Ctrl+K on Windows/Linux
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault()
        setIsOpen((prev) => !prev)
      }
    }

    window.addEventListener('keydown', handleKeyDown)
    return () => window.removeEventListener('keydown', handleKeyDown)
  }, [])

  return { isOpen, setIsOpen }
}
```

### Card Search Mode

```typescript
// When user types "#" prefix, switch to card search mode
const [searchMode, setSearchMode] = useState<'commands' | 'cards'>('commands')

useEffect(() => {
  if (search.startsWith('#')) {
    setSearchMode('cards')
  } else {
    setSearchMode('commands')
  }
}, [search])

// Fetch cards when in card search mode
const { data: searchResults } = useQuery({
  queryKey: ['card-search', debouncedSearch.slice(1)],
  queryFn: () => api.get(`/cards/search?q=${debouncedSearch.slice(1)}`),
  enabled: searchMode === 'cards' && debouncedSearch.length > 1,
})
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-23 | 1.0 | Initial story creation from PRD Epic 5 Story 5.1 | Sarah (PO Agent) |

---

## Dev Agent Record

### Agent Model Used
*To be populated by development agent*

### Debug Log References
*To be populated by development agent*

### Completion Notes List
*To be populated by development agent*

### File List
*To be populated by development agent*

---

## QA Results
*To be populated by QA agent after implementation review*
