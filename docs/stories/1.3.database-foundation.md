# Story 1.3: Database Foundation & Core Models

## Status
Draft

---

## Story

**As a** developer,
**I want** the foundational database schema and ORM models established,
**so that** I can build features on a solid, migrated data model.

---

## Acceptance Criteria

1. PostgreSQL 15+ running in Docker with persistent volume (data survives container restarts)
2. Alembic configured for database migrations with initial migration created
3. SQLAlchemy 2.0 (async) models defined for core entities: `users`, `workspaces`, `boards`, `cards`
4. `users` table includes: id (UUID), github_id (unique), username, email, avatar_url, created_at, updated_at
5. `workspaces` table includes: id (UUID), name, created_by (FK to users), created_at, updated_at
6. `boards` table includes: id (UUID), workspace_id (FK), name, columns (JSONB array), created_at, updated_at
7. `cards` table includes: id (UUID), board_id (FK), title, description (text), metadata (JSONB), column_id, position (integer), created_at, updated_at
8. Many-to-many relationship tables: `workspace_members` (user_id, workspace_id, role enum: admin/member)
9. Indexes created on all foreign keys for query performance
10. Migration applies successfully with `alembic upgrade head` and rolls back with `alembic downgrade -1`
11. Seed script (`scripts/seed_dev_data.py`) populates test data for local development

---

## Tasks / Subtasks

- [ ] **Task 1: Configure Alembic for database migrations** (AC: 2, 10)
  - [ ] Initialize Alembic: `cd backend && alembic init alembic`
  - [ ] Configure `alembic.ini` with database URL from environment variable
  - [ ] Update `alembic/env.py` to import SQLAlchemy models and use async engine
  - [ ] Configure `env.py` to load app config and database URL
  - [ ] Test migration generation: `alembic revision --autogenerate -m "test"`
  - [ ] Test migration upgrade: `alembic upgrade head`
  - [ ] Test migration downgrade: `alembic downgrade -1`
  - [ ] Add migration commands to README

- [ ] **Task 2: Create database configuration module** (AC: 1)
  - [ ] Create `backend/app/core/database.py`
  - [ ] Define async SQLAlchemy engine with connection pooling
  - [ ] Define async session factory using `async_sessionmaker`
  - [ ] Create `get_db()` dependency for FastAPI routes
  - [ ] Configure connection pool settings: pool_size=20, max_overflow=10, pool_pre_ping=True
  - [ ] Add database health check function
  - [ ] Test database connection in health check endpoint

- [ ] **Task 3: Define User model** (AC: 3, 4)
  - [ ] Create `backend/app/models/user.py`
  - [ ] Define `User` class inheriting from SQLAlchemy `Base`
  - [ ] Add fields: `id` (UUID primary key), `github_id` (Integer unique), `username` (String 100), `email` (String 255), `avatar_url` (String 500), `github_access_token` (String 500, encrypted)
  - [ ] Add timestamp fields: `created_at`, `updated_at` with auto-update trigger
  - [ ] Add relationships: `workspaces` (many-to-many via workspace_members), `created_cards`
  - [ ] Add unique constraint on `github_id`
  - [ ] Add index on `email` for lookup performance

- [ ] **Task 4: Define Workspace model** (AC: 3, 5)
  - [ ] Create `backend/app/models/workspace.py`
  - [ ] Define `Workspace` class with fields: `id` (UUID), `name` (String 100), `created_by` (UUID FK to users), `created_at`, `updated_at`
  - [ ] Add relationship: `creator` (User who created workspace)
  - [ ] Add relationship: `members` (many-to-many via workspace_members)
  - [ ] Add relationship: `boards` (one-to-many)
  - [ ] Add index on `created_by` foreign key

- [ ] **Task 5: Define Board model** (AC: 3, 6)
  - [ ] Create `backend/app/models/board.py`
  - [ ] Define `Board` class with fields: `id` (UUID), `workspace_id` (UUID FK), `name` (String 100), `columns` (JSONB), `archived` (Boolean default False), `created_at`, `updated_at`
  - [ ] Define JSONB columns schema: `[{"id": "uuid", "name": "string", "position": int}]`
  - [ ] Add relationship: `workspace` (belongs to Workspace)
  - [ ] Add relationship: `cards` (one-to-many)
  - [ ] Add index on `workspace_id` foreign key
  - [ ] Add GIN index on `columns` JSONB field for fast queries

- [ ] **Task 6: Define Card model** (AC: 3, 7)
  - [ ] Create `backend/app/models/card.py`
  - [ ] Define `Card` class with fields: `id` (UUID), `board_id` (UUID FK), `column_id` (UUID), `title` (String 255), `description` (Text), `metadata` (JSONB), `priority` (Enum), `story_points` (Integer), `due_date` (Date), `position` (Integer), `sprint_id` (UUID nullable), `created_by` (UUID FK), `created_at`, `updated_at`
  - [ ] Define priority enum: `none`, `low`, `medium`, `high`, `urgent`
  - [ ] Define metadata JSONB schema: `{"labels": [{"id": "uuid", "name": "string", "color": "string"}], "acceptance_criteria": "text"}`
  - [ ] Add relationships: `board`, `creator`, `assignees` (many-to-many)
  - [ ] Add indexes: `board_id`, `column_id`, `created_by`, composite index on `(board_id, position)`
  - [ ] Add GIN index on `metadata` JSONB field

- [ ] **Task 7: Define WorkspaceMember join table** (AC: 8)
  - [ ] Create `backend/app/models/workspace_member.py`
  - [ ] Define `WorkspaceMember` class with fields: `user_id` (UUID FK), `workspace_id` (UUID FK), `role` (Enum: admin/member), `joined_at` (DateTime)
  - [ ] Define role enum: `admin`, `member`
  - [ ] Add composite primary key: `(user_id, workspace_id)`
  - [ ] Add indexes on both foreign keys
  - [ ] Add unique constraint to prevent duplicate memberships

- [ ] **Task 8: Define additional supporting models** (AC: 3)
  - [ ] Create `backend/app/models/card_assignee.py` - Join table for card assignments
  - [ ] Create `backend/app/models/sprint.py` - Sprint model with: `id`, `board_id`, `name`, `start_date`, `end_date`, `goal`, `capacity_points`, `status`, `created_at`, `updated_at`
  - [ ] Create `backend/app/models/git_repository.py` - GitHub repository cache
  - [ ] Create `backend/app/models/pull_request.py` - PR data cache
  - [ ] Create `backend/app/models/__init__.py` to export all models

- [ ] **Task 9: Create initial database migration** (AC: 2, 9, 10)
  - [ ] Generate initial migration: `alembic revision --autogenerate -m "initial schema"`
  - [ ] Review generated migration file, verify all tables and indexes present
  - [ ] Add manual index creation if autogenerate missed any (GIN indexes on JSONB)
  - [ ] Test upgrade: `alembic upgrade head`
  - [ ] Verify tables created: `psql` and `\dt` command
  - [ ] Test downgrade: `alembic downgrade -1`
  - [ ] Verify tables dropped
  - [ ] Re-upgrade for development: `alembic upgrade head`

- [ ] **Task 10: Create database seed script** (AC: 11)
  - [ ] Create `backend/scripts/seed_dev_data.py`
  - [ ] Add seed data: 2 test users (user1@github.com, user2@github.com)
  - [ ] Add seed data: 1 test workspace "Test Workspace" created by user1
  - [ ] Add workspace membership: user1 as admin, user2 as member
  - [ ] Add seed data: 1 test board "Sprint Board" with default columns (To Do, In Progress, In Review, Done)
  - [ ] Add seed data: 5 test cards distributed across columns
  - [ ] Make script idempotent (check if data exists before inserting)
  - [ ] Add CLI command: `python -m scripts.seed_dev_data`
  - [ ] Document seed script usage in README

- [ ] **Task 11: Create database reset script** (AC: 1, 11)
  - [ ] Create `backend/scripts/reset_db.sh`
  - [ ] Script drops all tables: `alembic downgrade base`
  - [ ] Script recreates schema: `alembic upgrade head`
  - [ ] Script runs seed: `python -m scripts.seed_dev_data`
  - [ ] Add confirmation prompt: "This will DELETE all data. Continue? (y/N)"
  - [ ] Make script executable: `chmod +x scripts/reset_db.sh`
  - [ ] Document reset script usage in README

- [ ] **Task 12: Add repository layer for core models** (AC: 3)
  - [ ] Create `backend/app/repositories/base.py` with `BaseRepository` class
  - [ ] Create `backend/app/repositories/user_repository.py` with CRUD operations
  - [ ] Create `backend/app/repositories/workspace_repository.py` with CRUD operations
  - [ ] Create `backend/app/repositories/board_repository.py` with CRUD operations
  - [ ] Create `backend/app/repositories/card_repository.py` with CRUD operations
  - [ ] Implement common methods: `get_by_id()`, `get_all()`, `create()`, `update()`, `delete()`
  - [ ] Add repository dependency injection for FastAPI routes

- [ ] **Task 13: Write unit tests for models and repositories** (AC: 3)
  - [ ] Create `backend/tests/unit/models/test_user.py` - Test User model creation, validation
  - [ ] Create `backend/tests/unit/models/test_workspace.py` - Test Workspace relationships
  - [ ] Create `backend/tests/unit/models/test_board.py` - Test Board JSONB columns
  - [ ] Create `backend/tests/unit/models/test_card.py` - Test Card enums and metadata
  - [ ] Create `backend/tests/integration/test_repositories.py` - Test repository CRUD with real DB
  - [ ] Use pytest fixtures for test database setup/teardown
  - [ ] Achieve 80%+ coverage on models and repositories

---

## Dev Notes

### Database Schema Overview

**Core Tables:**
1. **users** - Authenticated users (GitHub OAuth)
2. **workspaces** - Top-level organizational container
3. **workspace_members** - Join table for workspace membership with roles
4. **boards** - Kanban boards within workspaces
5. **cards** - Tasks/features on boards
6. **card_assignees** - Join table for card assignments
7. **sprints** - Time-boxed iterations
8. **git_repositories** - Connected GitHub repos
9. **pull_requests** - Cached PR data from GitHub
10. **card_pull_requests** - Join table linking cards to PRs

### SQLAlchemy 2.0 Async Configuration

```python
# backend/app/core/database.py
from sqlalchemy.ext.asyncio import create_async_engine, async_sessionmaker, AsyncSession
from sqlalchemy.orm import DeclarativeBase
import os

DATABASE_URL = os.getenv("DATABASE_URL", "postgresql+asyncpg://taskly:taskly@localhost:5432/taskly")

engine = create_async_engine(
    DATABASE_URL,
    echo=True,  # SQL logging in development
    pool_size=20,
    max_overflow=10,
    pool_pre_ping=True,  # Verify connections before using
)

AsyncSessionLocal = async_sessionmaker(
    engine,
    class_=AsyncSession,
    expire_on_commit=False,
)

class Base(DeclarativeBase):
    pass

async def get_db() -> AsyncSession:
    async with AsyncSessionLocal() as session:
        yield session
```

### User Model Example

```python
# backend/app/models/user.py
from sqlalchemy import Column, String, Integer, DateTime, func
from sqlalchemy.dialects.postgresql import UUID
from sqlalchemy.orm import relationship
import uuid

from app.core.database import Base

class User(Base):
    __tablename__ = "users"

    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    github_id = Column(Integer, unique=True, nullable=False, index=True)
    username = Column(String(100), nullable=False)
    email = Column(String(255), nullable=False, index=True)
    avatar_url = Column(String(500))
    github_access_token = Column(String(500))  # TODO: Encrypt in production
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    updated_at = Column(DateTime(timezone=True), server_default=func.now(), onupdate=func.now())

    # Relationships
    created_workspaces = relationship("Workspace", back_populates="creator", foreign_keys="Workspace.created_by")
    workspaces = relationship("Workspace", secondary="workspace_members", back_populates="members")
    created_cards = relationship("Card", back_populates="creator", foreign_keys="Card.created_by")
    assigned_cards = relationship("Card", secondary="card_assignees", back_populates="assignees")

    def __repr__(self):
        return f"<User(id={self.id}, username={self.username})>"
```

### Board Model with JSONB Columns

```python
# backend/app/models/board.py
from sqlalchemy import Column, String, Boolean, DateTime, ForeignKey, func
from sqlalchemy.dialects.postgresql import UUID, JSONB
from sqlalchemy.orm import relationship
import uuid

from app.core.database import Base

class Board(Base):
    __tablename__ = "boards"

    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    workspace_id = Column(UUID(as_uuid=True), ForeignKey("workspaces.id", ondelete="CASCADE"), nullable=False, index=True)
    name = Column(String(100), nullable=False)
    columns = Column(JSONB, nullable=False, default=list)  # [{"id": "uuid", "name": "str", "position": int}]
    archived = Column(Boolean, default=False)
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    updated_at = Column(DateTime(timezone=True), server_default=func.now(), onupdate=func.now())

    # Relationships
    workspace = relationship("Workspace", back_populates="boards")
    cards = relationship("Card", back_populates="board", cascade="all, delete-orphan")

    def __repr__(self):
        return f"<Board(id={self.id}, name={self.name})>"
```

### Card Model with Enum and JSONB

```python
# backend/app/models/card.py
from sqlalchemy import Column, String, Text, Integer, Date, DateTime, ForeignKey, Enum as SQLEnum, func
from sqlalchemy.dialects.postgresql import UUID, JSONB
from sqlalchemy.orm import relationship
import uuid
import enum

from app.core.database import Base

class PriorityEnum(str, enum.Enum):
    NONE = "none"
    LOW = "low"
    MEDIUM = "medium"
    HIGH = "high"
    URGENT = "urgent"

class Card(Base):
    __tablename__ = "cards"

    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    board_id = Column(UUID(as_uuid=True), ForeignKey("boards.id", ondelete="CASCADE"), nullable=False, index=True)
    column_id = Column(UUID(as_uuid=True), nullable=False, index=True)
    title = Column(String(255), nullable=False)
    description = Column(Text)
    metadata = Column(JSONB, default=dict)  # {"labels": [...], "acceptance_criteria": "..."}
    priority = Column(SQLEnum(PriorityEnum), default=PriorityEnum.NONE)
    story_points = Column(Integer)
    due_date = Column(Date)
    position = Column(Integer, nullable=False, default=0)
    sprint_id = Column(UUID(as_uuid=True), ForeignKey("sprints.id", ondelete="SET NULL"))
    created_by = Column(UUID(as_uuid=True), ForeignKey("users.id"), nullable=False, index=True)
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    updated_at = Column(DateTime(timezone=True), server_default=func.now(), onupdate=func.now())

    # Relationships
    board = relationship("Board", back_populates="cards")
    creator = relationship("User", back_populates="created_cards", foreign_keys=[created_by])
    assignees = relationship("User", secondary="card_assignees", back_populates="assigned_cards")
    sprint = relationship("Sprint", back_populates="cards")

    # Composite index for efficient ordering within columns
    __table_args__ = (
        Index("ix_cards_board_position", "board_id", "position"),
    )

    def __repr__(self):
        return f"<Card(id={self.id}, title={self.title})>"
```

### Alembic Configuration

```python
# backend/alembic/env.py
from logging.config import fileConfig
from sqlalchemy import pool
from sqlalchemy.ext.asyncio import async_engine_from_config
from alembic import context
import asyncio

# Import all models for autogenerate
from app.core.database import Base
from app.models.user import User
from app.models.workspace import Workspace
from app.models.workspace_member import WorkspaceMember
from app.models.board import Board
from app.models.card import Card
from app.models.card_assignee import CardAssignee
from app.models.sprint import Sprint
from app.models.git_repository import GitRepository
from app.models.pull_request import PullRequest

config = context.config
target_metadata = Base.metadata

def run_migrations_offline() -> None:
    """Run migrations in 'offline' mode."""
    url = config.get_main_option("sqlalchemy.url")
    context.configure(
        url=url,
        target_metadata=target_metadata,
        literal_binds=True,
        dialect_opts={"paramstyle": "named"},
    )

    with context.begin_transaction():
        context.run_migrations()

async def run_migrations_online() -> None:
    """Run migrations in 'online' mode with async engine."""
    connectable = async_engine_from_config(
        config.get_section(config.config_ini_section),
        prefix="sqlalchemy.",
        poolclass=pool.NullPool,
    )

    async with connectable.connect() as connection:
        await connection.run_sync(do_run_migrations)

def do_run_migrations(connection):
    context.configure(connection=connection, target_metadata=target_metadata)
    with context.begin_transaction():
        context.run_migrations()

if context.is_offline_mode():
    run_migrations_offline()
else:
    asyncio.run(run_migrations_online())
```

### Seed Data Script

```python
# backend/scripts/seed_dev_data.py
import asyncio
import uuid
from sqlalchemy.ext.asyncio import AsyncSession
from app.core.database import AsyncSessionLocal
from app.models.user import User
from app.models.workspace import Workspace
from app.models.workspace_member import WorkspaceMember, RoleEnum
from app.models.board import Board
from app.models.card import Card, PriorityEnum

async def seed_data():
    async with AsyncSessionLocal() as session:
        # Check if data already exists
        result = await session.execute("SELECT COUNT(*) FROM users")
        count = result.scalar()
        if count > 0:
            print("Database already seeded. Skipping...")
            return

        # Create users
        user1 = User(
            github_id=12345,
            username="alice",
            email="alice@github.com",
            avatar_url="https://github.com/alice.png"
        )
        user2 = User(
            github_id=67890,
            username="bob",
            email="bob@github.com",
            avatar_url="https://github.com/bob.png"
        )
        session.add_all([user1, user2])
        await session.flush()

        # Create workspace
        workspace = Workspace(
            name="Test Workspace",
            created_by=user1.id
        )
        session.add(workspace)
        await session.flush()

        # Add members
        member1 = WorkspaceMember(user_id=user1.id, workspace_id=workspace.id, role=RoleEnum.ADMIN)
        member2 = WorkspaceMember(user_id=user2.id, workspace_id=workspace.id, role=RoleEnum.MEMBER)
        session.add_all([member1, member2])

        # Create board with columns
        board = Board(
            workspace_id=workspace.id,
            name="Sprint Board",
            columns=[
                {"id": str(uuid.uuid4()), "name": "To Do", "position": 0},
                {"id": str(uuid.uuid4()), "name": "In Progress", "position": 1},
                {"id": str(uuid.uuid4()), "name": "In Review", "position": 2},
                {"id": str(uuid.uuid4()), "name": "Done", "position": 3},
            ]
        )
        session.add(board)
        await session.flush()

        # Create cards
        cards = [
            Card(board_id=board.id, column_id=board.columns[0]["id"], title="Setup development environment", priority=PriorityEnum.HIGH, position=0, created_by=user1.id),
            Card(board_id=board.id, column_id=board.columns[0]["id"], title="Design database schema", priority=PriorityEnum.MEDIUM, position=1, created_by=user1.id),
            Card(board_id=board.id, column_id=board.columns[1]["id"], title="Implement authentication", priority=PriorityEnum.URGENT, position=0, created_by=user2.id),
            Card(board_id=board.id, column_id=board.columns[2]["id"], title="Create board view UI", priority=PriorityEnum.MEDIUM, position=0, created_by=user1.id),
            Card(board_id=board.id, column_id=board.columns[3]["id"], title="Write project README", priority=PriorityEnum.LOW, position=0, created_by=user2.id),
        ]
        session.add_all(cards)

        await session.commit()
        print("âœ… Database seeded successfully!")

if __name__ == "__main__":
    asyncio.run(seed_data())
```

### Repository Pattern Example

```python
# backend/app/repositories/base.py
from typing import Generic, TypeVar, Type, Optional, List
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select
from uuid import UUID

ModelType = TypeVar("ModelType")

class BaseRepository(Generic[ModelType]):
    def __init__(self, model: Type[ModelType], session: AsyncSession):
        self.model = model
        self.session = session

    async def get_by_id(self, id: UUID) -> Optional[ModelType]:
        result = await self.session.execute(select(self.model).where(self.model.id == id))
        return result.scalar_one_or_none()

    async def get_all(self, skip: int = 0, limit: int = 100) -> List[ModelType]:
        result = await self.session.execute(select(self.model).offset(skip).limit(limit))
        return result.scalars().all()

    async def create(self, obj: ModelType) -> ModelType:
        self.session.add(obj)
        await self.session.flush()
        await self.session.refresh(obj)
        return obj

    async def update(self, obj: ModelType) -> ModelType:
        await self.session.flush()
        await self.session.refresh(obj)
        return obj

    async def delete(self, obj: ModelType) -> None:
        await self.session.delete(obj)
        await self.session.flush()
```

### Testing

**Unit Test Example:**
```python
# backend/tests/unit/models/test_card.py
import pytest
from app.models.card import Card, PriorityEnum

def test_card_creation():
    card = Card(
        board_id="some-uuid",
        column_id="column-uuid",
        title="Test Card",
        priority=PriorityEnum.HIGH,
        created_by="user-uuid"
    )
    assert card.title == "Test Card"
    assert card.priority == PriorityEnum.HIGH
    assert card.position == 0  # Default value
```

**Integration Test Example:**
```python
# backend/tests/integration/test_repositories.py
import pytest
from app.repositories.card_repository import CardRepository
from app.models.card import Card, PriorityEnum

@pytest.mark.asyncio
async def test_card_repository_create(db_session):
    repo = CardRepository(db_session)
    card = Card(
        board_id="board-uuid",
        column_id="column-uuid",
        title="Test Card",
        priority=PriorityEnum.MEDIUM,
        created_by="user-uuid"
    )
    created_card = await repo.create(card)
    assert created_card.id is not None
    assert created_card.title == "Test Card"
```

### Migration Commands

```bash
# Generate new migration after model changes
alembic revision --autogenerate -m "add new field to cards"

# Apply migrations
alembic upgrade head

# Rollback one migration
alembic downgrade -1

# View migration history
alembic history

# View current version
alembic current
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-23 | 1.0 | Initial story creation from PRD Epic 1 Story 1.3 | Sarah (PO Agent) |

---

## Dev Agent Record

### Agent Model Used
*To be populated by development agent*

### Debug Log References
*To be populated by development agent*

### Completion Notes List
*To be populated by development agent*

### File List
*To be populated by development agent*

---

## QA Results
*To be populated by QA agent after implementation review*
