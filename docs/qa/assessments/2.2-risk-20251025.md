# Risk Profile: Story 2.2 - Team Member Invitations & Permissions

**Date:** 2025-10-25
**Reviewer:** Quinn (Test Architect)
**Story:** 2.2 - Team Member Invitations & Permissions
**Status:** Pre-Development Risk Assessment

---

## Executive Summary

**Total Risks Identified:** 15
**Critical Risks (Score 9):** 3
**High Risks (Score 6):** 5
**Medium Risks (Score 4):** 4
**Low Risks (Score 2-3):** 3

**Overall Risk Score:** 49/100 ‚ö†Ô∏è **High Risk**

**Recommendation:** This story carries significant security and operational risks that MUST be addressed before development. The current design has critical vulnerabilities that could lead to abuse, data integrity issues, and production incidents.

---

## Critical Risks Requiring Immediate Attention

### 1. SEC-001: Invitation Abuse via Rate Limiting Bypass

**Score: 9 (Critical)** üî¥
**Probability:** High (3) - No rate limiting currently implemented
**Impact:** High (3) - Email reputation damage, service degradation, potential data breach

**Description:**
Without rate limiting, malicious actors (or compromised admin accounts) can:
- Send thousands of spam invitations, damaging email sender reputation
- Enumerate valid email addresses by observing response patterns
- Overwhelm Celery email queue, causing service degradation
- Perform DoS attacks on email infrastructure

**Affected Components:**
- `POST /workspaces/{id}/invitations` endpoint
- Celery email sending tasks
- Email provider (SendGrid/SES)

**Attack Scenarios:**
1. **Invite Bombing:** Attacker invites 10,000 fake emails ‚Üí Email provider blacklists domain
2. **Email Enumeration:** Attacker tries 1,000 emails, identifies which are already members
3. **Queue Flooding:** Malicious invitations fill Celery queue, blocking legitimate tasks

**Mitigation Strategy:** Preventive

**Required Actions:**
1. Implement rate limiting: 50 invitations per workspace per hour
2. Add request-level limit: max 10 emails per single API call
3. Add IP-based rate limiting using slowapi or Redis
4. Implement exponential backoff in Celery email tasks
5. Add email provider webhook to track bounces/spam reports
6. Monitor invitation creation rate in production metrics

**Testing Requirements:**
- Unit test: Verify rate limiter rejects 51st invitation in hour
- Integration test: Verify API returns 429 when rate limit exceeded
- Load test: Simulate 100 concurrent invitation requests
- Security test: Attempt email enumeration via API responses

**Residual Risk:** Low - Some sophisticated attacks may bypass IP-based limits (use VPN)

**Owner:** Backend Developer
**Timeline:** Must implement before any production deployment

---

### 2. DATA-001: Last Admin Orphaning Workspace

**Score: 9 (Critical)** üî¥
**Probability:** High (3) - Current code allows this scenario
**Impact:** High (3) - Workspace becomes permanently unmanageable

**Description:**
Current implementation prevents admin from removing themselves (Task 10) but doesn't prevent them from changing their own role to "member", leaving workspace with zero admins. Once this occurs, no user can:
- Invite new members
- Change member roles
- Delete the workspace
- Modify workspace settings

This creates "orphaned workspaces" that require manual database intervention to fix.

**Affected Components:**
- `PATCH /workspaces/{id}/members/{user_id}` endpoint
- `WorkspaceService.update_member_role()` method
- Frontend role dropdown component

**Failure Scenario:**
1. Workspace has 1 admin (Alice)
2. Alice changes her role to "member" via dropdown
3. Workspace now has 0 admins
4. No one can perform admin actions
5. Support team must manually update database

**Mitigation Strategy:** Preventive

**Required Actions:**
1. Add database query to count current admins before role change
2. Reject role change if user is last admin with 400 error
3. Display error: "You are the only admin. Promote another member first."
4. Add backend validation in service layer
5. Add frontend validation in UI (disable dropdown)
6. Create database constraint to enforce at least 1 admin per workspace

**Code Implementation:**
```python
# In workspace_service.py
async def update_member_role(self, workspace_id: UUID, user_id: UUID, new_role: RoleEnum):
    # Get current member
    current_member = await self._get_member(workspace_id, user_id)

    # Check if user is last admin
    if current_member.role == RoleEnum.ADMIN and new_role == RoleEnum.MEMBER:
        admin_count = await self.db.execute(
            select(func.count(WorkspaceMember.id))
            .where(
                WorkspaceMember.workspace_id == workspace_id,
                WorkspaceMember.role == RoleEnum.ADMIN
            )
        )
        if admin_count.scalar() == 1:
            raise HTTPException(
                status_code=400,
                detail="Cannot change role. You are the only admin. Promote another member first."
            )

    # Proceed with role update
    current_member.role = new_role
    await self.db.commit()
```

**Testing Requirements:**
- Unit test: Single admin cannot change own role to member
- Unit test: Admin can change role when 2+ admins exist
- Integration test: API returns 400 with helpful message
- E2E test: UI shows disabled dropdown or error message

**Residual Risk:** Minimal - If implemented correctly, this risk is fully mitigated

**Owner:** Backend Developer
**Timeline:** Must implement before Task 9 (Role Change) development

---

### 3. SEC-002: Email-to-Account Mismatch Vulnerability

**Score: 9 (Critical)** üî¥
**Probability:** High (3) - Common scenario in multi-account environments
**Impact:** High (3) - Broken user experience, security confusion, support burden

**Description:**
When a user is invited via email but authenticates with GitHub account using different email:
- User sees generic 403 error with no guidance
- User doesn't understand why invitation fails
- Creates support tickets and user frustration
- Potential social engineering vector (user tries to "fix" by sharing credentials)

**Example Scenarios:**
1. Bob invited to `bob@company.com`, logs in with GitHub account using `bob.personal@gmail.com`
2. User has multiple GitHub accounts with different emails
3. Company uses email aliases (bob+work@gmail.com vs bob@gmail.com)

**Affected Components:**
- `InvitationService.accept_invitation()` method (line 295-299)
- Frontend invitation acceptance page
- GitHub OAuth integration

**Current Code Problem:**
```python
if user.email.lower() != invitation.email.lower():
    raise HTTPException(
        status_code=403,
        detail="This invitation is for a different email address"
    )
```
This provides poor UX - user doesn't know what to do next.

**Mitigation Strategy:** Detective + User Experience Enhancement

**Required Actions:**
1. Update error response to include both emails:
   ```json
   {
     "error": "email_mismatch",
     "invitation_email": "bob@company.com",
     "account_email": "bob.personal@gmail.com",
     "message": "This invitation was sent to bob@company.com, but you're logged in with bob.personal@gmail.com",
     "actions": ["sign_out", "contact_admin"]
   }
   ```

2. Frontend displays helpful message:
   - "This invitation was sent to **bob@company.com**"
   - "Your GitHub account uses **bob.personal@gmail.com**"
   - Provide "Sign Out" button to try different account
   - Provide "Contact Admin" link to request re-invitation

3. Consider future enhancement: Allow admins to invite by GitHub username

4. Add logging for email mismatch incidents (analytics)

**Testing Requirements:**
- Integration test: Verify detailed error response on email mismatch
- E2E test: User can sign out and retry with correct account
- Security test: Ensure error doesn't leak sensitive information
- UX test: Error message is clear and actionable

**Residual Risk:** Low - Users may still be confused, but at least have clear next steps

**Owner:** Backend + Frontend Developers
**Timeline:** Must implement before Task 7 (Acceptance Page) development

---

## High Risks (Score 6)

### 4. PERF-001: Missing Database Indexes

**Score: 6 (High)** üü†
**Probability:** High (3) - Indexes not defined in model
**Impact:** Medium (2) - Performance degradation at scale

**Description:**
Missing indexes on frequently queried columns will cause slow queries as workspace invitation volume grows:
- `workspace_id` - Used in every pending invitation list query
- `email` - Used in duplicate invitation checks
- `expires_at` - Used by cleanup job

**Performance Impact:**
- 1,000 invitations: 50ms query ‚Üí 500ms
- 10,000 invitations: 200ms query ‚Üí 5,000ms (5 seconds)
- Full table scans on every invitation lookup

**Mitigation:**
```python
__table_args__ = (
    UniqueConstraint('workspace_id', 'email', name='uq_workspace_email_invitation'),
    Index('ix_workspace_invitations_workspace_id', 'workspace_id'),
    Index('ix_workspace_invitations_email', 'email'),
    Index('ix_workspace_invitations_expires_at', 'expires_at'),
)
```

**Owner:** Backend Developer
**Timeline:** Add to Task 1 (Data Models)

---

### 5. DATA-002: Concurrent Invitation Acceptance Race Condition

**Score: 6 (High)** üü†
**Probability:** Low (2) - Requires precise timing
**Impact:** High (3) - Duplicate workspace memberships, data corruption

**Description:**
Two users attempting to accept same invitation simultaneously could create duplicate workspace_members records due to race condition.

**Scenario:**
1. User A clicks "Accept" at 10:00:00.000
2. User B (different person, same token somehow) clicks "Accept" at 10:00:00.001
3. Both requests check `is_accepted == False` simultaneously
4. Both requests insert workspace_member record
5. Violates unique constraint or creates duplicate membership

**Mitigation:**
1. Use database transaction with SERIALIZABLE isolation level
2. Add unique constraint on (workspace_id, user_id) in workspace_members
3. Check `accepted_at` in database transaction before updating
4. Implement optimistic locking with version field

**Owner:** Backend Developer
**Timeline:** Add to Task 3 (Service Layer)

---

### 6. OPS-001: Database Bloat from Expired Invitations

**Score: 6 (High)** üü†
**Probability:** High (3) - No cleanup job exists
**Impact:** Medium (2) - Database storage costs, slower queries

**Description:**
Without cleanup job, expired invitations accumulate indefinitely:
- 100 workspaces √ó 20 invitations/month √ó 50% expiry rate = 1,000 expired records/month
- After 1 year: 12,000 dead records in database
- Increases backup size, query time, storage costs

**Mitigation:**
Create Celery periodic task to delete invitations expired > 30 days ago:
```python
@shared_task
def cleanup_expired_invitations():
    cutoff = datetime.utcnow() - timedelta(days=30)
    deleted = await db.execute(
        delete(WorkspaceInvitation)
        .where(
            WorkspaceInvitation.expires_at < cutoff,
            WorkspaceInvitation.accepted_at.is_(None)
        )
    )
    return deleted.rowcount
```

**Owner:** Backend Developer
**Timeline:** Add as new Task 14

---

### 7. SEC-003: Celery Task Timeout Missing

**Score: 6 (High)** üü†
**Probability:** Medium (2) - Email provider outages occur
**Impact:** High (3) - Celery worker hangs, blocks other tasks

**Description:**
Email sending task has no timeout - if email provider is down, task hangs indefinitely, blocking Celery worker.

**Mitigation:**
```python
@shared_task(time_limit=30, soft_time_limit=25)
def send_invitation_email_task(invitation_id: str):
    # Task will be killed after 30 seconds
```

**Owner:** Backend Developer
**Timeline:** Add to Task 4 (Email Sending)

---

### 8. OPS-002: Email Provider Configuration Incomplete

**Score: 6 (High)** üü†
**Probability:** High (3) - Configuration details missing
**Impact:** Medium (2) - Deployment delays, production email failures

**Description:**
Task 4 says "Configure email provider" but provides no implementation details, leading to:
- Last-minute scrambling during deployment
- Email delivery failures in production
- No bounce/spam handling
- Missing environment variables

**Mitigation:**
1. Specify email provider: Recommend SendGrid (easy setup, good free tier)
2. Document required environment variables:
   - `SENDGRID_API_KEY`
   - `FROM_EMAIL` (verified sender)
   - `FROM_NAME` (e.g., "Taskly Team")
   - `APP_URL` (for invitation links)
3. Set up webhook for delivery events (bounces, spam complaints)
4. Configure local development: Use Mailhog or console logging
5. Add email delivery status tracking to invitation model

**Owner:** DevOps + Backend Developer
**Timeline:** Clarify before Task 4 development

---

## Medium Risks (Score 4)

### 9. PERF-002: Member List Pagination Missing

**Score: 4 (Medium)** üü°
**Probability:** Medium (2) - Some workspaces will have large teams
**Impact:** Medium (2) - Slow page loads for large teams

**Description:**
No pagination on member list - loading 500+ members at once causes slow API responses and frontend rendering issues.

**Mitigation:**
Add pagination to `GET /workspaces/{id}/members` with 50 members per page.

**Owner:** Backend + Frontend Developer
**Timeline:** Nice to have for MVP, required for production

---

### 10. BUS-001: No Resend Invitation Feature

**Score: 4 (Medium)** üü°
**Probability:** Medium (2) - Email delivery failures are common
**Impact:** Medium (2) - Support tickets, user frustration

**Description:**
If invitation email isn't received (spam folder, delivery failure), admin must revoke and recreate invitation. Poor UX.

**Mitigation:**
Add "Resend" button that generates new token and sends new email.

**Owner:** Backend + Frontend Developer
**Timeline:** Should add to MVP

---

### 11. SEC-004: Missing Correlation IDs in Logging

**Score: 4 (Medium)** üü°
**Probability:** Medium (2) - Logging exists but lacks correlation
**Impact:** Medium (2) - Difficult debugging in production

**Description:**
Without correlation IDs, can't trace invitation lifecycle across logs (creation ‚Üí email ‚Üí acceptance).

**Mitigation:**
Add correlation ID logging using structlog (per coding standards).

**Owner:** Backend Developer
**Timeline:** Add during development

---

### 12. OPS-003: No Email Delivery Tracking

**Score: 4 (Medium)** üü°
**Probability:** Medium (2) - Email delivery issues are common
**Impact:** Medium (2) - Can't diagnose email problems

**Description:**
Can't tell if email was delivered, bounced, or marked as spam. No way to track delivery success rate.

**Mitigation:**
Add `delivery_status` enum to WorkspaceInvitation model: pending, sent, delivered, bounced, failed.

**Owner:** Backend Developer
**Timeline:** Nice to have, recommended for production

---

## Low Risks (Score 2-3)

### 13. BUS-002: No Member Join Notifications

**Score: 3 (Low)** üü¢
**Probability:** Low (1) - Doesn't affect core functionality
**Impact:** High (3) - Poor team awareness

**Description:**
Existing members aren't notified when new member joins workspace.

**Mitigation:**
Broadcast WebSocket event `member_joined` when invitation accepted.

**Owner:** Backend + Frontend Developer
**Timeline:** Nice to have

---

### 14. DATA-003: Missing Audit Trail

**Score: 3 (Low)** üü¢
**Probability:** Low (1) - Not required for MVP
**Impact:** High (3) - Compliance and debugging issues later

**Description:**
No audit log for invitation actions (who invited whom, when, who accepted).

**Mitigation:**
Create workspace_audit_log table for all permission changes.

**Owner:** Backend Developer
**Timeline:** Future story

---

### 15. TECH-001: Missing Import in Model Code

**Score: 2 (Low)** üü¢
**Probability:** High (2) - Found in code review
**Impact:** Low (1) - Code won't run

**Description:**
Line 176 uses `func.now()` but `func` is not imported.

**Mitigation:**
Add `from sqlalchemy import func` to imports.

**Owner:** Backend Developer
**Timeline:** Fix before development starts

---

## Risk Matrix

| Risk ID   | Category    | Description                        | Probability | Impact     | Score | Priority |
|-----------|-------------|------------------------------------|-------------|------------|-------|----------|
| SEC-001   | Security    | Rate limiting bypass               | High (3)    | High (3)   | 9     | Critical |
| DATA-001  | Data        | Last admin orphaning workspace     | High (3)    | High (3)   | 9     | Critical |
| SEC-002   | Security    | Email-to-account mismatch          | High (3)    | High (3)   | 9     | Critical |
| PERF-001  | Performance | Missing database indexes           | High (3)    | Medium (2) | 6     | High     |
| DATA-002  | Data        | Concurrent acceptance race         | Low (2)     | High (3)   | 6     | High     |
| OPS-001   | Operational | Database bloat from expired items  | High (3)    | Medium (2) | 6     | High     |
| SEC-003   | Security    | Celery task timeout missing        | Medium (2)  | High (3)   | 6     | High     |
| OPS-002   | Operational | Email config incomplete            | High (3)    | Medium (2) | 6     | High     |
| PERF-002  | Performance | Member list pagination missing     | Medium (2)  | Medium (2) | 4     | Medium   |
| BUS-001   | Business    | No resend invitation feature       | Medium (2)  | Medium (2) | 4     | Medium   |
| SEC-004   | Security    | Missing correlation IDs            | Medium (2)  | Medium (2) | 4     | Medium   |
| OPS-003   | Operational | No email delivery tracking         | Medium (2)  | Medium (2) | 4     | Medium   |
| BUS-002   | Business    | No member join notifications       | Low (1)     | High (3)   | 3     | Low      |
| DATA-003  | Data        | Missing audit trail                | Low (1)     | High (3)   | 3     | Low      |
| TECH-001  | Technical   | Missing import statement           | High (2)    | Low (1)    | 2     | Low      |

---

## Risk Distribution

### By Category
- **Security:** 4 risks (2 critical, 1 high, 1 medium)
- **Data:** 3 risks (1 critical, 1 high, 1 low)
- **Operational:** 3 risks (2 high, 1 medium)
- **Performance:** 2 risks (1 high, 1 medium)
- **Business:** 2 risks (2 medium)
- **Technical:** 1 risk (1 low)

### By Severity
- **Critical (9):** 3 risks - ALL must be fixed before production
- **High (6):** 5 risks - Should be fixed before production
- **Medium (4):** 4 risks - Can be addressed post-MVP with mitigations
- **Low (2-3):** 3 risks - Future enhancements

### By Component
- **Backend API:** 8 risks
- **Database:** 4 risks
- **Email Infrastructure:** 3 risks
- **Frontend:** 2 risks
- **DevOps/Config:** 2 risks

---

## Risk-Based Testing Strategy

### Priority 1: Critical Risk Tests (Must Pass)

**SEC-001: Rate Limiting**
- Test: Sending 51 invitations in 1 hour returns 429 error
- Test: 11 emails in single request returns 400 error
- Test: Rate limit resets after 1 hour window
- Load test: 100 concurrent invitation requests don't bypass limit

**DATA-001: Last Admin Protection**
- Test: Last admin cannot change own role to member (400 error)
- Test: Admin can change role when 2+ admins exist
- Test: Error message is clear and actionable
- E2E test: UI prevents action or shows error

**SEC-002: Email Mismatch**
- Test: Accepting invitation with wrong email returns detailed error
- Test: Error response includes both email addresses
- Test: Frontend displays helpful message with sign-out option
- Test: User can successfully accept after signing in with correct account

### Priority 2: High Risk Tests

**PERF-001: Database Performance**
- Test: Invitation lookup with 10,000 records completes in <100ms
- Test: Pending invitation list query uses indexes (EXPLAIN query)
- Load test: 100 concurrent invitation accepts don't degrade performance

**DATA-002: Race Condition**
- Test: Concurrent acceptance attempts result in only 1 membership
- Test: Second attempt returns 400 "already accepted"
- Load test: Simulate 10 simultaneous accepts of same invitation

**OPS-001: Cleanup Job**
- Test: Cleanup job deletes invitations expired >30 days ago
- Test: Cleanup job preserves accepted invitations
- Test: Cleanup job runs on schedule

**SEC-003: Celery Timeout**
- Test: Email task times out after 30 seconds if provider unresponsive
- Test: Task failure is logged and retried with exponential backoff
- Test: Celery worker doesn't hang on timeout

**OPS-002: Email Configuration**
- Test: Email sends successfully in development (Mailhog)
- Test: Email sends successfully in production (SendGrid)
- Test: Email template renders correctly with all variables
- Test: Bounce webhook updates invitation delivery status

### Priority 3: Medium/Low Risk Tests

- Member list pagination works correctly
- Resend button generates new token and email
- WebSocket notifications broadcast correctly
- Audit log captures all invitation actions

---

## Risk Acceptance Criteria

### Must Fix Before Production (P0)

**Critical Risks - ALL 3 MUST BE MITIGATED:**
1. ‚úÖ SEC-001: Implement rate limiting (50/hr, 10/request)
2. ‚úÖ DATA-001: Prevent last admin from demoting self
3. ‚úÖ SEC-002: Improve email mismatch UX with detailed errors

**High Risks - AT LEAST 4 OF 5 MUST BE MITIGATED:**
4. ‚úÖ PERF-001: Add database indexes (REQUIRED)
5. ‚úÖ DATA-002: Fix concurrent acceptance race (REQUIRED)
6. ‚úÖ OPS-001: Create cleanup job (REQUIRED)
7. ‚úÖ SEC-003: Add Celery timeout (REQUIRED)
8. ‚ö†Ô∏è OPS-002: Email provider config (can be partial if using console logging in dev)

### Can Deploy with Mitigation (P1)

**Medium Risks - Monitor in Production:**
9. PERF-002: Member list pagination (add if workspace >100 members)
10. BUS-001: Resend invitation (can handle via support tickets initially)
11. SEC-004: Correlation IDs (add logging, can enhance later)
12. OPS-003: Email delivery tracking (can add status field post-MVP)

### Accepted Risks (P2)

**Low Priority - Future Stories:**
13. BUS-002: Member join notifications (nice to have)
14. DATA-003: Audit trail (future compliance story)
15. TECH-001: Missing import (will be caught immediately during development)

---

## Monitoring Requirements

Post-deployment monitoring for identified risks:

### Performance Metrics (PERF Risks)
- Invitation creation latency (p50, p95, p99)
- Database query execution time for invitation lookups
- Member list page load time
- Alert: Query time >500ms

### Security Metrics (SEC Risks)
- Rate limit rejections per workspace per hour
- Email mismatch errors (track email domains)
- Failed invitation acceptance attempts
- Alert: >10 rate limit rejections from single IP

### Operational Metrics (OPS Risks)
- Expired invitation count (should trend toward 0 after cleanup job)
- Email delivery success rate
- Email bounce rate
- Celery task timeout count
- Alert: Email delivery success <95%

### Business Metrics (BUS Risks)
- Invitation acceptance rate
- Time from invitation to acceptance (median)
- Support tickets related to invitations
- Alert: Acceptance rate <60%

### Data Integrity Metrics (DATA Risks)
- Workspaces with 0 admins (should always be 0)
- Duplicate workspace memberships (should always be 0)
- Alert: Any workspace has 0 admins

---

## Risk Review Triggers

Update this risk profile when:

1. **Architecture Changes:**
   - Email provider changed
   - Authentication method changed
   - Database migration (PostgreSQL ‚Üí other)

2. **Security Events:**
   - Rate limiting bypassed
   - Email spam complaints received
   - Unauthorized invitation sends detected

3. **Performance Issues:**
   - Invitation queries >1 second
   - Email sending delays >5 minutes
   - Database bloat >100MB

4. **Regulatory Changes:**
   - GDPR/privacy requirements change
   - Email compliance rules updated
   - Audit requirements added

5. **Production Incidents:**
   - Any P0/P1 incident related to invitations
   - Data loss or corruption
   - Security breach

---

## Risk Mitigation Timeline

### Before Development Starts (Week 0)
- ‚úÖ Fix TECH-001: Add missing import
- ‚úÖ Clarify OPS-002: Email provider configuration

### During Development (Weeks 1-2)
- ‚úÖ Implement SEC-001: Rate limiting
- ‚úÖ Implement DATA-001: Last admin protection
- ‚úÖ Implement SEC-002: Email mismatch handling
- ‚úÖ Add PERF-001: Database indexes
- ‚úÖ Fix DATA-002: Race condition handling
- ‚úÖ Create OPS-001: Cleanup job
- ‚úÖ Add SEC-003: Celery timeout
- ‚ö†Ô∏è Add SEC-004: Correlation ID logging

### Before Production (Week 3)
- ‚úÖ All critical (9) and high (6) risks mitigated
- ‚úÖ Security testing completed
- ‚úÖ Load testing completed
- ‚úÖ Monitoring dashboards created
- ‚ö†Ô∏è Email provider configured and tested

### Post-MVP (Month 2+)
- PERF-002: Add pagination if needed
- BUS-001: Add resend feature
- OPS-003: Add delivery tracking
- BUS-002: Add join notifications
- DATA-003: Add audit trail

---

## Overall Risk Assessment

**Current Risk Score: 49/100** ‚ö†Ô∏è **HIGH RISK**

**Calculation:**
```
Base Score: 100
- Critical (9) √ó 3 = -60
- High (6) √ó 5 = -50
- Medium (4) √ó 4 = -20
- Low (2-3) √ó 3 = -9
Total Deduction: -139 (capped at 100)
Final Score: Max(0, 100 - 139) = 0 (before mitigations)

With planned mitigations:
Base Score: 100
- Unmitigated critical: 0 = 0
- Unmitigated high: 1 √ó 10 = -10 (OPS-002 partial)
- Unmitigated medium: 4 √ó 5 = -20
- Unmitigated low: 3 √ó 2 = -6
Final Score: 100 - 36 = 64/100 (after mitigations)
```

**Risk Trajectory:**
- Current (no mitigations): **0/100** - Cannot deploy
- After P0 fixes: **64/100** - Can deploy to production with monitoring
- After P1 fixes: **78/100** - Production-ready
- After P2 fixes: **94/100** - Enterprise-grade

---

## Recommendations for Development Team

### Immediate Actions (Before Code is Written)
1. Add 7 new acceptance criteria (AC 14-20) addressing critical risks
2. Add Task 14 for cleanup job
3. Update Task 1 to include database indexes
4. Update Task 2 to include rate limiting
5. Update Task 9 to include last admin protection
6. Update Task 7 to include email mismatch UX
7. Fix model code import statement

### During Development
1. Prioritize critical risk mitigations first
2. Write security tests before writing code (TDD for SEC risks)
3. Load test invitation endpoints with 1,000+ records
4. Set up staging environment with real email provider
5. Create monitoring dashboards for all metrics listed above

### Before Production Deployment
1. Verify all 3 critical risks are mitigated
2. Verify at least 4 of 5 high risks are mitigated
3. Run full security test suite
4. Run load tests with realistic data volumes
5. Configure production monitoring and alerts
6. Create runbook for invitation-related incidents

---

## Gate Integration

**Risk-Based Gate Decision:**

```yaml
# For pasting into gate file:
risk_summary:
  totals:
    critical: 3  # score 9
    high: 5      # score 6
    medium: 4    # score 4
    low: 3       # score 2-3
  highest:
    id: SEC-001
    score: 9
    title: 'Invitation abuse via rate limiting bypass'
  recommendations:
    must_fix:
      - 'Implement rate limiting (50/hr workspace, 10/request)'
      - 'Prevent last admin from demoting self'
      - 'Improve email mismatch error UX'
      - 'Add database indexes to invitation model'
      - 'Fix concurrent acceptance race condition'
      - 'Create expired invitation cleanup job'
      - 'Add Celery task timeout'
    monitor:
      - 'Email delivery success rate'
      - 'Rate limit rejection rate'
      - 'Invitation acceptance rate'
      - 'Workspaces with 0 admins (should be 0)'
```

**Deterministic Gate Decision:**
- Current state: **FAIL** (3 risks with score ‚â• 9)
- After P0 mitigations: **CONCERNS** (1 high risk partially mitigated)
- After P1 mitigations: **PASS**

---

**End of Risk Profile**

**Review Status:** Complete
**Next Review:** After critical risk mitigations implemented
**File Location:** `docs/qa/assessments/2.2-risk-20251025.md`
