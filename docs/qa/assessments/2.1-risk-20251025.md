# Risk Profile: Story 2.1 - Workspace Creation & Management

**Date:** 2025-10-25
**Reviewer:** Quinn (Test Architect)
**Story:** 2.1 - Workspace Creation & Management
**Status:** Draft

---

## Executive Summary

- **Total Risks Identified:** 12
- **Critical Risks:** 1 (OPS-001)
- **High Risks:** 5 (SEC-001, PERF-001, DATA-001, DATA-003, BUS-001)
- **Medium Risks:** 4 (SEC-003, PERF-002, TECH-001, OPS-002)
- **Low Risks:** 2 (SEC-004, DATA-002)
- **Overall Risk Score:** 6/100 (High-risk story requiring significant mitigation)

### Key Concerns

This story involves **destructive operations** (cascade deletion), **authorization controls**, and **real-time synchronization** - all high-risk areas. The most critical concern is the **irreversible nature of workspace deletion** without adequate backup/recovery mechanisms.

**Recommendation:** Implement comprehensive mitigation strategies before production deployment, particularly around data protection and authorization.

---

## Critical Risks Requiring Immediate Attention

### 1. OPS-001: No Backup/Recovery for Deleted Workspaces

**Score: 9 (Critical)**
**Category:** Operational
**Probability:** High (3) - Users will inevitably delete workspaces accidentally
**Impact:** High (3) - Complete, irreversible data loss of workspaces, boards, and cards

**Description:**
The current design implements hard deletion with cascade to all boards, cards, and memberships. While a confirmation modal requires typing the workspace name, this provides minimal protection against:
- Typos in workspace names being auto-confirmed
- User fatigue clicking through confirmations
- Misunderstanding of consequences ("I can restore it later")
- Malicious insider actions

**Affected Components:**
- `backend/app/services/workspace_service.py` - `delete_workspace()` method
- `backend/app/api/workspaces.py` - `DELETE /workspaces/{id}` endpoint
- Database cascade delete configuration

**Mitigation Strategy:** Preventive + Detective

**Required Actions:**
1. **Implement soft-delete pattern** (MUST FIX)
   - Add `deleted_at` timestamp to `workspaces` table
   - Modify queries to filter out deleted workspaces by default
   - Implement `DELETE /workspaces/{id}` to set `deleted_at` instead of hard delete
   - Add background job to permanently delete after 30-day retention period

2. **Add workspace archival/restore API** (MUST FIX)
   - `POST /workspaces/{id}/archive` - soft delete endpoint
   - `POST /workspaces/{id}/restore` - restore within retention period
   - Admin-only access to archived workspace list

3. **Implement audit logging** (MUST FIX)
   - Log all workspace deletion events with: user ID, timestamp, workspace metadata
   - Store in separate audit table not affected by cascade deletes
   - Include snapshot of workspace structure (board count, card count, member list)

4. **Database backups** (MUST FIX)
   - Configure automated daily database backups
   - Document recovery procedures in runbook
   - Test restore procedures in staging environment

5. **Enhanced confirmation flow** (SHOULD FIX)
   - Require admin to acknowledge: "I understand this will delete X boards and Y cards"
   - Add checkbox: "I have exported or backed up important data"
   - Send email confirmation with 24-hour undo link

**Testing Requirements:**
- Unit test: Soft delete sets `deleted_at` without removing record
- Integration test: Deleted workspaces excluded from queries
- Integration test: Restore workspace functionality
- E2E test: Full archive → restore → delete permanently workflow
- Manual test: Database backup and restore procedure

**Residual Risk:** Low - With soft delete and backups, data recovery is possible within retention window

**Owner:** Backend Dev + DevOps
**Timeline:** Before production deployment (Story blocker)

---

### 2. SEC-001: Authorization Bypass on Admin Operations

**Score: 6 (High)**
**Category:** Security
**Probability:** Medium (2) - Authorization logic exists but needs thorough testing
**Impact:** High (3) - Non-admins could delete workspaces, causing data loss and security breach

**Description:**
The story implements admin-only operations (update workspace, delete workspace) with permission checks in `_check_admin()` method. However, authorization bugs are common and could allow:
- Direct API calls bypassing checks
- Race conditions between permission check and operation
- JWT token manipulation to escalate privileges
- Missing checks on related endpoints (e.g., cascade operations)

**Affected Components:**
- `backend/app/services/workspace_service.py` - `_check_admin()` method
- `backend/app/api/workspaces.py` - PATCH and DELETE endpoints
- `backend/app/api/dependencies.py` - Permission helper functions
- Frontend settings page authorization UI

**Mitigation Strategy:** Preventive + Detective

**Required Actions:**
1. **Comprehensive authorization testing** (MUST FIX)
   - Security test: Non-admin attempts to PATCH/DELETE workspace (expect 403)
   - Security test: Removed admin attempts operations (expect 403)
   - Security test: Expired JWT token attempts operations (expect 401)
   - Fuzz test: Malformed workspace IDs and user IDs

2. **Defense in depth** (SHOULD FIX)
   - Add authorization check at service layer AND API layer (currently only service)
   - Add database-level RLS (Row Level Security) policies in PostgreSQL
   - Implement rate limiting on delete endpoints to prevent automation

3. **Frontend authorization enforcement** (SHOULD FIX)
   - Hide delete/edit UI elements from non-admins (already planned)
   - Verify user role on every settings page load
   - Show clear "Permission Denied" message if user navigates directly to URL

4. **Audit logging for authorization failures** (SHOULD FIX)
   - Log all 403 Forbidden responses with user ID, attempted operation
   - Alert on multiple authorization failures from same user (potential attack)

**Testing Requirements:**
- Unit test: `_check_admin()` raises 403 for non-admins
- Unit test: `_check_admin()` raises 403 when user not in workspace
- Integration test: DELETE /workspaces/{id} with non-admin token returns 403
- Integration test: PATCH /workspaces/{id} with member token returns 403
- Security test: Token manipulation attempts
- E2E test: Non-admin user cannot access settings page

**Residual Risk:** Low - Layered authorization checks provide strong protection

**Owner:** Backend Dev + Security Review
**Timeline:** Before production deployment

---

### 3. PERF-001: Cascade Delete Performance on Large Datasets

**Score: 6 (High)**
**Category:** Performance
**Probability:** Medium (2) - Likely as workspaces grow
**Impact:** High (3) - Database locks, timeouts, degraded performance for all users

**Description:**
The cascade delete operation (`DELETE FROM workspaces WHERE id = ?`) will trigger cascading deletes to:
- `workspace_members` table (potentially hundreds of records)
- `boards` table (potentially dozens of boards)
- `cards` table (potentially thousands of cards)
- `card_assignments`, `card_labels`, `comments` (potentially tens of thousands)

For a large workspace (e.g., 50 boards, 5,000 cards), this could:
- Lock tables for several seconds
- Time out (default HTTP timeout: 30 seconds)
- Block other workspace operations
- Generate massive transaction logs

**Affected Components:**
- `backend/app/services/workspace_service.py` - `delete_workspace()` method
- Database cascade delete configuration in SQLAlchemy models
- PostgreSQL transaction handling

**Mitigation Strategy:** Preventive + Detective

**Required Actions:**
1. **Implement asynchronous deletion** (MUST FIX)
   - Convert `DELETE /workspaces/{id}` to queue a background job
   - Use Celery or similar task queue
   - Return 202 Accepted with job ID immediately
   - Background worker performs actual deletion with progress tracking
   - WebSocket notification when deletion completes

2. **Add deletion progress tracking** (SHOULD FIX)
   - Track deletion state: `queued` → `in_progress` → `completed` / `failed`
   - Show progress bar in UI: "Deleting workspace... (45 of 100 boards deleted)"
   - Allow cancellation during deletion (revert to archived state)

3. **Optimize cascade delete queries** (MUST FIX)
   - Batch delete cards in chunks (e.g., 1,000 at a time)
   - Use `DELETE ... RETURNING id` to track progress
   - Add database indexes on foreign keys if missing
   - Set `statement_timeout` to prevent runaway queries

4. **Load testing** (MUST FIX)
   - Test deletion with workspace containing 100 boards, 10,000 cards
   - Measure deletion time and database load
   - Verify no table locks blocking other operations
   - Test concurrent deletions (multiple users deleting different workspaces)

5. **Set workspace size limits** (SHOULD FIX)
   - Warn users when workspace exceeds recommended size (e.g., 50 boards)
   - Consider enforcing hard limits (e.g., 100 boards per workspace)
   - Suggest creating multiple workspaces for very large teams

**Testing Requirements:**
- Load test: Delete workspace with 10,000+ cards, measure time < 5 seconds (async)
- Load test: Concurrent deletions do not deadlock
- Integration test: Background job successfully deletes all cascaded records
- Integration test: Deletion job failure rolls back changes
- Monitoring: Alert on deletion jobs exceeding 60 seconds

**Residual Risk:** Low - Async deletion with batching handles large datasets gracefully

**Owner:** Backend Dev + Performance Testing
**Timeline:** Before production deployment

---

### 4. DATA-001: Transaction Failure During Cascade Delete

**Score: 6 (High)**
**Category:** Data Integrity
**Probability:** Medium (2) - Possible during database failures or constraint violations
**Impact:** High (3) - Orphaned records, data inconsistency, corrupted database state

**Description:**
The cascade delete involves multiple related tables. If the transaction fails midway (database crash, constraint violation, timeout), it could leave:
- Orphaned boards with `workspace_id` referencing deleted workspace
- Orphaned cards with `board_id` referencing deleted board
- Workspace_members records pointing to non-existent workspace
- Inconsistent counts and broken foreign key relationships

**Affected Components:**
- `backend/app/services/workspace_service.py` - `delete_workspace()` transaction
- SQLAlchemy cascade delete configuration
- Database transaction isolation level

**Mitigation Strategy:** Preventive + Corrective

**Required Actions:**
1. **Ensure proper transaction management** (MUST FIX)
   - Verify `async with self.db.begin()` wraps entire delete operation
   - Set transaction isolation level to `SERIALIZABLE` for deletes
   - Add explicit rollback on any exception
   - Test rollback behavior with simulated failures

2. **Verify cascade delete configuration** (MUST FIX)
   - Confirm `cascade="all, delete-orphan"` on all relationships
   - Add database-level `ON DELETE CASCADE` constraints (belt + suspenders)
   - Test that deleting workspace automatically deletes all children
   - Verify no orphaned records after deletion

3. **Add data integrity checks** (SHOULD FIX)
   - Background job to detect orphaned records
   - Query: `SELECT * FROM boards WHERE workspace_id NOT IN (SELECT id FROM workspaces)`
   - Automated cleanup of orphaned records (if safe) or alert
   - Include in health check endpoint

4. **Implement compensating transactions** (SHOULD FIX)
   - If delete fails, mark workspace as `delete_failed` state
   - Allow retry of failed deletion
   - Manual admin intervention for stuck deletions

5. **Database monitoring** (MUST FIX)
   - Monitor transaction rollback rate
   - Alert on failed delete operations
   - Track orphaned record count as metric

**Testing Requirements:**
- Integration test: Simulate database disconnect during delete, verify rollback
- Integration test: Verify all cascaded records deleted (boards, cards, members)
- Unit test: Exception during delete triggers rollback
- Chaos test: Kill database connection mid-transaction
- SQL query test: Verify no orphaned records after 100 create/delete cycles

**Residual Risk:** Low - Proper transaction management and DB constraints prevent orphans

**Owner:** Backend Dev + DBA
**Timeline:** Before production deployment

---

### 5. DATA-003: No Audit Trail or Soft-Delete

**Score: 6 (High)**
**Category:** Data / Compliance
**Probability:** High (3) - Current design lacks audit trail
**Impact:** Medium (2) - Compliance violations, inability to investigate incidents

**Description:**
The current design provides no audit trail or soft-delete mechanism. This creates:
- **Compliance risk:** GDPR, SOC 2, HIPAA often require audit logs of data changes
- **Forensic gaps:** No way to investigate "Who deleted this workspace?"
- **Support challenges:** No way to help users recover accidentally deleted data
- **Security blind spots:** Cannot detect malicious insider deletions

**Affected Components:**
- All workspace mutation operations (create, update, delete)
- Database schema (no audit tables)
- Compliance/regulatory requirements

**Mitigation Strategy:** Preventive + Detective

**Required Actions:**
1. **Implement comprehensive audit logging** (MUST FIX)
   - Create `audit_log` table with: entity_type, entity_id, action, user_id, timestamp, old_value, new_value
   - Log all workspace operations: CREATE, UPDATE, DELETE, ARCHIVE, RESTORE
   - Include metadata: IP address, user agent, impersonation status
   - Make audit log immutable (append-only, no UPDATE/DELETE)

2. **Add soft-delete pattern** (MUST FIX - overlaps with OPS-001)
   - Add `deleted_at` timestamp to workspaces table
   - Keep deleted records for retention period (30 days)
   - Allow admin restore within retention period
   - Background job for permanent deletion after retention

3. **Implement audit log API** (SHOULD FIX)
   - `GET /workspaces/{id}/audit-log` - view workspace history
   - `GET /audit-log?user_id={id}` - view user's actions
   - Admin-only access
   - Paginated results with filtering

4. **Retention policy** (MUST FIX)
   - Define retention periods: audit logs (7 years?), soft-deleted workspaces (30 days)
   - Document in privacy policy
   - Automated cleanup jobs
   - Comply with regulatory requirements (GDPR right to erasure vs. audit requirements)

5. **Monitoring and alerting** (SHOULD FIX)
   - Alert on bulk deletions (e.g., >5 workspaces by same user in 1 hour)
   - Alert on deletions by newly-created admin accounts
   - Dashboard showing deletion trends

**Testing Requirements:**
- Integration test: All workspace operations create audit log entries
- Unit test: Audit log cannot be modified or deleted
- Integration test: Soft-deleted workspaces excluded from normal queries
- E2E test: Admin can view audit log and restore workspace
- Compliance test: Audit log meets regulatory requirements (consult legal)

**Residual Risk:** Low - Comprehensive audit trail supports compliance and forensics

**Owner:** Backend Dev + Compliance Team
**Timeline:** Before production deployment

---

### 6. BUS-001: Accidental Workspace Deletion

**Score: 6 (High)**
**Category:** Business Risk
**Probability:** Medium (2) - Confirmation modal helps but not foolproof
**Impact:** High (3) - User data loss, customer dissatisfaction, churn risk

**Description:**
Despite the confirmation modal requiring exact workspace name entry, users can still accidentally delete workspaces due to:
- **Similar workspace names:** "Marketing 2024" vs "Marketing 2025"
- **User confusion:** Thinking they're archiving, not deleting
- **Hasty actions:** Quickly typing name without reading consequences
- **Mobile typos:** Autocorrect changing workspace name to match
- **Shared accounts:** User deletes workspace another team member needs

**Affected Components:**
- `frontend/src/components/workspace/delete-workspace-modal.tsx`
- User experience and information architecture
- Customer support procedures

**Mitigation Strategy:** Preventive + Corrective

**Required Actions:**
1. **Enhanced confirmation flow** (MUST FIX)
   - Show workspace statistics in confirmation modal: "This will delete 15 boards, 342 cards, and remove 8 members"
   - Require clicking "I understand" checkboxes:
     - [ ] I understand this action is permanent
     - [ ] I have exported or backed up important data
     - [ ] I have notified all workspace members
   - Add 5-second timer before "Delete" button becomes enabled (prevent hasty clicks)

2. **Implement soft-delete with grace period** (MUST FIX - overlaps with OPS-001)
   - Convert "Delete" to "Archive" for user-facing action
   - Archived workspaces hidden from normal view but recoverable
   - Admin can restore from "Archived Workspaces" page
   - After 30 days, permanent deletion occurs (with email notification)

3. **Pre-deletion export** (SHOULD FIX)
   - Offer "Export workspace data" button in deletion modal
   - Generate JSON export of all workspace data (boards, cards, members)
   - Download automatically before deletion proceeds
   - Store export in user's account for 30 days

4. **Notification system** (SHOULD FIX)
   - Send email to all workspace members: "{User} has scheduled {Workspace} for deletion"
   - Include "Undo Deletion" link (valid for 24 hours)
   - Require admin confirmation via email link (prevent CSRF)

5. **Alternative to deletion** (SHOULD FIX)
   - Offer "Transfer Ownership" option before allowing deletion
   - Suggest archiving inactive workspaces instead of deleting
   - Allow removing individual boards instead of entire workspace

6. **Customer support runbook** (MUST FIX)
   - Document recovery procedures for support team
   - SLA for recovery requests (e.g., respond within 4 hours)
   - Escalation path for critical data recovery

**Testing Requirements:**
- UX test: User comprehension of deletion consequences (user testing)
- E2E test: Confirmation modal displays correct counts
- Integration test: Archive workspace instead of immediate delete
- E2E test: Email notification sent to all members
- E2E test: Undo deletion link restores workspace

**Residual Risk:** Medium - Human error will still occur, but grace period allows recovery

**Owner:** Frontend Dev + UX Designer + Product Manager
**Timeline:** Before production deployment

---

## Medium-Priority Risks

### 7. SEC-003: WebSocket Authorization Gaps

**Score: 4 (Medium)**
**Category:** Security
**Probability:** Medium (2) - Real-time features often have auth gaps
**Impact:** Medium (2) - Unauthorized users could view workspace updates

**Description:**
The story includes WebSocket support for real-time workspace updates. Common issues:
- Users subscribing to workspaces they're not members of
- Authentication not re-verified after initial connection
- Room-based access control not properly enforced

**Mitigation:**
- Verify workspace membership when client subscribes to workspace room
- Re-authenticate WebSocket connections periodically
- Test unauthorized subscription attempts (expect rejection)
- Audit log WebSocket connections and subscriptions

**Testing:** Security test WebSocket subscription with non-member token (expect 403)

---

### 8. PERF-002: N+1 Query Problem Loading Workspace Lists

**Score: 4 (Medium)**
**Category:** Performance
**Probability:** Medium (2) - Common in ORM code
**Impact:** Medium (2) - Slow page loads, increased database load

**Description:**
Loading workspace list may trigger separate queries for each workspace's board count and member count, causing N+1 query problem.

**Mitigation:**
- Use SQLAlchemy `selectinload()` or `joinedload()` to eager-load relationships
- Add `func.count()` aggregations to workspace query
- Test query count: loading 10 workspaces should execute ≤3 queries (not 21+)
- Monitor query performance with database slow query log

**Testing:** Integration test verifies workspace list loads with <3 database queries

---

### 9. TECH-001: Complex Transaction Management

**Score: 4 (Medium)**
**Category:** Technical
**Probability:** Medium (2) - Async transactions can be tricky
**Impact:** Medium (2) - Bugs could cause data inconsistency

**Description:**
The story requires complex transaction management (create workspace + membership, delete workspace + cascade). Async SQLAlchemy transactions have edge cases.

**Mitigation:**
- Ensure all service methods use `async with self.db.begin()` for transactions
- Test transaction rollback on exceptions
- Use explicit `await self.db.flush()` before operations depending on generated IDs
- Add integration tests for all transaction paths (success + failure)

**Testing:** Integration test simulates exceptions during transactions, verifies rollback

---

### 10. OPS-002: Insufficient Monitoring for Delete Operations

**Score: 4 (Medium)**
**Category:** Operational
**Probability:** Medium (2) - Monitoring often added as afterthought
**Impact:** Medium (2) - Issues not detected until user reports

**Description:**
No monitoring or alerting for workspace deletions could delay detection of:
- Malicious bulk deletions
- Performance degradation during large deletes
- Failed deletion jobs

**Mitigation:**
- Add metrics: workspace_deletions_total, workspace_deletion_duration_seconds
- Alert on anomalies: >10 deletions in 1 hour, deletion duration >60 seconds
- Dashboard showing deletion trends over time
- Include deletion job status in health check endpoint

**Testing:** Verify metrics emitted for workspace deletion operations

---

## Low-Priority Risks

### 11. SEC-004: SQL Injection via Workspace Name

**Score: 3 (Low)**
**Category:** Security
**Probability:** Low (1) - Pydantic validation + parameterized queries provide protection
**Impact:** High (3) - Could lead to data breach or database compromise

**Description:**
Workspace name input could theoretically be used for SQL injection if not properly parameterized.

**Mitigation:**
- SQLAlchemy uses parameterized queries by default (already protected)
- Pydantic validation enforces max length and type constraints
- Test with SQL injection payloads (e.g., `'; DROP TABLE workspaces; --`)
- Security scanning with OWASP ZAP or similar tool

**Testing:** Security test with malicious workspace names (expect safe handling)

---

### 12. DATA-002: Race Conditions on Concurrent Workspace Updates

**Score: 2 (Low)**
**Category:** Data Integrity
**Probability:** Low (1) - Rare for users to simultaneously update same workspace
**Impact:** Medium (2) - Last write wins, could lose updates

**Description:**
If two admins simultaneously update workspace name, one update could overwrite the other.

**Mitigation:**
- Implement optimistic locking with `updated_at` version field
- Return 409 Conflict if update timestamp doesn't match
- Frontend shows "Workspace was updated by another user, please refresh" message
- WebSocket update triggers refresh of workspace data

**Testing:** Integration test simulating concurrent updates, verify conflict detection

---

## Risk Distribution Summary

### By Category

| Category    | Total Risks | Critical | High | Medium | Low |
|-------------|-------------|----------|------|--------|-----|
| Security    | 3           | 0        | 1    | 1      | 1   |
| Performance | 2           | 0        | 1    | 1      | 0   |
| Data        | 3           | 0        | 2    | 0      | 1   |
| Business    | 1           | 0        | 1    | 0      | 0   |
| Operational | 2           | 1        | 0    | 1      | 0   |
| Technical   | 1           | 0        | 0    | 1      | 0   |
| **Total**   | **12**      | **1**    | **5**| **4**  | **2**|

### By Component

| Component                | Risk Count | Highest Risk |
|--------------------------|------------|--------------|
| Backend Deletion Logic   | 4          | OPS-001 (9)  |
| Backend Authorization    | 2          | SEC-001 (6)  |
| Database Schema/Queries  | 3          | PERF-001 (6) |
| Frontend Confirmation UI | 1          | BUS-001 (6)  |
| WebSocket Real-Time      | 1          | SEC-003 (4)  |
| Monitoring/Operations    | 1          | OPS-002 (4)  |

---

## Risk-Based Testing Strategy

### Priority 1: Critical Risk Tests (Must Pass Before Production)

#### OPS-001: Data Recovery Testing
- **Test:** Delete workspace, verify soft-delete sets `deleted_at` (not hard delete)
- **Test:** Restore deleted workspace within 30-day window, verify full data recovery
- **Test:** Perform database backup, simulate workspace deletion, restore from backup
- **Test:** Background job permanently deletes workspaces after 30 days
- **Expected:** 100% data recovery within retention period

#### SEC-001: Authorization Testing
- **Test:** Non-admin attempts `DELETE /workspaces/{id}` (expect 403 Forbidden)
- **Test:** Non-admin attempts `PATCH /workspaces/{id}` (expect 403 Forbidden)
- **Test:** User removed from workspace attempts admin operations (expect 403)
- **Test:** Expired/invalid JWT token attempts operations (expect 401)
- **Test:** Fuzz test with malformed workspace IDs, user IDs (expect proper error handling)
- **Expected:** Zero authorization bypasses

#### PERF-001: Load Testing
- **Test:** Create workspace with 100 boards, 10,000 cards
- **Test:** Delete workspace, measure time (async endpoint should return <500ms)
- **Test:** Background deletion job completes within 60 seconds
- **Test:** Concurrent deletions (5 users deleting different large workspaces simultaneously)
- **Test:** Verify no database locks blocking other workspace operations
- **Expected:** <500ms response time, no deadlocks

#### DATA-001: Transaction Integrity Testing
- **Test:** Simulate database disconnect during cascade delete (verify rollback)
- **Test:** Query for orphaned boards: `SELECT * FROM boards WHERE workspace_id NOT IN (SELECT id FROM workspaces WHERE deleted_at IS NULL)` (expect 0 rows)
- **Test:** Delete workspace, verify ALL related records removed (boards, cards, members, etc.)
- **Test:** Delete transaction throws exception, verify full rollback
- **Expected:** Zero orphaned records, atomic transactions

---

### Priority 2: High Risk Tests

#### DATA-003: Audit Logging Tests
- **Test:** Create/update/delete workspace, verify audit log entry created
- **Test:** Audit log includes: user_id, timestamp, action, old/new values
- **Test:** Attempt to modify audit log (expect failure - append-only)
- **Test:** Admin retrieves workspace audit history via API
- **Expected:** Complete audit trail for all operations

#### BUS-001: UX Safety Tests
- **Test:** Deletion modal shows correct counts (boards, cards, members)
- **Test:** "Delete" button disabled until all checkboxes confirmed
- **Test:** Email sent to all workspace members on deletion
- **Test:** "Undo deletion" link in email restores workspace
- **Test:** Export workspace data before deletion
- **Expected:** Multi-layered protection against accidental deletion

---

### Priority 3: Medium Risk Tests

#### SEC-003: WebSocket Security Tests
- **Test:** Non-member attempts to subscribe to workspace room (expect rejection)
- **Test:** User removed from workspace automatically unsubscribed from room
- **Test:** WebSocket authentication token expiration handled gracefully
- **Expected:** No unauthorized workspace updates received

#### PERF-002: Query Optimization Tests
- **Test:** Load 20 workspaces, count database queries (expect ≤3 queries total)
- **Test:** Measure response time for `GET /workspaces` with 50 workspaces (expect <200ms)
- **Expected:** No N+1 queries

#### TECH-001: Transaction Tests
- **Test:** Create workspace, verify membership created in same transaction
- **Test:** Transaction rollback on exception during create
- **Test:** Concurrent creates by same user don't create duplicate memberships
- **Expected:** Atomic transactions, no partial commits

#### OPS-002: Monitoring Tests
- **Test:** Delete workspace, verify `workspace_deletions_total` metric incremented
- **Test:** Deletion duration recorded in `workspace_deletion_duration_seconds` histogram
- **Test:** Alert triggered when >10 deletions occur in 1 hour
- **Expected:** All operations monitored and alertable

---

### Priority 4: Low Risk Tests

#### SEC-004: Input Validation Tests
- **Test:** Submit workspace name with SQL injection payload: `'; DROP TABLE users; --`
- **Test:** Submit workspace name exceeding 100 characters (expect validation error)
- **Test:** Submit empty/whitespace-only workspace name (expect validation error)
- **Expected:** All malicious input safely handled

#### DATA-002: Concurrency Tests
- **Test:** Two admins simultaneously update workspace name
- **Test:** Optimistic locking returns 409 Conflict for stale update
- **Test:** WebSocket update triggers UI refresh showing latest data
- **Expected:** Conflict detection prevents lost updates

---

## Test Coverage Requirements

### Unit Tests (Backend)
- [ ] `WorkspaceService.create_workspace()` creates workspace + admin membership atomically
- [ ] `WorkspaceService._check_admin()` raises 403 for non-admins
- [ ] `WorkspaceService._check_admin()` raises 403 for non-members
- [ ] `WorkspaceService.delete_workspace()` soft-deletes (sets `deleted_at`)
- [ ] `WorkspaceService.delete_workspace()` raises 403 for non-admins
- [ ] Pydantic validation rejects empty workspace names
- [ ] Pydantic validation rejects names >100 characters

**Target:** >90% code coverage for workspace service

### Integration Tests (API)
- [ ] `POST /workspaces` creates workspace and returns 201
- [ ] `POST /workspaces` without auth returns 401
- [ ] `GET /workspaces` returns only user's workspaces
- [ ] `DELETE /workspaces/{id}` soft-deletes workspace
- [ ] `DELETE /workspaces/{id}` with non-admin token returns 403
- [ ] `PATCH /workspaces/{id}` updates name and returns 200
- [ ] `PATCH /workspaces/{id}` with non-admin token returns 403
- [ ] Deleting workspace cascades to boards, cards, memberships
- [ ] Audit log created for all workspace operations

**Target:** 100% endpoint coverage

### Component Tests (Frontend)
- [ ] Create workspace modal validates required name field
- [ ] Create workspace modal enforces 100 character limit
- [ ] Create workspace modal shows loading state during submission
- [ ] Create workspace modal redirects to workspace dashboard on success
- [ ] Delete workspace modal requires exact name match
- [ ] Delete workspace modal shows workspace statistics (board/card count)
- [ ] Delete workspace modal disables "Delete" button until confirmation
- [ ] Settings page hidden from non-admins

**Target:** >85% component coverage

### End-to-End Tests
- [ ] Full workflow: Create workspace → Add board → Delete workspace → Verify cascade
- [ ] Full workflow: Create workspace → Update name → Verify real-time update via WebSocket
- [ ] Full workflow: Delete workspace → Restore from archive → Verify data intact
- [ ] Authorization: Non-admin cannot access settings page
- [ ] Authorization: Non-admin cannot delete workspace (UI + API)

**Target:** All critical user journeys covered

### Security Tests
- [ ] OWASP ZAP scan of workspace endpoints (no critical findings)
- [ ] Penetration test: Authorization bypass attempts (all blocked)
- [ ] Penetration test: SQL injection in workspace name (safely handled)
- [ ] Penetration test: WebSocket unauthorized subscriptions (rejected)

**Target:** Zero critical/high severity findings

### Load/Performance Tests
- [ ] Create 100 workspaces, measure response time (p95 < 500ms)
- [ ] Delete workspace with 10,000 cards, measure job duration (< 60 seconds)
- [ ] Load workspace list with 50 workspaces, verify query count (≤3 queries)
- [ ] Concurrent workspace operations (50 users), measure throughput

**Target:** p95 < 500ms for all operations, no deadlocks

---

## Risk Acceptance Criteria

### Must Fix Before Production (Blockers)

1. **OPS-001:** Implement soft-delete + 30-day retention + restore API
2. **SEC-001:** Pass all authorization tests (0% bypass rate)
3. **PERF-001:** Async deletion with <500ms response time
4. **DATA-001:** Zero orphaned records after deletion
5. **DATA-003:** Audit logging for all workspace operations

**Gate Status if Not Fixed:** FAIL

---

### Should Fix Before Production (Strongly Recommended)

1. **BUS-001:** Enhanced confirmation flow with checkboxes + export
2. **SEC-003:** WebSocket authorization for room subscriptions
3. **PERF-002:** Eager loading to eliminate N+1 queries
4. **TECH-001:** Comprehensive transaction testing
5. **OPS-002:** Monitoring metrics and alerting

**Gate Status if Not Fixed:** CONCERNS

---

### Can Deploy with Mitigation (Nice-to-Have)

1. **SEC-004:** SQL injection testing (already protected by ORM)
2. **DATA-002:** Optimistic locking for concurrent updates

**Gate Status if Not Fixed:** PASS with monitoring

---

### Accepted Risks

None at this time. All identified risks should be addressed or actively monitored.

---

## Monitoring Requirements

### Post-Deployment Metrics

**Workspace Operations:**
- `workspace_created_total` (counter)
- `workspace_deleted_total` (counter)
- `workspace_restored_total` (counter)
- `workspace_deletion_duration_seconds` (histogram)

**Authorization Events:**
- `workspace_authorization_denied_total` (counter, labels: operation, reason)

**Data Integrity:**
- `orphaned_records_count` (gauge, daily check)

**Performance:**
- `workspace_query_duration_seconds` (histogram, by endpoint)
- `cascade_delete_records_deleted` (histogram)

### Alerts

**Critical Alerts (Page On-Call):**
- Deletion job duration >60 seconds
- Orphaned records detected (count >0)
- Authorization failure rate >10% (potential attack)
- Database transaction rollback rate >5%

**Warning Alerts (Slack Notification):**
- Bulk deletions: >10 workspaces deleted by same user in 1 hour
- Workspace creation rate spike (>100 in 5 minutes)
- Workspace query p95 latency >500ms

### Dashboard Widgets

1. **Workspace Operations Timeline:** Line chart showing creates/deletes/restores over time
2. **Deletion Job Performance:** Histogram of deletion duration
3. **Top Workspace Deleters:** Table showing users with most deletions (last 30 days)
4. **Authorization Denials:** Bar chart by operation type
5. **Data Integrity:** Orphaned record count (should always be 0)

---

## Risk Review Triggers

Re-assess this risk profile when:

1. **Architecture changes:**
   - Change from soft-delete to hard-delete (or vice versa)
   - Migration to different database (e.g., PostgreSQL → MySQL)
   - Change to cascade delete configuration

2. **New integrations:**
   - Third-party backup services
   - External audit logging systems
   - SSO/SAML authentication providers

3. **Security events:**
   - Authorization bypass vulnerability discovered
   - Unauthorized deletion incident
   - Database breach or exposure

4. **Performance issues:**
   - User reports of slow deletions
   - Database lock timeouts
   - Cascade delete failures

5. **Regulatory changes:**
   - New data retention requirements (GDPR, SOC 2, etc.)
   - Audit trail requirements updated
   - Privacy law changes

6. **Scale milestones:**
   - >10,000 workspaces in system
   - Average workspace size >50 boards
   - First workspace with >10,000 cards

---

## Appendix: Detailed Risk Register

| Risk ID  | Category    | Title                                   | Probability | Impact     | Score | Mitigation Status  |
|----------|-------------|-----------------------------------------|-------------|------------|-------|--------------------|
| OPS-001  | Operational | No backup/recovery for deletions        | High (3)    | High (3)   | 9     | Required (blocker) |
| SEC-001  | Security    | Authorization bypass on admin ops       | Medium (2)  | High (3)   | 6     | Required (blocker) |
| PERF-001 | Performance | Cascade delete performance              | Medium (2)  | High (3)   | 6     | Required (blocker) |
| DATA-001 | Data        | Transaction failure during cascade      | Medium (2)  | High (3)   | 6     | Required (blocker) |
| DATA-003 | Data        | No audit trail                          | High (3)    | Medium (2) | 6     | Required (blocker) |
| BUS-001  | Business    | Accidental deletion                     | Medium (2)  | High (3)   | 6     | Recommended        |
| SEC-003  | Security    | WebSocket authorization gaps            | Medium (2)  | Medium (2) | 4     | Recommended        |
| PERF-002 | Performance | N+1 query problem                       | Medium (2)  | Medium (2) | 4     | Recommended        |
| TECH-001 | Technical   | Complex transaction management          | Medium (2)  | Medium (2) | 4     | Recommended        |
| OPS-002  | Operational | Insufficient monitoring                 | Medium (2)  | Medium (2) | 4     | Recommended        |
| SEC-004  | Security    | SQL injection                           | Low (1)     | High (3)   | 3     | Nice-to-have       |
| DATA-002 | Data        | Concurrent update race conditions       | Low (1)     | Medium (2) | 2     | Nice-to-have       |

---

## Sign-Off

**Test Architect:** Quinn (QA Agent)
**Date:** 2025-10-25
**Recommendation:** This story carries **high risk** (score: 6/100) due to destructive operations and data loss potential. **Five blocking mitigations** must be implemented before production deployment. Once mitigated, risk is acceptable for release.

**Next Steps:**
1. Development team reviews mitigation strategies
2. Implement must-fix mitigations (OPS-001, SEC-001, PERF-001, DATA-001, DATA-003)
3. Execute comprehensive test plan (Priority 1 + 2 tests)
4. Request QA gate review after mitigations complete
